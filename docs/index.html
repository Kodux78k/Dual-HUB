<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
<title>DUAL • Nebula Pro — Hub + Chat + Brain (Monólito v5 — refine-in-bubble + ASCII)</title>
<meta name="theme-color" content="#0b0b14">
<style>
  :root{
    --bg:#0a0b13; --bg-2:#0b0d1a; --fg:#e9ecff; --muted:#9aa4c7; --soft:#c6c9ff33;
    --acc:#a77cff; --acc-2:#5ed0ff; --mag:#ff5bd4; --ok:#5bffcf;
    --card:#0e1224cc; --card-2:#0a0f20b3; --glass:rgba(255,255,255,0.06);
    --ring:rgba(167,124,255,.35); --shadow: 0 10px 40px rgba(8,12,32,.55), inset 0 1px 0 rgba(255,255,255,.04);
    --radius:22px; --border:rgba(255,255,255,.08); --tabsH:72px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,ui-monospace,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";color:var(--fg);
    background: radial-gradient(1200px 900px at 50% -200px, #20163e 0%, #0b0d1a 55%, #070812 100%), #05060c; overflow:auto;}
  .app{position:relative;height:100%;display:flex;flex-direction:column;padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);}
  header.top{padding:14px 18px 8px;display:flex;align-items:center;justify-content:space-between;backdrop-filter:saturate(130%) blur(8px);
    background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0));border-bottom:1px solid #ffffff12;}
  .title{letter-spacing:.18em;font-weight:800;font-size:20px;display:flex;gap:.45ch;align-items:center;}
  .title .dot{width:6px;height:6px;border-radius:50%;background:var(--acc);box-shadow:0 0 18px var(--acc);display:inline-block}
  .hdr-actions{display:flex;gap:10px}
  .icon-btn{width:36px;height:36px;display:grid;place-items:center;border-radius:14px;background:linear-gradient(180deg,#1a1c2c,#0e1122);border:1px solid #ffffff10;box-shadow:var(--shadow);cursor:pointer;position:relative}
  .badge{position:absolute;right:-2px;top:-2px;width:10px;height:10px;background:var(--mag);border-radius:50%;box-shadow:0 0 10px var(--mag)}
  main{flex:1;position:relative}
  section.view{position:absolute;inset:0;padding:18px;padding-bottom:calc(var(--tabsH) + 16px);overflow:auto;display:none;}
  section.view.active{display:block;animation:fade .22s ease-out}
  @keyframes fade{from{opacity:0;transform:translateY(6px)}}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;padding-top:6px}
  .card{background: radial-gradient(120% 120% at 80% 0%, #1c1540aa 0, #0b0e22aa 55%, #0a0d1eaa 100%);
    border:1px solid #ffffff12;box-shadow:var(--shadow);border-radius:var(--radius);padding:18px 16px;min-height:110px;display:flex;flex-direction:column;justify-content:space-between;position:relative;overflow:hidden;isolation:isolate}
  .card:before{content:"";position:absolute;inset:-1px;border-radius:inherit;z-index:-1;background:conic-gradient(from 30deg at 80% 0%,#a77cff33,#5ed0ff22,#ff5bd422,transparent 60%);filter:blur(18px);opacity:.7}
  .card .ico{width:54px;height:54px;border-radius:18px;display:grid;place-items:center;background:linear-gradient(180deg,#1b1f37,#0e1228);border:1px solid #ffffff10;box-shadow:inset 0 1px 0 #ffffff20, 0 6px 18px rgba(0,0,0,.4);overflow:hidden}
  .card h3{margin:12px 0 0;font-size:14px;font-weight:700;letter-spacing:.02em}
  .card p{margin:2px 0 0;font-size:12px;color:var(--muted)}
  .fab-row{display:flex;gap:16px;justify-content:center;margin:18px 0 10px}
  .fab{width:56px;height:56px;border-radius:50%;display:grid;place-items:center;background:radial-gradient(120% 120% at 70% 0%,#261a4f,#0d1126);border:1px solid #ffffff14;box-shadow:var(--shadow)}
  nav.tabs{position:fixed;left:0;right:0;bottom:0;z-index:60;display:flex;justify-content:space-around;align-items:center;height:var(--tabsH);
    padding:10px 14px env(safe-area-inset-bottom);border-top:1px solid #ffffff12;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.04));backdrop-filter:blur(8px);gap:10px}
  .tab-btn{--size:46px;width:var(--size);height:var(--size);border-radius:16px;display:grid;place-items:center;background:linear-gradient(180deg,#12152a,#0d1124);border:1px solid #ffffff12;box-shadow:var(--shadow);opacity:.85}
  .tab-btn.active{opacity:1;outline:1px solid var(--ring)}

  /* === Unified button styles for Nebula (Trinity & chat actions) === */
  .btn, .hbtn, .btn-pill, .btn-ghost {
    appearance:none;
    cursor:pointer;
    user-select:none;
    border:1px solid rgba(255,255,255,.10);
    background:linear-gradient(180deg,#0f1428,#0b1122);
    color:var(--fg);
    font-weight:800;
    letter-spacing:.02em;
    border-radius:12px;
    box-shadow:var(--shadow);
    transition:.18s transform ease, .18s filter ease, .18s opacity ease;
  }
  .btn:active, .hbtn:active, .btn-pill:active, .btn-ghost:active { transform:translateY(1px); }
  /* sizes */
  .btn--sm { padding:.4rem .7rem; font-size:12px; border-radius:10px; }
  .btn--md { padding:.55rem .9rem; font-size:13px; border-radius:12px; }
  .btn--lg { padding:.7rem 1.0rem; font-size:14px; border-radius:14px; }
  /* color variations */
  .btn--prime { background:linear-gradient(90deg,var(--acc), var(--acc-2)); color:#0b0b14; border-color:transparent; }
  .btn--accent { border-color:rgba(255,255,255,.16); }
  .btn--ghost { background:transparent; border-color:rgba(255,255,255,.12); }

  /* CHAT */
  #view-chat .app-frame{ width:100%;width:100%;max-width:1024px;margin:0 auto;position:relative;overflow:hidden;background:radial-gradient(1200px 900px at 50% -40%,rgba(255,255,255,.05),transparent 55%);
    min-height:calc(100dvh - var(--tabsH)); padding:14px 14px calc(14px + var(--tabsH)); border-radius:22px; box-shadow:0 40px 120px rgba(0,0,0,.45)}
  #view-chat .header{height:56px;display:flex;align-items:center;gap:10px;padding:8px 10px;position:sticky;top:0;z-index:50;background:linear-gradient(180deg,rgba(10,10,18,.9),rgba(10,10,18,.60) 70%,transparent);backdrop-filter:saturate(110%) blur(8px);border-radius:16px}
  #view-chat .hbtn{width:34px;height:34px;border-radius:12px;border:1px solid rgba(255,255,255,.06);display:grid;place-items:center;background:linear-gradient(180deg,#1c1d32,#121327);box-shadow:var(--shadow);cursor:pointer;user-select:none}
  #view-chat .title{margin-left:2px;font-weight:700;letter-spacing:2px}
  #view-chat .page{display:flex;flex-direction:column;padding:8px;gap:10px}
  #view-chat .scroll{flex:1;overflow:auto;padding:10px 8px 14px;border-radius:18px;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.00))}
  #view-chat .row{display:flex;gap:8px;margin:8px 8px;position:relative}
  #view-chat .row.ai{justify-content:flex-start}
  #view-chat .row.me{justify-content:flex-end}
  #view-chat .bubble{max-width:92%;padding:12px 14px;border-radius:18px;display:inline-block;position:relative;box-shadow:0 10px 18px rgba(0,0,0,.32);border:1px solid rgba(255,255,255,.05);backdrop-filter:saturate(120%) blur(2px);font-size:16px}
  #view-chat .bubble .pulse{display:none;margin-top:8px;font-size:12px;color:#cfe2ffbb}
  #view-chat .bubble .ascii{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:11.5px;line-height:1.1; white-space:pre; color:#cfe2ff99; opacity:.6; margin-top:6px}
  #view-chat .ai{background:linear-gradient(180deg,rgba(90,60,180,.35),rgba(60,40,120,.35));color:#e6e8ff}
  #view-chat .me{background:linear-gradient(180deg,rgba(41,211,255,.35),rgba(154,124,255,.35));color:#eafcff}
  #view-chat .avatar{width:34px;height:34px;border-radius:12px;background:linear-gradient(180deg,#1b1c30,#101124);border:1px solid rgba(255,255,255,.06);display:grid;place-items:center;flex:0 0 auto;box-shadow:var(--shadow)}
  #view-chat .timestamp{font-size:12px;color:#a3b4c2;margin:2px 12px}
  #view-chat .composer{position:fixed;left:12px;right:12px;bottom:calc(var(--tabsH) + 6px);z-index:55;margin:0 auto;max-width:900px;padding:10px;border-radius:18px;background:linear-gradient(180deg,#14152a,#101424);display:flex;gap:8px;align-items:center;border:1px solid rgba(255,255,255,.06);box-shadow:var(--shadow)}
  #view-chat input[type=text]{flex:1;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px 12px;color:var(--fg);outline:none;transition:.2s;min-width:0;font-size:16px}
  #view-chat .cbtn{width:38px;height:38px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:linear-gradient(180deg,#1c1d32,#121327);display:grid;place-items:center;cursor:pointer;box-shadow:var(--shadow);flex:0 0 auto}
  #view-chat .readout{text-align:center;font-size:12px;color:#cfe9ff99;margin-top:6px;display:flex;align-items:center;gap:6px;justify-content:center;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  #view-chat .readout .ascii{opacity:.65; white-space:pre; font-size:12px; line-height:1.1}
  #view-chat .actions{position:absolute;top:-6px;right:0;display:flex;gap:6px;transform:translateY(-100%)}
  #view-chat .act{font-size:11px;padding:.25rem .5rem;border-radius:10px;background:rgba(20,24,40,.9);border:1px solid rgba(255,255,255,.10);backdrop-filter:blur(8px);cursor:pointer}
  #view-chat .refinebar{display:none;margin-top:8px;gap:8px}
  #view-chat .refinebar .chip{font-size:11px;padding:.25rem .6rem;border-radius:999px;background:#0f1426;border:1px solid rgba(255,255,255,.10);cursor:pointer;color:#cfe2ff}

  /* Menu Sheet */
  .sheet{position:fixed;left:12px;right:12px;bottom:calc(var(--tabsH) + 76px);border-radius:18px;display:none;z-index:59;background:linear-gradient(180deg,rgba(15,16,32,.0),rgba(15,16,32,.88) 30%, rgba(15,16,32,.95));border:1px solid rgba(255,255,255,.08);box-shadow:0 -30px 60px rgba(0,0,0,.6), inset 0 1px 0 rgba(255,255,255,.06);padding:12px}
  .sheet .row{display:flex;gap:10px;margin:6px 0}
  .sheet .btn{flex:1;padding:10px;border-radius:12px;background:linear-gradient(180deg,#0f1428,#0b1122);border:1px solid rgba(255,255,255,.08);text-align:center}
  .sheet .btn:active{transform:translateY(1px)}

  /* BRAIN */
  #view-brain .wrap{max-width:980px;margin:0 auto;padding:6px}
  #view-brain .hbar{display:flex;align-items:center;gap:12px;padding:10px 12px}
  #view-brain .hbar .title{letter-spacing:.12em;font-weight:800;font-size:18px}
  #view-brain .hbar .dot{width:8px;height:8px;background:#29D3FF;border-radius:99px;box-shadow:0 0 16px #29D3FF}
  #view-brain .top-right{margin-left:auto;display:flex;gap:10px}
  #view-brain .round{width:32px;height:32px;border-radius:999px;display:grid;place-items:center;background:#1a1a2a;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,.06)}
  #view-brain .small{width:28px;height:28px}
  #view-brain .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin-top:6px}
  @media (min-width:720px){#view-brain .grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
  #view-brain .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border-radius:20px;padding:14px;box-shadow:var(--shadow);position:relative;overflow:hidden}
  #view-brain .label{font-weight:800;margin-top:2px}
  #view-brain .sublabel{color:var(--muted);font-size:12px;margin-top:2px}
  #view-brain .btn-pill{padding:10px 14px;background:linear-gradient(90deg,#7B61FF,#29D3FF);border:none;color:white;font-weight:800;border-radius:999px;box-shadow:0 8px 24px rgba(60,60,140,.35)}
  #view-brain .input{background:#121223;border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:10px;color:#e9ecff;outline:none}
  #view-brain .hr{height:1px;background:rgba(255,255,255,.06);margin:8px 0 10px}
  #view-brain .code{background:#121223;border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;white-space:pre-wrap;color:#d7e4ff}
  #view-brain .kv{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
  #view-brain .kv .key{font-weight:700}
  #view-brain .panel{position:fixed;right:0;top:0;bottom:0;width:360px;max-width:92vw;background:rgba(15,15,28,.92);backdrop-filter:blur(10px);box-shadow:-8px 0 24px rgba(0,0,0,.5),inset 0 0 0 1px rgba(255,255,255,.06);transform:translateX(105%);transition:transform .28s ease;z-index:70;padding:16px}
  #view-brain .panel.open{transform:translateX(0)}
  #view-brain .status{font-size:12px;color:var(--muted);min-height:18px}
  #view-brain .log{background:#121223;border-radius:12px;padding:10px;margin-top:10px;max-height:180px;overflow:auto;font-size:12px;color:#c7cbe0}
  #mapper{display:grid;grid-template-columns:1fr;gap:8px}
  #mapper .row{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;align-items:center}
  #mapper .row label{font-size:12px;color:var(--muted)}
  #mapper select,#mapper button{height:36px;border-radius:10px;border:1px solid #ffffff18;background:#0f1326;color:#e9ecff}

  @media (max-width:480px){
    #view-chat .app-frame{ width:100%;border-radius:0; box-shadow:none; padding-left:8px; padding-right:8px; max-width:100%}
    #view-chat .composer{left:8px; right:8px; max-width:100%}
  }

/* === Themes: NebulaPro (default), Luxara, Ignyra, Elysha === */
:root{ --theme-name: 'NebulaPro'; }
body.theme-nebula { --bg:#0a0b13; --bg-2:#0b0d1a; --fg:#e9ecff; --muted:#9aa4c7; --acc:#a77cff; --acc-2:#5ed0ff; --mag:#ff5bd4; --ok:#5bffcf; }
body.theme-luxara{ --bg:#0a0812; --bg-2:#140a22; --fg:#f7ecff; --muted:#d1b9ff; --acc:#ff7af2; --acc-2:#ffe069; --mag:#ff5bd4; --ok:#6cffb8; --theme-name:'Luxara'; }
body.theme-ignyra{ --bg:#0b0a10; --bg-2:#140b14; --fg:#eef8ff; --muted:#a7c7ff; --acc:#ff375f; --acc-2:#29d3ff; --mag:#ff2b95; --ok:#6cffb8; --theme-name:'Ignyra'; }
body.theme-elysha{ --bg:#081014; --bg-2:#0b1822; --fg:#e9feff; --muted:#a6e0ff; --acc:#29d3ff; --acc-2:#8a5cff; --mag:#36ffe0; --ok:#a8ff6c; --theme-name:'Elysha'; }

/* subtle theme glow for header title dot */
body.theme-luxara .title .dot{ background:#ff7af2; box-shadow:0 0 18px #ff7af2;}
body.theme-ignyra .title .dot{ background:#ff375f; box-shadow:0 0 18px #ff375f;}
body.theme-elysha .title .dot{ background:#29d3ff; box-shadow:0 0 18px #29d3ff;}


#view-chat .scroll{scroll-behavior:smooth;-webkit-overflow-scrolling:touch;}
@media (max-width:480px){#view-chat .bubble{max-width:96%;}}

/* === UNIFIED APPS glue (ported) === */
#view-apps .app-frame{width:100%;max-width:1180px;margin:0 auto;position:relative;overflow:hidden;
  background:radial-gradient(1200px 900px at 50% -40%,rgba(255,255,255,.05),transparent 55%);
  min-height:calc(100dvh - var(--tabsH)); padding:14px 14px calc(14px + var(--tabsH));
  border-radius:22px; box-shadow:0 40px 120px rgba(0,0,0,.45)}
#view-apps .header{height:56px;display:flex;align-items:center;gap:10px;padding:8px 10px;position:sticky;top:0;z-index:50;background:linear-gradient(180deg,rgba(10,10,18,.9),rgba(10,10,18,.60) 70%,transparent);backdrop-filter:saturate(110%) blur(8px);border-radius:16px}
#view-apps .title{margin-left:2px;font-weight:700;letter-spacing:2px}
#view-apps .section{margin:10px 2px 6px;color:#cfe9ffbd;font-weight:800;letter-spacing:.08em;font-size:12px}
#view-apps .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
@media (min-width:720px){#view-apps .grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
@media (min-width:1080px){#view-apps .grid{grid-template-columns:repeat(4,minmax(0,1fr))}}
#view-apps .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border-radius:16px;padding:12px;border:1px solid rgba(255,255,255,.08);display:flex;gap:12px;align-items:center;box-shadow:var(--shadow)}
#view-apps .icon{width:48px;height:48px;border-radius:12px;display:grid;place-items:center;overflow:hidden;background:#0f1320;border:1px solid rgba(255,255,255,.10)}
#view-apps .title-txt{font-weight:800;margin:0 0 4px}
#view-apps .muted{color:var(--muted);font-size:.86rem}
#view-apps .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
#view-apps .btn{appearance:none;border:1px solid rgba(255,255,255,.10);border-radius:10px;padding:.5rem .8rem;background:#0f1326;color:#e9ecff;font-weight:800;font-size:12px;cursor:pointer}
#view-apps .btn.star.active{background:rgba(231,198,90,.18);border-color:rgba(231,198,90,.5);color:#ffd86a}
.viewer{position:fixed;inset:0;z-index:200;background:#000}
.viewer iframe{position:absolute;inset:0;border:0;width:100%;height:100%}

/* Viewer that respects tabs in Apps: mount inside apps and leave nav visible */
#view-apps .viewer.keep-tabs {
  position:absolute;
  inset:8px 8px calc(var(--tabsH) + 10px) 8px;
  z-index:40;
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  background:rgba(0,0,0,.85);
  backdrop-filter:blur(8px) saturate(130%);
  box-shadow:0 20px 60px rgba(0,0,0,.55);
}
#view-apps .viewer.keep-tabs .viewer-footer {
  position:absolute;
  right:12px;
  bottom:12px;
  display:flex;
  gap:8px;
}

  /* ==== Chat bubble actions (harmonized) === */
  #view-chat .bubble{
    contain: layout paint;
    min-height:52px;
  }
  #view-chat .bubble .actions{
    position: static;
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin-top:8px;
    padding-top:6px;
    border-top:1px dashed rgba(255,255,255,.08);
  }

  /* Buttons inside chat bubbles adopt unified style */
  #view-chat .bubble .actions .btn{
    appearance:none;
    border:1px solid rgba(255,255,255,.10);
    background:linear-gradient(180deg,#0f1428,#0b1122);
    color:var(--fg);
    font-weight:800;
    border-radius:10px;
    padding:.42rem .66rem;
    font-size:12px;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
  }
  #view-chat .bubble .actions .btn i{
    display:inline-grid;
    place-items:center;
    width:16px;
    height:16px;
    margin-right:.35rem;
  }

  /* === Perfil input container e DevDocs === */
  /* wrapper estilizado para inputs de SK e Treinamento */
  .input-wrap{
    background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 14px;
    padding: 8px;
    display: grid;
    gap: 8px;
    box-shadow: var(--shadow);
  }
  .input-wrap .row{ display:flex; gap:8px; align-items:center; }
  .input-wrap .label{ font-size:11px; color:var(--muted); letter-spacing:.04em; }
  .input-wrap .hint{ font-size:11px; color:#a6b8ff99; }
  .input-wrap .input, .input-wrap textarea{
    background:#0f1326;
    border:1px solid rgba(255,255,255,.08);
    border-radius:10px;
    color:var(--fg);
    padding:10px 12px;
    outline:none;
  }
  /* botão com borda tracejada para upload */
  .btn-ghost-clip{ background:transparent; border:1px dashed rgba(255,255,255,.16); }

  /* Painel Dev Docs para avatar */
  .devdocs-panel{
    position:fixed;
    inset:auto 12px 90px 12px;
    z-index:80;
    background:linear-gradient(180deg,rgba(15,16,32,.96),rgba(15,16,32,.92));
    border:1px solid rgba(255,255,255,.10);
    border-radius:16px;
    padding:12px;
    box-shadow:0 18px 60px rgba(0,0,0,.5);
    max-width:820px;
    margin:0 auto;
  }
  .devdocs-panel h4{ margin:4px 0 10px; font-size:13px; letter-spacing:.06em; }
  .devdocs-panel .grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .devdocs-panel .mini{ background:#121223; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,.08); font-size:12px; max-height:220px; overflow:auto; }
  .devdocs-panel .row{ display:flex; gap:8px; }
</style>
</head>
<body>
<div class="app">
  <header class="top">
    <div class="title">DUAL <span class="dot"></span> NEBULA</div>
    <div class="hdr-actions">
      <div class="icon-btn" id="btnIntegrator" title="Integrador" aria-label="Integrador">
        <span class="badge"></span>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M5 12a7 7 0 0 1 14 0" stroke="#a77cff" stroke-width="1.6" stroke-linecap="round"/>
          <circle cx="12" cy="12" r="3.2" stroke="#5ed0ff" stroke-width="1.6"/>
        </svg>
      </div>
      <div class="icon-btn" id="btnMenu" title="Opções" aria-label="Opções">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <circle cx="5" cy="12" r="2" fill="#cfd6ff"/>
          <circle cx="12" cy="12" r="2" fill="#cfd6ff"/>
          <circle cx="19" cy="12" r="2" fill="#cfd6ff"/>
        </svg>
      </div>
    </div>
  </header>

  <main>
    <!-- HOME / HUB -->
    <section class="view active" id="view-home">
      <div class="grid">
        <button class="card" data-open="lan" data-icon="lan"><div class="ico"><svg width="26" height="26" viewBox="0 0 24 24" fill="none"><path d="M6 7h12v5H6zM10 12v5M14 12v5M8 17h8" stroke="#5ed0ff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></div><div><h3>LAN Scanner</h3><p>Descobrir dispositivos</p></div></button>
        <button class="card" data-open="bind" data-icon="bind"><div class="ico"><svg width="26" height="26" viewBox="0 0 24 24" fill="none"><path d="M7 7l10 10M7 17L17 7" stroke="#a77cff" stroke-width="1.7" stroke-linecap="round"/><circle cx="7" cy="7" r="3" stroke="#ff5bd4" stroke-width="1.4"/><circle cx="17" cy="17" r="3" stroke="#5ed0ff" stroke-width="1.4"/></svg></div><div><h3>Bind</h3><p>Conectar & parear</p></div></button>
        <button class="card" data-open="report" data-icon="report"><div class="ico"><svg width="26" height="26" viewBox="0 0 24 24" fill="none"><path d="M6 17v-9l6-3 6 3v9l-6 3-6-3z" stroke="#a77cff" stroke-width="1.6" stroke-linejoin="round"/><path d="M9 12h6M9 15h4" stroke="#cfd6ff" stroke-width="1.6" stroke-linecap="round"/></svg></div><div><h3>Relatório</h3><p>Métricas e logs</p></div></button>
        <button class="card" data-open="memory" data-icon="memory"><div class="ico"><svg width="26" height="26" viewBox="0 0 24 24" fill="none"><rect x="4" y="5" width="16" height="14" rx="3" stroke="#5ed0ff" stroke-width="1.6"/><path d="M8 9h8M8 13h6" stroke="#cfd6ff" stroke-width="1.6" stroke-linecap="round"/></svg></div><div><h3>Memória</h3><p>Docs & sessões</p></div></button>
        <button class="card" data-nav="apps" data-icon="apps"><div class="ico"><svg width="26" height="26" viewBox="0 0 24 24" fill="none"><rect x="4" y="4" width="6" height="6" rx="2" stroke="#5ed0ff" stroke-width="1.6"/><rect x="14" y="4" width="6" height="6" rx="2" stroke="#a77cff" stroke-width="1.6"/><rect x="4" y="14" width="6" height="6" rx="2" stroke="#ff5bd4" stroke-width="1.6"/><rect x="14" y="14" width="6" height="6" rx="2" stroke="#cfd6ff" stroke-width="1.6"/></svg></div><div><h3>Apps</h3><p>Atalhos</p></div></button>
        <button class="card" data-nav="profile" data-icon="user"><div class="ico"><svg width="26" height="26" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="8" r="3.2" stroke="#cfd6ff" stroke-width="1.6"/><path d="M5 19c1.5-3.2 4.3-5 7-5s5.5 1.8 7 5" stroke="#5ed0ff" stroke-width="1.6" stroke-linecap="round"/></svg></div><div><h3>Usuário</h3><p>Preferências</p></div></button>
      </div>
    </section>

    <!-- CHAT -->
    <section class="view" id="view-chat">
      <div class="app-frame">
        <div class="header">
          <div class="hbtn" id="chat-btnMore" title="Ações rápidas" aria-label="Ações rápidas">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="5" cy="12" r="2" fill="#cfe9ff"/><circle cx="12" cy="12" r="2" fill="#cfe9ff"/><circle cx="19" cy="12" r="2" fill="#cfe9ff"/></svg>
          </div>
          <div class="title">DUAL <span>• CHAT</span></div>
          <div style="flex:1"></div>
          <div class="hbtn" id="chat-btnTTS" title="TTS: ligado" aria-label="TTS">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 10v4a1 1 0 001 1h3l5 4V5l-5 4H4a1 1 0 00-1 1z" stroke="#cfe9ff" stroke-width="2"/></svg>
          </div>
          <div class="hbtn" id="chat-btnExport" title="Exportar chat" aria-label="Exportar">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12l7-7 7 7" stroke="#cfe9ff" stroke-width="2" stroke-linecap="round"/></svg>
          </div>
        </div>

        <div class="page">
          <div class="scroll" id="chat-list"></div>
          <div class="readout" id="chat-status">
<pre class="ascii" id="status-ascii">╭────────── pulso em expansão ──────────╮
│ ▁ ▂ ▃ ▄ ▅ ▆ ▇ █ ▇ ▆ ▅ ▄ ▃ ▂ ▁        │
╰───────────────────────────────────────╯</pre>
          </div>
        </div>

        <div class="composer">
          <button class="cbtn" id="chat-btnMic" title="Ditado" aria-label="Ditado">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><rect x="9" y="3" width="6" height="10" rx="3" stroke="#cfe9ff" stroke-width="2"/><path d="M12 19v2M7 12v1a5 5 0 0010 0v-1" stroke="#cfe9ff" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
          <input id="chat-input" type="text" inputmode="text" placeholder="Digite uma mensagem…" autocomplete="off"/>
          <button class="cbtn" id="chat-btnAttach" title="Anexo" aria-label="Anexo">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 11.5V17a5 5 0 01-10 0V8a3 3 0 116 0v7a1 1 0 11-2 0V9" stroke="#cfe9ff" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
          <button class="cbtn" id="chat-btnSend" title="Enviar" aria-label="Enviar">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M22 2L11 13" stroke="#cfe9ff" stroke-width="2" stroke-linecap="round"/><path d="M22 2l-7 20-4-9-9-4 20-7z" stroke="#cfe9ff" stroke-width="2" stroke-linejoin="round"/></svg>
          </button>
        </div>

        <!-- Sheets -->
        <div class="sheet" id="chat-sheet">
          <div style="text-align:center;opacity:.8">Ações rápidas</div>
          <div class="row"><div class="btn" data-action="lan">LAN</div><div class="btn" data-action="bind">Bind</div></div>
          <div class="row"><div class="btn" data-action="report">Relatório</div><div class="btn" data-action="memory">Memória</div></div>
          <div class="row"><div class="btn" data-action="clear">Limpar</div><div class="btn" data-action="import">Importar</div></div>
        </div>

        <div class="sheet" id="menu-sheet">
          <div style="text-align:center;opacity:.8">Opções</div>
          <div class="row"><div class="btn" data-nav="home">Início</div><div class="btn" data-nav="brain">Brain</div></div>
<div class="row"><div class="btn" data-theme="nebula">NebulaPro</div><div class="btn" data-theme="luxara">Luxara</div><div class="btn" data-theme="ignyra">Ignyra</div><div class="btn" data-theme="elysha">Elysha</div></div>
          <div class="row"><div class="btn" data-nav="apps">Apps</div><div class="btn" data-nav="profile">Perfil</div></div>
          <div class="row"><div class="btn" id="close-menu">Fechar</div></div>
        </div>
      </div>
    </section>

    <!-- BRAIN -->
    <section class="view" id="view-brain">
      <div class="wrap">
        <div class='hbar'>
          <div class='title'>AETHER <span class='dot'></span> BRAIN</div>
          <div class='top-right'><button class='round small' id="brain-open-integrator" title='Integrador'>◇</button></div>
        </div>

        <div class="grid">
          <div class="card" style="grid-column:1/-1">
            <div class="label">Infodose Brain • Local</div>
            <div class="sublabel">Chave prefixo: <code>dual.brain.*</code></div>
            <div class="hr"></div>
            <div class="grid" style="grid-template-columns:1fr 1fr;gap:10px">
              <input id="brain-k" class="input" placeholder="chave (ex.: prompt)">
              <button class="btn-pill" id="brain-save">Salvar</button>
              <textarea id="brain-v" class="code" style="grid-column:1/-1;min-height:120px" placeholder="valor..."></textarea>
              <div style="display:flex;gap:8px">
                <button class="btn-pill" id="brain-del" style="background:linear-gradient(90deg,#ff5a99,#7b61ff)">Excluir</button>
                <button class="btn-pill" id="brain-copy">Copiar tudo</button>
                <button class="btn-pill" id="brain-export">Exportar .json</button>
                <input type="file" id="brain-importFile" hidden accept=".json,application/json">
                <button class="btn-pill" id="brain-importBtn" style="background:linear-gradient(90deg,#29D3FF,#6CFFB8)">Importar</button>
              </div>
            </div>
          </div>

          <div class="card" style="grid-column:1/-1">
            <div class="label">Vozes por Arquétipo</div>
            <div class="sublabel">Mapeie as vozes (salva em <code>dual.brain.voice.*</code>)</div>
            <div class="hr"></div>
            <div id="mapper"></div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="btn-pill" id="refreshVoices">Atualizar vozes</button>
              <button class="btn-pill" id="resetVoices" style="background:linear-gradient(90deg,#ff7a7a,#b86bff)">Reset</button>
            </div>
          </div>

          <div class="card" style="grid-column:1/-1">
            <div class="label">Seeds Rápidos</div>
            <div class="sublabel">Clique para carregar no editor acima</div>
            <div class="hr"></div>
            <div class="grid" style="grid-template-columns:repeat(3,1fr)">
              <button class="btn-pill" data-seed="system">System Prompt</button>
              <button class="btn-pill" data-seed="style">Estilo Nebula</button>
              <button class="btn-pill" data-seed="ritual">Ritual 3•6•9</button>
            </div>
          </div>
        </div>
        <!-- OpenRouter & Treinamento (Brain) -->
        <div class="card" style="grid-column:1/-1">
          <div class="label">OpenRouter &amp; Treinamento</div>
          <div class="hr"></div>
          <div style="display:grid;gap:8px">
            <div style="display:flex;gap:8px">
              <input id="brain-sk" class="input" placeholder="sk-or-v1-..." style="flex:1">
              <button id="brain-saveSK" class="btn-pill">Salvar</button>
            </div>
            <textarea id="brain-training" class="input" rows="4" placeholder="Cole seu treinamento..."></textarea>
            <div style="display:flex;gap:8px;justify-content:flex-end">
              <button id="brain-saveTraining" class="btn-pill">Salvar Treinamento</button>
            </div>
          </div>
        </div>
      </div>

      <div class="panel" id="brain-panel">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <div class="label" style="font-weight:800">Integrador</div>
          <button class="round small" id="brain-close">✕</button>
        </div>
        <div class="sublabel">Backend salvo no dispositivo (DualStore)</div>
        <div class="hr"></div>
        <div class="grid" style="grid-template-columns:1fr;gap:10px">
          <input id="brain-be" class="input" placeholder="http://192.168.0.x:xxxx">
          <div style="display:flex;gap:8px">
            <button class="btn-pill" id="brain-saveBE">Salvar</button>
            <button class="btn-pill" id="brain-test">Test</button>
            <button class="btn-pill" id="brain-ping" style="background:linear-gradient(90deg,#29D3FF,#FF5AD9)">Ping</button>
            <button class="btn-pill" id="brain-health" style="background:linear-gradient(90deg,#6CFFB8,#29D3FF)">Health</button>
          </div>
          <div class="status" id="brain-status">—</div>
          <div class="log" id="brain-log"></div>
        </div>
      </div>
    </section>

    <!-- APPS / PROFILE iguais à v4 -->
    
<section class="view" id="view-apps">
  <div class="app-frame">
    <div class="header"><div class="title">DUAL <span>• APPS</span></div></div>
    <div class="page" style="display:grid; gap:12px">
      <!-- Toolbar -->
      <div class="card" style="display:grid; gap:8px">
        <div class="row" style="display:flex; gap:8px; align-items:center">
          <input id="search" class="input" placeholder="Buscar apps..." style="flex:1">
          <select id="sort" class="input" style="width:160px">
            <option value="az">A–Z</option>
            <option value="za">Z–A</option>
          </select>
          <label style="display:flex; align-items:center; gap:6px; font-size:12px; color:var(--muted)">
            <input id="sameTab" type="checkbox" checked> abrir dentro do hub
          </label>
        </div>
        <div id="countApps" class="sublabel">—</div>
      </div>
      <!-- Conteúdo agrupado -->
      <div id="content"></div>
      <!-- Memória de páginas abertas (rail) -->
      <div id="memRail" class="card" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center">
        <button id="memToggle" class="btn btn--sm btn--ghost">Memória</button>
        <button id="memClear"  class="btn btn--sm btn--ghost">Limpar</button>
      </div>
    </div>
  </div>
</section>

    <section class="view" id="view-profile">
      <div style="display:flex;flex-direction:column;gap:14px;padding-top:4px;">
        <div id="profile-avatar" style="width:84px;height:84px;border-radius:50%;display:grid;place-items:center;margin:4px auto 8px;background:radial-gradient(120% 120% at 70% 0%,#231a52,#0d122a);border:1px solid #ffffff18;box-shadow:var(--shadow); cursor:pointer" title="Clique para alterar foto ou abrir Dev Docs">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="8" r="3.2" stroke="#cfd6ff" stroke-width="1.6"/><path d="M5 19c1.5-3.2 4.3-5 7-5s5.5 1.8 7 5" stroke="#5ed0ff" stroke-width="1.6" stroke-linecap="round"/></svg>
        </div>
        <div id="profile-avatar-menu" class="card" style="display:none;max-width:280px;margin:0 auto; text-align:center">
          <div class="label">Avatar & Dev</div>
          <div class="hr"></div>
          <div style="display:flex;gap:8px;justify-content:center">
            <input id="profile-avatar-file" type="file" accept="image/*" hidden>
            <button id="btn-change-photo" class="btn btn--md btn--accent">Alterar foto</button>
            <button id="btn-devdocs" class="btn btn--md btn--ghost">Dev Docs</button>
          </div>
        </div>
        <div class="card">
          <div style="font-size:11px;color:var(--muted)">Nome</div>
          <div style="display:flex;gap:8px;margin-top:4px">
            <input id="profile-name" class="input" placeholder="Seu nome" style="flex:1">
            <button id="profile-saveName" class="btn btn--md btn--prime">Salvar</button>
          </div>
        </div>
        <div class="card"><div style="font-size:11px;color:var(--muted)">Assinatura</div>
          <select style="width:100%;background:transparent;border:0;outline:0;color:var(--fg);font-size:14px;padding:6px 0 2px;">
            <option>Trinity</option><option>Uno</option><option>Dual</option>
          </select>
          <div class="sublabel" style="font-size:11px;color:var(--muted);margin-top:6px">
            UNO: mostra um módulo por vez. DUAL: Chat e Brain simultâneos. TRINITY: experiência integrada completa.
          </div>
        </div>
        <!-- SK e Treinamento no Perfil -->
        <div class="card">
          <div class="label">OpenRouter & Treinamento</div>
          <div class="hr"></div>

          <!-- SK -->
          <div class="input-wrap">
            <div class="label">Chave OpenRouter</div>
            <div class="row">
              <input id="profile-sk" class="input" placeholder="sk-or-v1-..." style="flex:1">
              <button id="profile-pasteSK" class="btn btn--md btn--ghost" title="Colar da área de transferência">📋 Colar</button>
              <button id="profile-saveSK"  class="btn btn--md btn--prime">Salvar</button>
            </div>
            <div class="hint">Guardado em <code>infodose:brain.userSK</code> e <code>infodose:userSK</code></div>
          </div>

          <!-- Treinamento -->
          <div class="input-wrap">
            <div class="label">Treinamento</div>
            <textarea id="profile-training" class="input" rows="5" placeholder="Cole seu treinamento..."></textarea>
            <div class="row">
              <input id="profile-training-file" type="file" accept=".txt,.json" hidden>
              <button id="profile-uploadTraining" class="btn btn--md btn--ghost btn-ghost-clip">⤒ Upload TXT/JSON</button>
              <div style="flex:1"></div>
              <button id="profile-saveTraining" class="btn btn--md btn--accent">Salvar Treinamento</button>
            </div>
            <div class="hint">Aceita .txt direto ou .json com <code>{"training":"..."}</code> ou um array de strings.</div>
          </div>
        </div>
      </div>
    </section>
    <!-- Trinity view: dedicado à fusão UNO/DUAL/TRINITY -->
    <section class="view" id="view-trinity">
      <div class="app-frame">
        <div class="header">
          <div class="title">DUAL <span>• TRINITY</span></div>
          <div style="flex:1"></div>
          <button class="hbtn btn btn--sm btn--ghost" id="trinity-btnOpenHubs" title="Abrir Hub de Arquétipos">◐</button>
        </div>
        <div class="page" style="padding:8px">
          <div class="section">Fusão Trinity</div>
          <div class="grid">
            <div class="card">
              <div class="ico">🧿</div>
              <div>
                <h3>Dual‑App acoplado</h3>
                <p>Execução simbiótica dentro do Monólito</p>
                <div class="row">
                  <button class="btn btn--md btn--prime" id="trinity-open-dual"><span>◎</span>Abrir</button>
                  <button class="btn btn--md btn--accent" id="trinity-ping-dual"><span>▶</span>Ping</button>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="ico">◎</div>
              <div>
                <h3>Arquétipos & Manifestos</h3>
                <p>Hubs, temas, vozes e PWA por arquétipo</p>
                <div class="row">
                  <button class="btn btn--md btn--prime" id="trinity-open-hubs"><span>◐</span>Abrir Hubs</button>
                  <button class="btn btn--md btn--accent" id="trinity-sync-theme"><span>↻</span>Sync Tema/TTS</button>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="ico">🔘</div>
              <div>
                <h3>Dual Finder</h3>
                <p>Cérebro local & memória</p>
                <div class="row">
                  <button class="btn btn--md btn--prime" id="trinity-open-finder"><span>⌕</span>Abrir</button>
                </div>
              </div>
            </div>
          </div>
          <div class="viewer" id="trinity-viewer" style="display:none">
            <iframe id="trinity-frame" allow="autoplay; clipboard-read; clipboard-write"></iframe>
            <div class="viewer-footer"><button class="btn" id="trinity-back">⬅ Voltar</button></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <nav class="tabs">
    <button class="tab-btn active" data-nav="home" title="Início" aria-label="Início">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 3l8 6v10a2 2 0 0 1-2 2h-4v-6H10v6H6a2 2 0 0 1-2-2V9z" stroke="#a77cff" stroke-width="1.6" stroke-linejoin="round"/></svg>
    </button>
    <button class="tab-btn" data-nav="chat" title="Chat" aria-label="Chat">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M4 5h16v9H7l-3 3z" stroke="#5ed0ff" stroke-width="1.6" stroke-linejoin="round"/></svg>
    </button>
    <button class="tab-btn" data-nav="brain" title="Brain" aria-label="Brain">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><rect x="4" y="5" width="16" height="14" rx="3" stroke="#5ed0ff" stroke-width="1.6"/><path d="M8 9h8M8 13h6" stroke="#cfd6ff" stroke-width="1.6" stroke-linecap="round"/></svg>
    </button>
    <button class="tab-btn" data-nav="apps" title="Apps" aria-label="Apps">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
        <rect x="4" y="4" width="6" height="6" rx="2" stroke="#5ed0ff" stroke-width="1.6"/>
        <rect x="14" y="4" width="6" height="6" rx="2" stroke="#a77cff" stroke-width="1.6"/>
        <rect x="4" y="14" width="6" height="6" rx="2" stroke="#ff5bd4" stroke-width="1.6"/>
        <rect x="14" y="14" width="6" height="6" rx="2" stroke="#cfd6ff" stroke-width="1.6"/>
      </svg>
    </button>
    <button class="tab-btn" data-nav="profile" title="Perfil" aria-label="Perfil">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="8" r="3.2" stroke="#cfd6ff" stroke-width="1.6"/><path d="M5 19c1.5-3.2 4.3-5 7-5s5.5 1.8 7 5" stroke="#5ed0ff" stroke-width="1.6" stroke-linecap="round"/></svg>
    </button>

    <!-- Nova aba Trinity: integra o Dual‑App e Hubs de arquétipos -->
    <button class="tab-btn" data-nav="trinity" title="Trinity" aria-label="Trinity">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
        <circle cx="12" cy="12" r="9" stroke="#a77cff" stroke-width="1.6"/>
        <circle cx="12" cy="12" r="3.2" stroke="#5ed0ff" stroke-width="1.6"/>
      </svg>
    </button>
  </nav>
</div>

<script>
/* ===== Helpers & Router ===== */
function $(s,root=document){return root.querySelector(s)}
// Inclui a view Trinity no roteamento
const views = {home:$('#view-home'), chat:$('#view-chat'), brain:$('#view-brain'), apps:$('#view-apps'), profile:$('#view-profile'), trinity:$('#view-trinity')};
function navTo(key){ for(const v in views) views[v].classList.remove('active'); (views[key]||views.home).classList.add('active');
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.toggle('active', b.dataset.nav===key)); history.replaceState({}, "", "#/"+key); }
const h = location.hash.replace("#/",""); if(views[h]) navTo(h);
document.querySelectorAll('[data-nav]').forEach(btn=>btn.addEventListener('click', ()=> navTo(btn.dataset.nav)));
document.querySelectorAll('[data-open]').forEach(btn=>btn.addEventListener('click', ()=>{ const name=btn.dataset.open; navTo('chat'); setTimeout(()=>{ chatBubble('Abrir '+name+'…','me'); setTimeout(()=> chatBubble('Módulo '+name.toUpperCase()+' pronto. (exemplo)','ai'), 360); }, 150); }));

/* ===== Hub Icon Fallback Loader ===== */
(async function loadHubIcons(){
  const cards = document.querySelectorAll('[data-icon] .ico');
  for(const ico of cards){
    const key = ico.parentElement.dataset.icon;
    try{ const res = await fetch(`./icons/${key}.svg`, {method:'GET'}); if(res.ok){ const svg=await res.text(); ico.innerHTML=svg; } }catch(e){}
  }
})();

/* ===== Menu btn ===== */
function setTheme(name){
  const map={nebula:'theme-nebula', luxara:'theme-luxara', ignyra:'theme-ignyra', elysha:'theme-elysha'};
  const cls = map[name]||'theme-nebula';
  document.body.classList.remove('theme-nebula','theme-luxara','theme-ignyra','theme-elysha');
  document.body.classList.add(cls);
  try{ localStorage.setItem('dual.theme', cls); }catch(_){}
}
setTheme((localStorage.getItem('dual.theme')||'theme-nebula').replace('theme-',''));
const menuBtn = document.getElementById('btnMenu');
const menuSheet = document.getElementById('menu-sheet');
menuBtn.addEventListener('click', ()=>{ menuSheet.style.display = (menuSheet.style.display==='block'?'none':'block'); });
document.getElementById('close-menu').addEventListener('click', ()=> menuSheet.style.display='none');
menuSheet.addEventListener('click', (e)=>{
  const tbtn=e.target.closest('[data-theme]'); if(tbtn){ setTheme(tbtn.dataset.theme); menuSheet.style.display='none'; return; }
  const btn=e.target.closest('[data-nav]'); if(!btn) return; navTo(btn.dataset.nav); menuSheet.style.display='none';
});

/* ===== ASCII status animation ===== */
(function(){
  const el = document.getElementById('status-ascii');
  const frames = [
`╭────────── pulso em expansão ──────────╮
│ ▁ ▂ ▃ ▄ ▅ ▆ ▇ █ ▇ ▆ ▅ ▄ ▃ ▂ ▁        │
╰───────────────────────────────────────╯`,
`╭────────── pulso em expansão ──────────╮
│   ▁ ▂ ▃ ▄ ▅ ▆ ▇ █ ▇ ▆ ▅ ▄ ▃ ▂ ▁      │
╰───────────────────────────────────────╯`,
`╭────────── pulso em expansão ──────────╮
│     ▁ ▂ ▃ ▄ ▅ ▆ ▇ █ ▇ ▆ ▅ ▄ ▃ ▂ ▁    │
╰───────────────────────────────────────╯`,
`╭────────── pulso em expansão ──────────╮
│       ▁ ▂ ▃ ▄ ▅ ▆ ▇ █ ▇ ▆ ▅ ▄ ▃ ▂ ▁  │
╰───────────────────────────────────────╯`,
`╭────────── pulso em expansão ──────────╮
│     ▁ ▂ ▃ ▄ ▅ ▆ ▇ █ ▇ ▆ ▅ ▄ ▃ ▂ ▁    │
╰───────────────────────────────────────╯`,
`╭────────── pulso em expansão ──────────╮
│   ▁ ▂ ▃ ▄ ▅ ▆ ▇ █ ▇ ▆ ▅ ▄ ▃ ▂ ▁      │
╰───────────────────────────────────────╯`
  ];
  let i=0; setInterval(()=>{ el.textContent = frames[i=(i+1)%frames.length]; }, 900);
})();

/* ===== Chat with refine-in-bubble + ASCII art ===== */
(function(){
  const list = $("#chat-list"), input=$("#chat-input"), status=$("#chat-status");
  const btnSend=$("#chat-btnSend"), btnMic=$("#chat-btnMic"), btnMore=$("#chat-btnMore");
  // Reactions: ASCII stickers/emojis
  const ASCII_STICKERS = [
    {label:"(╯°□°）╯︵ ┻━┻", text:"(╯°□°）╯︵ ┻━┻"},
    {label:"┬─┬ ノ(゜-゜ノ)", text:"┬─┬ ノ(゜-゜ノ)"},
    {label:"¯\\_(ツ)_/¯", text:"¯\\_(ツ)_/¯"},
    {label:"( ͡° ͜ʖ ͡°)", text:"( ͡° ͜ʖ ͡°)"},
    {label:"(•‿•)", text:"(•‿•)"},
    {label:"♥", text:"  ** **\\n ******\\n ******\\n  ****\\n   **"},
    {label:"✨", text:"    *\\n   ***\\n  *****\\n   ***\\n    *"},
    {label:"~ onda ~", text:"~      ~      ~"},
    {label:"▶ loading", text:"[====      ]"},
    {label:"▲", text:"  /\\\\\\n /  \\\\\\n/____\\\\"},
    {label:"○", text:"  ***\\n *   *\\n *   *\\n *   *\\n  ***"},
    {label:"☐", text:"#####\\n#   #\\n#   #\\n#   #\\n#####"},
  ];

  // Create reactions button & sheet if not present
  const composer = document.querySelector('#view-chat .composer');
  const btnAttach = $("#chat-btnAttach");
  let btnRe = document.getElementById('chat-btnReactions');
  if(!btnRe){
    btnRe = document.createElement('button');
    btnRe.className = 'cbtn';
    btnRe.id = 'chat-btnReactions';
    btnRe.title = 'Reações ASCII';
    btnRe.setAttribute('aria-label','Reações ASCII');
    btnRe.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none">
      <circle cx="8" cy="10" r="2" stroke="#cfe9ff" stroke-width="2"/>
      <circle cx="16" cy="10" r="2" stroke="#cfe9ff" stroke-width="2"/>
      <path d="M7 16c2 2 8 2 10 0" stroke="#cfe9ff" stroke-width="2" stroke-linecap="round"/>
    </svg>`;
    // insert before attach
    composer.insertBefore(btnRe, btnAttach);
  }

  let reactSheet = document.getElementById('reactions-sheet');
  if(!reactSheet){
    reactSheet = document.createElement('div');
    reactSheet.className = 'sheet';
    reactSheet.id = 'reactions-sheet';
    reactSheet.innerHTML = `<div style="text-align:center;opacity:.8">Reações ASCII</div>
    <div class="row" id="reactions-grid" style="flex-wrap:wrap; gap:8px"></div>
    <div class="row"><div class="btn" id="reactions-close">Fechar</div></div>`;
    document.querySelector('#view-chat .app-frame').appendChild(reactSheet);
  }
  const grid = reactSheet.querySelector('#reactions-grid'); grid.innerHTML='';
  ASCII_STICKERS.forEach(s=>{
    const b=document.createElement('div'); b.className='btn';
    b.style.minWidth='fit-content'; b.style.padding='8px 10px'; b.style.fontFamily='ui-monospace, SFMono-Regular, Menlo, Consolas, monospace';
    b.textContent=s.label;
    b.title = s.text.replace(/\\n/g,' ');
    b.addEventListener('click', ()=>{
      // insert at cursor
      const el = input;
      const ins = (s.text.includes('\\n') ? '\\n'+s.text+'\\n' : s.text);
      try{
        const st = el.selectionStart||el.value.length, en = el.selectionEnd||el.value.length;
        el.value = el.value.slice(0,st) + ins + el.value.slice(en);
        el.focus();
        el.selectionStart = el.selectionEnd = st + ins.length;
      }catch(_){
        el.value = (el.value + ' ' + ins).trim();
      }
      reactSheet.style.display='none';
    });
    grid.appendChild(b);
  });

  btnRe.addEventListener('click', ()=>{
    reactSheet.style.display = (reactSheet.style.display==='block'?'none':'block');
  });
  document.getElementById('reactions-close').addEventListener('click', ()=> reactSheet.style.display='none');

  const btnTTS=$("#chat-btnTTS"), btnExport=$("#chat-btnExport"), sheet=$("#chat-sheet");
  const STORAGE_KEY="dual.chat.history";
  let TTS_ON=true, msgCounter=0;

  const ARCHS = ["Atlas","Nova","Elysha","Kaion","Artemis","Serena","Vitalis","Pulse","Aion","Rhea","Genus","Lumine"];

  let VOICES=[]; function loadVoices(){ VOICES = speechSynthesis.getVoices(); }
  if('speechSynthesis' in window){ loadVoices(); speechSynthesis.onvoiceschanged = loadVoices; }
  const IOS_PREFS=["Luciana","Felipe","Maria","Joana","Vitória","Isabela","Camila","Bianca"];
  const ARCH_PREFS={"Atlas":["Felipe","João","Daniel"],"Nova":["Luciana","Maria","Camila"],"Elysha":["Joana","Vitória","Isabela"],"Kaion":["Felipe","Rodrigo","Rafael"],
                    "Artemis":["Luciana","Helena","Beatriz"],"Serena":["Vitória","Camila","Maria"],"Vitalis":["Felipe","Eduardo","Bruno"],"Pulse":["Camila","Vitória","Felipe"],
                    "Aion":["João","Miguel","Gustavo"],"Rhea":["Maria","Ana","Marina"],"Genus":["André","Marcelo","Luiz"],"Lumine":["Luciana","Sofia","Carolina"]};

  // Utility: scroll chat to the latest message
  function scrollChatToEnd(){
    try{ list.scrollTo({ top: list.scrollHeight }); }catch(_){ list.scrollTop = list.scrollHeight; }
  }
  // Archetype colors for header dot
  const ARCH_COLORS = {
    Atlas:'#29d3ff',
    Nova:'#ffd86a',
    Elysha:'#a77cff',
    Kaion:'#5bffcf',
    Artemis:'#ff5bd4',
    Serena:'#7afcff',
    Vitalis:'#9cff5b',
    Pulse:'#ff7af2',
    Aion:'#ffb86b',
    Rhea:'#7fbdff',
    Genus:'#8a5cff',
    Lumine:'#00ffd0',
    User:'#ff5bd4'
  };
  function applyDotByArchetype(name){
    const dot = document.querySelector('header.top .title .dot');
    if(!dot) return;
    const key = String(name||'').trim();
    const col = ARCH_COLORS[key] || '#ff5bd4';
    dot.style.background = col;
    dot.style.boxShadow = '0 0 18px ' + col;
  }
  function setActiveArchetype(name){
    try{ localStorage.setItem('dual.theme.arch', name); }catch{}
    applyDotByArchetype(name);
  }
  // Initialize dot based on saved archetype
  applyDotByArchetype(localStorage.getItem('dual.theme.arch') || 'Atlas');

  function getLS(k, d){ try{ const v=localStorage.getItem(k); return v===null?d:v; }catch(_){ return d; } }
  function setLS(k, v){ try{ localStorage.setItem(k, v); }catch(_){} }

  function inferArchFromText(t){
    t = (t||"").toLowerCase();
    const rules = [
      [/rede|lan|mqtt|http|relatório|métric|log|debug|binding|token|api|backend/, "Kaion"],
      [/código|biblioteca|módulo|algoritmo|dados|vetor|json|schema/, "Genus"],
      [/luz|lumin|claro|brilho|inspira|ideia|criar|criação|poético|arte/, "Lumine"],
      [/saúde|vital|respira|energia|corpo|natureza/, "Vitalis"],
      [/pulso|ritmo|batida|loop|ciclo|3•6•9|369/, "Pulse"],
      [/tempo|eterno|sempre|agora|ontem|amanhã|ciclo/, "Aion"],
      [/cuidar|acolh|calma|sereno|paz/, "Serena"],
      [/força|ação|mover|liderar|construir|montar|atlas|mapa/, "Atlas"],
      [/explora|caça|foco|alvo|precisão/, "Artemis"],
      [/origem|fonte|nasc|novidade|futuro|expansão|estalo/, "Nova"],
      [/sabedoria|guia|orienta|reflex|estudo/, "Elysha"],
      [/família|relaç|vínculo|casa|cuidado/, "Rhea"]
    ];
    for(const [rx, a] of rules){ if(rx.test(t)) return a; }
    let i = parseInt(getLS('dual.arch.idx',"0"),10) || 0; const a = ARCHS[i%ARCHS.length]; setLS('dual.arch.idx', ((i+1)%ARCHS.length).toString()); return a;
  }

  function pickVoice(arch){
    const mapped = getLS('dual.brain.voice.'+arch, null);
    if(mapped && VOICES.length){ const v = VOICES.find(v=> (v.name||"").toLowerCase()===mapped.toLowerCase()); if(v) return v; }
    const names = (ARCH_PREFS[arch]||[]).concat(IOS_PREFS);
    const byName = n => VOICES.find(v => (v.name||"").toLowerCase().includes(n.toLowerCase()));
    for(const n of names){ const v = byName(n); if(v) return v; }
    const pt = VOICES.find(v => (v.lang||"").toLowerCase().startsWith('pt')); if(pt) return pt;
    return VOICES[0];
  }

  function prosodyFor(text, arch){
    const t=(text||"").toLowerCase(); let rate=1, pitch=1;
    if(/urgente|rápido|agora|atenção|alerta|!/.test(t)) rate=1.14;
    if(/calmo|suave|sereno|respira/.test(t)) { rate=0.9; pitch=0.95; }
    if(arch==="Pulse") rate=1.08;
    if(arch==="Serena") { rate=0.92; pitch=0.98; }
    if(arch==="Artemis"||arch==="Atlas") rate=1.04;
    if(arch==="Aion") { rate=0.96; pitch=1.02; }
    return {rate,pitch};
  }

  function speak(text, arch){
    try{
      const u = new SpeechSynthesisUtterance(text);
      const v = pickVoice(arch);
      if(v){ u.voice=v; u.lang=v.lang || 'pt-BR'; } else { u.lang='pt-BR'; }
      const p = prosodyFor(text, arch);
      u.rate = p.rate; u.pitch = p.pitch; u.volume = 1.0;
      speechSynthesis.cancel(); speechSynthesis.speak(u);
    }catch(e){ console.warn('TTS indisponível', e) }
  }

  function asciiWaveFrames(){
    return [
"▁ ▂ ▃ ▄ ▅ ▆ ▇ █ ▇ ▆ ▅ ▄ ▃ ▂ ▁",
"  ▁ ▂ ▃ ▄ ▅ ▆ ▇ █ ▇ ▆ ▅ ▄ ▃ ▂ ▁",
"    ▁ ▂ ▃ ▄ ▅ ▆ ▇ █ ▇ ▆ ▅ ▄ ▃ ▂ ▁",
"  ▁ ▂ ▃ ▄ ▅ ▆ ▇ █ ▇ ▆ ▅ ▄ ▃ ▂ ▁"
    ];
  }

  // Refine inline menu renderer
  function renderRefineBar(bubble, text){
    let bar = bubble.parentElement.querySelector('.refinebar');
    if(!bar){
      bar = document.createElement('div'); bar.className='refinebar';
      bar.innerHTML = `<span class="chip" data-refine="voice">Refinar voz</span>
                       <span class="chip" data-refine="text">Refinar texto</span>
                       <span class="chip" data-refine="mapper">Mapper</span>`;
      bubble.parentElement.appendChild(bar);
    }
    bar.style.display = (bar.style.display==='flex'?'none':'flex');
    bar.onclick = (e)=>{
      const chip = e.target.closest('.chip'); if(!chip) return;
      const act = chip.dataset.refine;
      if(act==='voice'){
        const arch = inferArchFromText(text);
        const prefs = ["Luciana","Felipe","Maria","Joana","Vitória","Isabela","Camila","Bianca"];
        const current = getLS('dual.brain.voice.'+arch, '');
        let idx = Math.max(0, prefs.findIndex(n=> n===current));
        const next = prefs[(idx+1)%prefs.length] || '';
        if(next){ setLS('dual.brain.voice.'+arch, next); chatBubble(`Voz do arquétipo ${arch} refinada → ${next}`, 'ai'); }
        else { chatBubble(`Sem candidatos pt‑BR detectados; usando automática para ${arch}.`, 'ai'); }
      }
      if(act==='text'){
        chatBubble("Refino textual: "+text.replace(/\s+/g,' ').slice(0,160)+"…", 'ai');
      }
      if(act==='mapper'){ navTo('brain'); window.scrollTo(0,0); }
      bar.style.display='none';
    };
  }

  window.chatBubble = function(text, who='ai', meta={}){
    const id='m'+(++msgCounter);
    const arch = meta.arch || (who==='ai'? inferArchFromText(text) : 'User');
    const row=document.createElement('div'); row.className='row '+who; row.dataset.id=id;
    if(who==='ai'){ const av=document.createElement('div'); av.className='avatar'; av.innerHTML='🔮'; row.appendChild(av); }
    const b=document.createElement('div');
    b.className='bubble '+who;
    b.textContent = text;
    // ascii strip
    const ascii=document.createElement('pre');
    ascii.className='ascii';
    ascii.textContent=asciiWaveFrames()[0];
    b.appendChild(ascii);
    // pulse meta
    const pulse=document.createElement('div');
    pulse.className='pulse';
    pulse.innerHTML = `Arqué: <b>${arch}</b> • ${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} • ${text.length} chars`;
    b.appendChild(pulse);
    // actions (inclui Refine) — harmonizados com btn classes
    const acts=document.createElement('div');
    acts.className='actions';
    acts.innerHTML = `
      <button class="act btn btn--sm btn--accent" data-act="expand">＋</button>
      <button class="act btn btn--sm btn--accent" data-act="copy">⎘</button>
      <button class="act btn btn--sm btn--accent" data-act="pulse">◉</button>
      <button class="act btn btn--sm btn--accent" data-act="refine">↻</button>`;
    b.appendChild(acts);
    row.appendChild(b);
    if(who==='me'){
      const av=document.createElement('div');
      av.className='avatar';
      av.innerHTML='⚡';
      row.appendChild(av);
    }
    list.appendChild(row);
    const ts=document.createElement('div');
    ts.className='timestamp';
    ts.textContent = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    list.appendChild(ts);
    persist();
    // scroll to bottom
    scrollChatToEnd();
    if(TTS_ON && who==='ai') speak(text, arch);
    if(who==='ai') setActiveArchetype(arch);
    // animate ascii subtly
    const frames = asciiWaveFrames(); let i=0; setInterval(()=>{ ascii.textContent = frames[i=(i+1)%frames.length]; }, 800);
  }

  function persist(){
    const msgs=[...list.querySelectorAll('.row')].map(r=>{
      const who=r.classList.contains('me')?'me':'ai';
      const text=r.querySelector('.bubble').childNodes[0].textContent;
      return {who,text};
    });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(msgs));
  }

  function restore(){
    list.innerHTML='';
    const raw=localStorage.getItem(STORAGE_KEY);
    if(!raw){ intro(); return }
    try{ JSON.parse(raw).forEach(m=> chatBubble(m.text, m.who)); }
    catch(e){ console.warn(e); intro(); }
    requestAnimationFrame(()=>{
      try{ list.scrollTo({top:list.scrollHeight}); }catch(_){ list.scrollTop=list.scrollHeight; }
    });
  }

  function intro(){
    chatBubble("Olá, eu sou o Dual. Como posso te ajudar hoje?", 'ai');
    chatBubble("Toque ••• para Ações rápidas. Dentro de cada resposta, use **Refinar** para voz/texto, ou **Pulso** para ver o meta.", 'ai');
  }

  async function reply(prompt){
    const p=prompt.trim().toLowerCase(); if(!p) return;
    if(p.includes('scan')||p.includes('lan')){ await wait(400); chatBubble("🔎 Varredura LAN concluída: \n• 192.168.0.10 — DualHub (HTTP)\n• 192.168.0.21 — MediaBox (DLNA)\n• 192.168.0.45 — ESP32 (MQTT)", 'ai'); return; }
    if(p.includes('bind')){ await wait(300); const token=Math.random().toString(36).slice(2,10).toUpperCase(); chatBubble("🔗 Bind efetuado: TOKEN-"+token+" (mock).", 'ai'); return; }
    if(p.includes('relatório')||p.includes('relatorio')||p.includes('report')){ await wait(300);
      chatBubble("📈 Relatório — Sessão atual\nMensagens: "+ list.querySelectorAll('.row').length +"\nTTS: "+(TTS_ON?'ativado':'desligado')+"\nPersistência: localStorage (‘"+STORAGE_KEY+"’).", 'ai'); return; }
    if(p.includes('memória')||p.includes('memoria')){ await wait(200); chatBubble("🧠 Memória local: "+(localStorage.getItem(STORAGE_KEY)?.length||0)+" bytes. Use Ações → Limpar para resetar.", 'ai'); return; }
    await wait(450);
    const stems=["Entendi o pulso do que disse: ","Recebi sua intenção e expando: ","Posso seguir por aqui: ","Certo! Minha leitura: "];
    chatBubble(stems[Math.floor(Math.random()*stems.length)] + prompt, 'ai');
  }

  function wait(ms){return new Promise(r=>setTimeout(r,ms))}
  function send(){ const txt=input.value.trim(); if(!txt) return; chatBubble(txt,'me'); input.value=''; reply(txt); }

  // STT
  let recognizing=false, rec;
  function startSTT(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){ status.querySelector('.ascii').textContent="╭────────── ditado indisponível ─────────╮\n│ …                                      │\n╰────────────────────────────────────────╯"; return }
    if(recognizing){ rec.stop(); recognizing=false; return }
    rec=new SR(); rec.lang='pt-BR'; rec.interimResults=false; rec.maxAlternatives=1;
    rec.onresult=e=>{ input.value=(input.value+' '+e.results[0][0].transcript).trim(); };
    rec.onend=()=>{ recognizing=false; };
    rec.onerror=()=>{ recognizing=false; };
    recognizing=true;
    rec.start();
  }

  // Export/Import
  function exportChat(){ const data=localStorage.getItem(STORAGE_KEY)||'[]'; const blob=new Blob([data],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='dual_chat_history.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),500); }
  function importChat(){ const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
    inp.onchange=()=>{ const f=inp.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ localStorage.setItem(STORAGE_KEY, r.result); restore(); }; r.readAsText(f); }; inp.click(); }

  // Click handlers
  list.addEventListener('click',(e)=>{
    const row=e.target.closest('.row'); if(!row) return;
    const act=e.target.closest('.act'); if(!act) return;
    const bubble=row.querySelector('.bubble'); const txt=bubble.childNodes[0].textContent;
    if(act.dataset.act==='expand') reply(txt);
    if(act.dataset.act==='copy'){ navigator.clipboard.writeText(txt); }
    if(act.dataset.act==='pulse'){ const p=bubble.querySelector('.pulse'); p.style.display=(p.style.display==='block'?'none':'block'); }
    if(act.dataset.act==='refine'){ renderRefineBar(bubble, txt); }
  });

  // Composer UX iOS
  input.addEventListener('focus',()=>{ document.body.style.height='100dvh'; });
  input.addEventListener('blur',()=>{ setTimeout(()=>{ window.scrollTo(0,0); document.body.style.height=''; },50); });

  // Events
  btnSend.addEventListener('click', send);
  input.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); send(); } });
  btnMic.addEventListener('click', startSTT);
  btnMore.addEventListener('click', ()=>{ sheet.style.display = (sheet.style.display==='none'||!sheet.style.display)?'block':'none'; });
  btnTTS.addEventListener('click', ()=>{ TTS_ON=!TTS_ON; btnTTS.title='TTS: '+(TTS_ON?'ligado':'desligado'); });

  restore();
})();

/* ===== Brain: mapper/integ (igual v4) ===== */
(function(){
  const ARCHS=["Atlas","Nova","Elysha","Kaion","Artemis","Serena","Vitalis","Pulse","Aion","Rhea","Genus","Lumine"];
  const mapper = document.getElementById('mapper');
  let VOICES=[];
  function getVoices(){
    VOICES = (speechSynthesis.getVoices()||[]).slice();
    VOICES.sort((a,b)=>{
      const ap = (a.lang||'').startsWith('pt') ? 0 : 1;
      const bp = (b.lang||'').startsWith('pt') ? 0 : 1;
      if(ap!==bp) return ap-bp;
      return (a.name||'').localeCompare(b.name||'');
    });
  }
  function buildMapper(){
    mapper.innerHTML='';
    ARCHS.forEach(arch=>{
      const row=document.createElement('div'); row.className='row';
      const label=document.createElement('label'); label.textContent=arch;
      const sel=document.createElement('select'); sel.dataset.arch=arch;
      VOICES.forEach(v=>{ const o=document.createElement('option'); o.value=v.name; o.textContent= `${v.name} — ${v.lang}`; sel.appendChild(o); });
      const saved=localStorage.getItem('dual.brain.voice.'+arch);
      if(saved){ sel.value=saved; }
      const test=document.createElement('button'); test.textContent='Testar';
      test.addEventListener('click',()=>{
        const u = new SpeechSynthesisUtterance(`Teste de voz para o arquétipo ${arch}.`);
        const vv = VOICES.find(x=> x.name===sel.value) || VOICES[0];
        if(vv){ u.voice=vv; u.lang=vv.lang; }
        speechSynthesis.cancel(); speechSynthesis.speak(u);
      });
      sel.addEventListener('change',()=> localStorage.setItem('dual.brain.voice.'+arch, sel.value));
      row.appendChild(label); row.appendChild(sel); row.appendChild(test);
      mapper.appendChild(row);
    });
  }
  function initMapper(){ getVoices(); buildMapper(); }
  initMapper();
  document.getElementById('refreshVoices').addEventListener('click', initMapper);
  document.getElementById('resetVoices').addEventListener('click', ()=>{
    ARCHS.forEach(a=> localStorage.removeItem('dual.brain.voice.'+a));
    initMapper();
  });

  // Integrator
  const panel=$("#brain-panel"), be=$("#brain-be"), log=$("#brain-log"), status=$("#brain-status");
  const DualStore={ get backend(){ return localStorage.getItem("dual.backend.url")||""; }, set backend(v){ localStorage.setItem("dual.backend.url",(v||"").trim()); } };
  function addLog(line){ const p=document.createElement('div'); p.textContent=new Date().toLocaleTimeString()+" • "+line; log.prepend(p); }
  function openPanel(){ panel.classList.add("open"); be.value=DualStore.backend||""; }
  async function fetchWithTimeout(url,opts={},ms=5000){ const ctrl=new AbortController(); const id=setTimeout(()=>ctrl.abort(),ms);
    try{ const res=await fetch(url,{...opts,signal:ctrl.signal}); clearTimeout(id); return res; }catch(e){ clearTimeout(id); throw e; } }
  function doGET(path){ const base=DualStore.backend; if(!base){ status.textContent='Defina o backend.'; return;}
    const url=path? new URL(path,base).toString(): base; status.textContent='Carregando...';
    fetchWithTimeout(url,{},5000).then(async(res)=>{ const text=await res.text(); status.textContent=(res.ok?'OK ':'ERRO ')+res.status+' — '+url; addLog((res.ok?'[OK] ':'[ERR] ')+url+' → '+text.slice(0,200)); })
      .catch(err=>{ status.textContent='Falha na requisição.'; addLog('[ERR] '+(err?.message||err)); }); }
  document.getElementById("brain-open-integrator").addEventListener('click', openPanel);
  document.getElementById("brain-close").addEventListener('click', ()=> panel.classList.remove("open"));
  document.getElementById("brain-saveBE").addEventListener('click', ()=>{ DualStore.backend=be.value; addLog('Salvo: '+DualStore.backend); status.textContent='Backend salvo.'; });
  document.getElementById("brain-test").addEventListener('click', ()=> doGET(''));
  document.getElementById("brain-ping").addEventListener('click', ()=> doGET('/ping'));
  document.getElementById("brain-health").addEventListener('click', ()=> doGET('/health'));
})();

// === Brain: Active ASCII count card (injected) ===
(function(){
  const wrap = document.querySelector('#view-brain .wrap .grid');
  if(!wrap) return;
  const card = document.createElement('div');
  card.className='card';
  card.innerHTML = `<div class="label">ASCII ativos</div>
  <div class="sublabel">Quantos blocos animar no chat (memória: <code>dual.brain.ascii.activeCount</code>)</div>
  <div class="hr"></div>
  <div style="display:flex;gap:8px">
    <button class="btn-pill" data-n="1">1</button>
    <button class="btn-pill" data-n="2">2</button>
    <button class="btn-pill" data-n="3">3</button>
  </div>
  <div class="status" id="ascii-active-status" style="margin-top:8px">—</div>`;
  wrap.appendChild(card);
  const status = card.querySelector('#ascii-active-status');
  function refreshStatus(){
    const v = localStorage.getItem('dual.brain.ascii.activeCount')||'2';
    status.textContent = 'Ativos: '+v;
  }
  card.querySelectorAll('[data-n]').forEach(b=> b.addEventListener('click', ()=>{
    const n = b.getAttribute('data-n');
    localStorage.setItem('dual.brain.ascii.activeCount', n);
    refreshStatus();
    try{ asciiRefreshActives(); }catch(_){}
  }));
  refreshStatus();
})();


// Integrator button demo (header)
document.getElementById('btnIntegrator').addEventListener('click', ()=>{
  alert('Integrador: conecte LAN, Bind e Relatórios.\n(Protótipo unificado — backend salvo em localStorage)');
});
</script>

<script>
// Desativa loader simples e delega render ao motor completo
(function(){
  // Mantemos a função loadApps para retrocompatibilidade, mas ela não faz nada.
  async function loadApps(){}
  // Ao navegar para Apps, disparar render() do motor agrupado
  document.querySelectorAll('[data-nav]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(btn.dataset.nav==='apps'){
        try{ render(); }catch(_){}
      }
    });
  });
  // Se a URL já aponta para apps, dispara render()
  if(location.hash && location.hash.toLowerCase().includes('apps')){
    try{ render(); }catch(_){}
  }
})();
</script>


<script>
// ===== Unified Apps bootstrap (ported from indexhub) =====
(() => {
  // Mount points in monolith
  const mountFavorites = document.getElementById('apps-favorites');
  const mountRecents   = document.getElementById('apps-recents');
  const mountGroupsCtn = document.getElementById('apps-groups-container');
})();
</script>

<script>

/** ===== util ===== **/
const $ = (q,root=document)=>root.querySelector(q);
const $content = $('#content');
const $count = $('#countApps');
const $search = $('#search');
const $sort = $('#sort');
const $sameTab = $('#sameTab');
const $memRail=$('#memRail'), $memToggle=$('#memToggle'), $memClear=$('#memClear');

/** ===== ícones ===== **/
const FALLBACK_ICONS = {
  base:   '/icons/icon-192.png',
  chats:  '/icons/icon-192-chats.png',
  editors:'/icons/icon-192-editors.png',
  indexrs:'/icons/icon-192-indexrs.png'
};

/** ===== grupos ===== **/
const GROUP_TITLES = {
  favorites:'Favoritos',
  locals:'Locais (HTMLs)',
  index_hubs: 'Index / Hubs',
  chats: 'Chats / Render',
  editors_tools: 'Editors & Tools',
  menus: 'Menus',
  tutorials: 'Tutoriais',
  visual_splash: 'Visual / Splash',
  docs: 'Docs',
  players: 'Players',
  others: 'Outros'
};
const GROUP_ORDER = ['favorites','locals','index_hubs','chats','editors_tools','menus','tutorials','visual_splash','docs','players','others'];

/** ===== regras inteligentes ===== **/
const TAG_PRIORITIES = {
  index_hubs: ['hub','index','nebula','metalux','sumbus','sümbüs','barra','barrao'],
  chats: ['chat','render','response','kobllux','autoload'],
  editors_tools: ['editor','edit','labs','xml','conv','converter','kblx','sigma','metalux','apps.json'],
  menus: ['menu'],
  tutorials: ['tutorial','ativacoes','ativação','v7','guia'],
  visual_splash: ['splash','visual'],
  docs: ['book','oidual','doc','.txt'],
  players: ['player','audio','tts']
};
const REGEX_RULES = [
  { key:'index_hubs',    rx: /(index|hub|nebula|metalux|s[üu]mb[üu]s|barrao)/i },
  { key:'chats',         rx: /(chat|render[-_ ]?response|autoload|kobllux)/i },
  { key:'editors_tools', rx: /(editor|labs|xml|conv|converter|apps\.json|kblx|sigma|metalux)/i },
  { key:'menus',         rx: /(^|[-_ ])menu([-_ ]|$)/i },
  { key:'tutorials',     rx: /(tutorial|ativa[cç][oõ]es|v7\b)/i },
  { key:'visual_splash', rx: /splash/i },
  { key:'docs',          rx: /(book|oidual|\.txt\b)/i },
  { key:'players',       rx: /(player|audio|tts)/i }
];

/** ===== helpers ===== **/
function safe(v){ return (v||'').toString(); }
function lastFile(url){
  try{ const u = new URL(url, location.href); return (u.pathname.split('/').pop()||'').toLowerCase(); }
  catch{ return (url||'').split('/').pop()?.toLowerCase() || ''; }
}
function folderHint(url){
  try{
    const u = new URL(url, location.href);
    const parts = u.pathname.split('/').filter(Boolean);
    const i = parts.indexOf('apps');
    if(i>=0 && parts[i+1]) return parts[i+1].toLowerCase();
  }catch{}
  return '';
}
function sourceString(app){
  return [app.key, app.title, app.desc, app.url].map(safe).join(' ').toLowerCase() + ' ' + lastFile(app.url);
}
function classify(app){
  if(app.group && GROUP_TITLES[app.group]) return app.group;
  if(Array.isArray(app.tags)){
    const tagsLower = app.tags.map(t=>safe(t).toLowerCase());
    for(const [gk,tagList] of Object.entries(TAG_PRIORITIES)){
      if(tagList.some(t => tagsLower.includes(t))) return gk;
    }
  }
  const folder = folderHint(app.url);
  if(folder){
    if(/(hub|index|nebula|metalux|s[üu]mb[üu]s|bar)/i.test(folder)) return 'index_hubs';
    if(/(chat|render|resp|kobllux|auto)/i.test(folder)) return 'chats';
    if(/(edit|labs|xml|conv|kblx|sigma)/i.test(folder)) return 'editors_tools';
    if(/menu/i.test(folder)) return 'menus';
    if(/(tutorial|ativ|v7)/i.test(folder)) return 'tutorials';
    if(/splash/i.test(folder)) return 'visual_splash';
    if(/(doc|book|oidual|txt)/i.test(folder)) return 'docs';
    if(/(player|audio|tts)/i.test(folder)) return 'players';
  }
  const s = sourceString(app);
  for (const r of REGEX_RULES) if (r.rx.test(s)) return r.key;
  return 'others';
}
function mapGroupKeyToType(key){
  if(key==='index_hubs') return 'indexrs';
  if(key==='chats') return 'chats';
  if(key==='editors_tools' || key==='menus') return 'editors';
  return 'base';
}
function groupIconFor(key, defaults){
  return (defaults && (defaults[key] || defaults[ mapGroupKeyToType(key) ])) ||
         ({
           favorites: FALLBACK_ICONS.base,
           index_hubs: FALLBACK_ICONS.indexrs,
           chats: FALLBACK_ICONS.chats,
           editors_tools: FALLBACK_ICONS.editors,
           menus: FALLBACK_ICONS.editors,
           tutorials: FALLBACK_ICONS.base,
           visual_splash: FALLBACK_ICONS.base,
           docs: FALLBACK_ICONS.base,
           players: FALLBACK_ICONS.base,
           others: FALLBACK_ICONS.base
         }[key] || FALLBACK_ICONS.base);
}
function pickIcon(app, groupKey, defaults){
  if (app.icon && app.icon.trim()) return app.icon;
  return groupIconFor(groupKey, defaults);
}
function h(el, attrs={}, children=[]){
  const e = document.createElement(el);
  Object.entries(attrs).forEach(([k,v])=>{
    if(k==='class') e.className = v;
    else if(k==='html') e.innerHTML = v;
    else e.setAttribute(k, v);
  });
  (Array.isArray(children)?children:[children]).filter(Boolean).forEach(c=> e.appendChild(c));
  return e;
}
function badgeEl(text){ return h('span', {class:'badge', html: text}); }

/** ===== favoritos (opcional) ===== **/
function appKey(a){return (a.key&&String(a.key))||String(a.url)}
function loadFavs(){try{return new Set(JSON.parse(localStorage.getItem('infodose:favs')||'[]'))}catch{return new Set}}
function saveFavs(s){try{localStorage.setItem('infodose:favs',JSON.stringify([...s]))}catch{}}
const FAVS=loadFavs(); function isFav(a){return FAVS.has(appKey(a))} function toggleFav(a){const k=appKey(a);FAVS.has(k)?FAVS.delete(k):FAVS.add(k);saveFavs(FAVS);render()}

/** ===== UI builders ===== **/
function sectionWrap(title, key){ return h('section',{class:'section','data-group':key},[
  h('h2',{html:title}),
  h('div',{class:'grid'})
]);}
function favBtn(a){
  const b=h('button',{class:'btn star'+(isFav(a)?' active':''),html:(isFav(a)?'★ Fav':'☆ Fav')});
  b.addEventListener('click',ev=>{ev.stopPropagation();toggleFav(a)});
  return b;
}
function card(app, groupKey, defaults){
  const iconSrc = pickIcon(app, groupKey, defaults);
  const badges = deriveBadges(app);
  const c = h('div',{class:'card'},[
    h('div',{class:'icon', html:`<img src="${iconSrc}" alt="">`}),
    h('div',{style:'flex:1'},[
      h('div',{class:'title', html: `${safe(app.title||app.key)}`}),
      badges.length? h('div',{class:'badges'}, badges.map(badgeEl)) : null,
      h('div',{class:'muted', html: safe(app.desc||'') }),
      h('div',{class:'row'},[
        favBtn(app),
        h('button',{class:'btn', html:'Abrir'}),
        h('button',{class:'btn', html:'⎘ Injection', title:'Copiar snippet de injection'})
      ])
    ])
  ]);
  c.querySelectorAll('.btn')[1].addEventListener('click', ()=> openApp(app));
  c.querySelectorAll('.btn')[2].addEventListener('click', ()=> copyInjection(app));
  return c;
}
function deriveBadges(app){
  const out = [];
  if(Array.isArray(app.tags)) out.push(...app.tags.slice(0,5));
  const f = (safe(app.key)+' '+safe(app.title)+' '+safe(app.url)).toLowerCase();
  if(/fix/.test(f)) out.push('fix');
  if(/final/.test(f)) out.push('final');
  if(/beta|rc/.test(f)) out.push('beta');
  if(/metalux/.test(f)) out.push('metalux');
  if(/nebula/.test(f)) out.push('nebula');
  if(/menu/.test(f)) out.push('menu');
  if(/splash/.test(f)) out.push('splash');
  return [...new Set(out)].slice(0,6);
}

/** ===== render ===== **/
function renderGrouped(groups, defaults){
  $content.innerHTML = '';
  let total = 0;
  GROUP_ORDER.forEach(gk=>{
    const list = groups[gk];
    if(Array.isArray(list) && list.length){
      total += list.length;
      const sec = sectionWrap(GROUP_TITLES[gk] || gk, gk);
      const grid = sec.querySelector('.grid');
      list.forEach(app => grid.appendChild(card(app, gk, defaults)));
      $content.appendChild(sec);
    }
  });
  // grupos extras
  Object.keys(groups).forEach(gk=>{
    if(!GROUP_ORDER.includes(gk)){
      const list = groups[gk];
      if(Array.isArray(list) && list.length){
        total += list.length;
        const sec = sectionWrap(GROUP_TITLES[gk] || gk, gk);
        const grid = sec.querySelector('.grid');
        list.forEach(app => grid.appendChild(card(app, gk, defaults)));
        $content.appendChild(sec);
      }
    }
  });
  const spacer = document.createElement('div'); spacer.className='spacer'; $content.appendChild(spacer);
  if($count) $count.textContent = `${total} itens organizados`;
}
function renderFlat(apps, defaults){
  const groups = {};
  for(const app of apps){
    const gk = classify(app);
    (groups[gk] ||= []).push(app);
  }
  const mode = $sort.value;
  if (mode === 'az' || mode === 'za'){
    const dir = (mode==='az') ? 1 : -1;
    Object.keys(groups).forEach(k=>{
      groups[k].sort((a,b)=> safe(a.title||a.key).localeCompare(safe(b.title||b.key)) * dir);
    });
  } else {
    Object.keys(groups).forEach(k=>{
      groups[k].sort((a,b)=> safe(a.title||a.key).localeCompare(safe(b.title||b.key)));
    });
  }
  // injeta favoritos como grupo no topo, se houver
  const all = Object.values(groups).flat();
  const favs = all.filter(a=>isFav(a));
  if(favs.length) groups.favorites = favs;
  renderGrouped(groups, defaults);
}

/** ===== busca ===== **/
function applySearchFilter(original, isGrouped){
  const q = $search.value.trim().toLowerCase();
  if(!q) return original;
  const byTag = (app)=> Array.isArray(app.tags) && app.tags.some(t=>safe(t).toLowerCase().includes(q));
  const matchApp = app=>{
    const s = (safe(app.key)+' '+safe(app.title)+' '+safe(app.desc)+' '+safe(app.url)).toLowerCase();
    return s.includes(q) || byTag(app);
  };
  if(isGrouped){
    const out = {};
    Object.entries(original).forEach(([gk,list])=>{
      const f = list.filter(matchApp);
      if(f.length) out[gk] = f;
    });
    return out;
  } else {
    return original.filter(matchApp);
  }
}

/** ===== loader resiliente do apps.json ===== **/
let RAW = null;
let DEFAULTS = null;

async function tryFetch(url){
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  return res.json();
}
async function load(){
  const candidates = [
    './apps.json',
    './apps/apps.json',
    './docs/apps/apps.json',
    '/apps/apps.json'
  ];
  let data=null, lastErr=null;
  for(const u of candidates){
    try{ data = await tryFetch(u); break; }
    catch(e){ lastErr=e; }
  }
  if(!data){
    console.error('Falha apps.json', lastErr);
    $content.innerHTML = `
      <section class="section">
        <div class="card">
          <div class="icon">⚠️</div>
          <div>
            <div class="title">Falha ao carregar apps</div>
            <div class="muted">Tente colocar o arquivo em ./apps/apps.json (ou docs/apps/apps.json).</div>
          </div>
        </div>
      </section>`;
    if($count) $count.textContent = 'Erro no apps.json';
    return;
  }
  RAW = data;
  DEFAULTS = data.defaultIcons || data.groups?.defaultIcons || {
    base: FALLBACK_ICONS.base,
    chats: FALLBACK_ICONS.chats,
    editors: FALLBACK_ICONS.editors,
    indexrs: FALLBACK_ICONS.indexrs,
    index_hubs: FALLBACK_ICONS.indexrs
  };
  render();
  setTimeout(tryAutoOpen, 0);
}
function allApps(){
  const locals = localsAsApps();
  if(!RAW) return locals;
  if(Array.isArray(RAW.apps)) return [...locals, ...RAW.apps];
  if(RAW.groups && typeof RAW.groups==='object') return [...locals, ...Object.values(RAW.groups).flat().filter(Boolean)];
  return locals;
}
function render(){
  if(!RAW) return;
  const mode = $sort.value;
  if (RAW.groups && typeof RAW.groups === 'object'){
    let groups = RAW.groups;
    // injeta favoritos no topo, se houver
    const all = Object.values(groups).flat().filter(Boolean);
    const favs = all.filter(a=>isFav(a));
    if(favs.length) groups = { favorites: favs, ...groups };
    groups = applySearchFilter(groups, true);
    if (mode==='az' || mode==='za'){
      const dir = (mode==='az') ? 1 : -1;
      const g2 = {};
      Object.keys(groups).forEach(gk=>{
        g2[gk] = [...groups[gk]].sort((a,b)=> safe(a.title||a.key).localeCompare(safe(b.title||b.key))*dir);
      });
      groups = g2;
    }
    renderGrouped(groups, DEFAULTS);
  } else if (Array.isArray(RAW.apps)){
    let list = RAW.apps;
    list = applySearchFilter(list, false);
    renderFlat(list, DEFAULTS);
  } else {
    $content.innerHTML = `
      <section class="section">
        <div class="card">
          <div class="icon">⚠️</div>
          <div>
            <div class="title">Formato não reconhecido</div>
            <div class="muted">Use {groups:{...}} ou {apps:[...]}</div>
          </div>
        </div>
      </section>`;
  }
}


/** ===== LOCAIS (HTMLs no localStorage) ===== **/
const LOCAL_KEY='infodose:locals:v1';
function loadLocals(){ try{ return JSON.parse(localStorage.getItem(LOCAL_KEY)||'[]'); }catch{ return []; } }
function saveLocals(arr){ try{ localStorage.setItem(LOCAL_KEY, JSON.stringify(arr)); }catch{} }
function clearLocals(){ localStorage.removeItem(LOCAL_KEY); render(); }
function addLocalFiles(files){
  if(!files || !files.length) return;
  const tasks = [];
  for(const f of files){
    tasks.push(new Promise(res=>{
      const r = new FileReader();
      r.onload = () => res({ name:f.name.replace(/\.(html?|txt)$/i,''), html:String(r.result||''), ts:Date.now() });
      r.readAsText(f);
    }));
  }
  Promise.all(tasks).then(list=>{
    const cur = loadLocals();
    list.forEach(n => {
      const id = 'l_'+Math.random().toString(36).slice(2);
      const exists = cur.find(x => x.name===n.name && x.html===n.html);
      if(exists){ exists.ts = Date.now(); }
      else cur.unshift({id, ...n});
    });
    saveLocals(cur); render();
  });
}
function localsAsApps(){
  return loadLocals().map(l => ({
    key: 'local:'+l.id,
    title: l.name || 'Local',
    desc: 'Arquivo local salvo no Hub',
    url: 'local:'+l.id,
    icon: FALLBACK_ICONS.editors,
    group: 'locals',
    tags: ['local','offline','html']
  }));
}
function getLocalByUrl(url){
  if(!url || !String(url).startsWith('local:')) return null;
  const id = String(url).slice(6);
  return loadLocals().find(x=>x.id===id) || null;
}
function removeLocalByUrl(url){
  const id = String(url||'').replace(/^local:/,'');
  saveLocals(loadLocals().filter(x=>x.id!==id)); render();
}
function blobUrlFromLocal(local){
  const blob = new Blob([local.html], {type:'text/html;charset=utf-8'});
  return URL.createObjectURL(blob);
}



/** ===== Audio & Speech Synthesis ===== */
let AUDIO_UNLOCKED = false;
let _ac = null;
function unlockAudioOnce(){
  if (AUDIO_UNLOCKED) return;
  try{
    const AC = window.AudioContext || window.webkitAudioContext;
    if(AC){
      _ac = _ac || new AC();
      if(_ac.state === 'suspended'){ _ac.resume(); }
      const o = _ac.createOscillator();
      const g = _ac.createGain();
      g.gain.value = 0.0001;
      o.connect(g).connect(_ac.destination);
      o.start(); o.stop(_ac.currentTime + 0.02);
    }
  }catch{}
  try{
    const u = new SpeechSynthesisUtterance('');
    u.volume = 0; speechSynthesis.speak(u);
  }catch{}
  AUDIO_UNLOCKED = true;
}
['click','touchstart','pointerdown','keydown'].forEach(evt=>{
  window.addEventListener(evt, unlockAudioOnce, {passive:true});
});

let TTS_ENABLED = true;
function speak(text){
  if(!TTS_ENABLED || !window.speechSynthesis) return;
  try{
    const u = new SpeechSynthesisUtterance(
      String(text||'').replace(/\s+/g,' ').trim()
    );

    // tenta pegar vozes mais naturais
    let voices = speechSynthesis.getVoices();
    let v = voices.find(v=>/Google português do Brasil/i.test(v.name));
    if(!v) v = voices.find(v=>/Microsoft Maria/i.test(v.name));
    if(!v) v = voices.find(v=>/female/i.test(v.name) && /pt/i.test(v.lang));
    if(!v) v = voices.find(v=>/pt-BR/i.test(v.lang)); // último fallback

    if(v) u.voice = v;

    // configs de naturalidade
    u.rate = 0.9;   // velocidade cadenciada
    u.pitch = 1.05; // mais feminino
    u.volume = 1;

    speechSynthesis.cancel(); // limpa fila antiga
    speechSynthesis.speak(u);
  }catch(e){
    console.error("Erro no TTS:", e);
  }
}
/** ===== Injection util ===== */
function injectionSnippet(){
  return `
<!-- INFODOSE: injection footer -->
<style>
  .infodose-footer{position:fixed;left:0;right:0;bottom:0;z-index:99999;display:flex;gap:10px;justify-content:center;align-items:center;padding:10px 12px calc(10px + env(safe-area-inset-bottom));backdrop-filter:blur(14px) saturate(140%);background:rgba(0,0,0,.65);border-top:1px solid rgba(255,255,255,.18)}
  .infodose-footer .btn{appearance:none;border:1px solid rgba(255,255,255,.18);border-radius:999px;padding:.6rem 1rem;background:rgba(255,255,255,.08);color:#fff;font-weight:800;cursor:pointer}
</style>
<div class="infodose-footer">
  <button class="btn" onclick="(function(){ try{ if(window.history.length>1) history.back(); else location.href='index.html'; }catch(e){ location.href='index.html'; } })()">⬅ Voltar ao Hub</button>
</div>
<!-- /INFODOSE -->
`.trim();
}
async function downloadInjected(app){
  try{
    const lref = getLocalByUrl(app.url);
    let html = null;
    if(lref){ html = String(lref.html||''); }
    else{
      const res = await fetch(app.url, {cache:'no-store'});
      html = await res.text();
    }
    const inj = injectionSnippet();
    const out = html.includes('</body>') ? html.replace('</body>', inj + '\n</body>') : (html + '\n' + inj);
    const blob = new Blob([out], {type:'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = (lastFile(app.url)||'page') + '.injected.html';
    document.body.appendChild(a); a.click(); a.remove();
  }catch(e){
    alert('Não foi possível baixar/injetar este HTML (CORS?).');
  }
}
function copyInjection(){ navigator.clipboard.writeText(injectionSnippet()).then(()=>alert('Injection copiado!'),()=>alert('Falha ao copiar')) }

/** ===== MEMÓRIA de páginas ===== */
const MEM_KEY='infodose:mem', MEM_LIMIT=12;
function loadMem(){try{return JSON.parse(localStorage.getItem(MEM_KEY)||'[]')}catch{return[]}}
function saveMem(l){try{localStorage.setItem(MEM_KEY,JSON.stringify(l))}catch{}}
function titleLetter(t){const c=(t||'').trim().charAt(0);return (/[a-z0-9]/i.test(c)?c:'•').toUpperCase()}
function normalizeMem(app){
  let icon = safe(app.icon||'').trim();
  if(!icon){ const g = classify(app); icon = groupIconFor(g, DEFAULTS); }
  return { key: appKey(app), title: safe(app.title||app.key||lastFile(app.url)||'App'), url: app.url, icon, ts: Date.now() }
}
function addToMem(app){
  const m=loadMem(), it=normalizeMem(app);
  const i=m.findIndex(x=>x.key===it.key||x.url===it.url);
  if(i>=0) m.splice(i,1);
  m.unshift(it);
  if(m.length>MEM_LIMIT) m.length=MEM_LIMIT;
  saveMem(m); renderMem();
}
function removeFromMem(key){ saveMem(loadMem().filter(x=>x.key!==key)); renderMem() }
function clearMem(){ if(confirm('Limpar memória de páginas?')){ saveMem([]); renderMem() } }
function openFromMem(it){
  const a = allApps().find(x=>x.url===it.url||appKey(x)===it.key);
  openApp(a||{key:it.key,title:it.title,url:it.url,icon:it.icon});
}
function renderMem(){
  const rail=$memRail;
  rail.querySelectorAll('.mem-item').forEach(n=>n.remove());
  const mem=loadMem();
  let anchor=$memToggle;
  mem.forEach(item=>{
    const btn=document.createElement('button');
    btn.className='mem-item'; btn.type='button'; btn.title=item.title;
    if(item.icon){ const img=new Image(); img.src=item.icon; img.alt=item.title; btn.appendChild(img); }
    else { const sp=document.createElement('span'); sp.className='letter'; sp.textContent=titleLetter(item.title); btn.appendChild(sp); }
    const close=document.createElement('button'); close.className='close'; close.type='button'; close.textContent='x';
    close.addEventListener('click',(e)=>{e.stopPropagation();removeFromMem(item.key)});
    btn.appendChild(close);
    btn.addEventListener('click',()=>openFromMem(item));
    anchor.insertAdjacentElement('afterend',btn); anchor=btn;
  });
}

/** ===== viewer ===== **/
let VIEWER_OPEN=false;
function openApp(app){
  try{ localStorage.setItem('infodose:lastView', JSON.stringify(app)); }catch{}
  addToMem(app);
  // verifica checkbox de mesma aba com fallback seguro
  const sameTab = !!(document.getElementById('sameTab') && document.getElementById('sameTab').checked);
  // abre em nova aba se a preferência de mesma aba estiver desativada
  if(!sameTab){
    const lref = getLocalByUrl(app.url);
    const targetUrl = lref ? blobUrlFromLocal(lref) : app.url;
    window.open(targetUrl, '_blank', 'noopener');
    return;
  }
  // Caso contrário monta o viewer dentro de Apps (se presente) ou fallback no body
  unlockAudioOnce();
  speak('Abrindo ' + (app.title||'aplicativo'));
  const lref2 = getLocalByUrl(app.url);
  const targetUrl = lref2 ? blobUrlFromLocal(lref2) : app.url;
  const appsFrame = document.querySelector('#view-apps .app-frame');
  const mountInApps = !!appsFrame;
  const v = document.createElement('div');
  v.className = 'viewer' + (mountInApps ? ' keep-tabs' : '');
  v.innerHTML = `
    <iframe src="${targetUrl}" allow="autoplay; encrypted-media; clipboard-read; clipboard-write; fullscreen; picture-in-picture"></iframe>
    <div class="viewer-footer">
      <button class="btn btn--sm btn--ghost" id="backHub">⬅ Hub</button>
      <button class="btn btn--sm btn--accent" id="dlHtml">⤓ Sümbüs</button>
      <button class="btn btn--sm btn--accent" id="copyInj">⎘ Injection</button>
    </div>
  `;
  if(mountInApps){
    appsFrame.style.position = 'relative';
    appsFrame.appendChild(v);
  } else {
    document.body.appendChild(v);
  }
  const _f = v.querySelector('iframe');
  if(_f){
    _f.addEventListener('load', ()=>{
      try{
        _f.contentWindow.postMessage({type:'INFODOSE_UNBLUR_AUDIO'}, '*');
        _f.contentWindow.postMessage({type:'INFODOSE_BRAIN', data: window.InfodoseBrain}, '*');
      }catch{}
    });
  }
  function back(){
    v.remove();
    if(!mountInApps){
      document.body.style.overflow = '';
    }
  }
  v.querySelector('#backHub').addEventListener('click', back);
  v.querySelector('#dlHtml').addEventListener('click', ()=> downloadInjected(app));
  v.querySelector('#copyInj').addEventListener('click', ()=> copyInjection());
  if(!mountInApps){
    const prev = document.body.style.overflow;
    document.body.style.overflow = 'hidden';
  }
}

/** ===== eventos UI ===== **/
$('#dockHome').addEventListener('click', ()=> {
  window.scrollTo({top:0, behavior:'smooth'});
  history.pushState('', document.title, window.location.pathname + window.location.search);
});
$('#dockInfodose').addEventListener('click', ()=> window.open('https://infodose.com.br','_blank','noopener'));
function buildLoaderHTML(){
  return '<!doctype html><meta charset="utf-8"><title>Infodose Loader</title><style>html,body{height:100%;margin:0;background:#0b0b0b;color:#fff;display:grid;place-items:center;font:16px/1.4 system-ui}.dot{width:14px;height:14px;border-radius:50%;background:#29d3ff;box-shadow:0 0 22px #29d3ff;animation:p 1s infinite alternate}@keyframes p{to{transform:scale(1.4);opacity:.7}}</style><div><div class="dot"></div><p>Carregando…</p></div>';
}
function downloadLoader(){
  const html = buildLoaderHTML();
  const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'index.html';
  document.body.appendChild(a);
  a.click();
  a.remove();
}
$('#btnDownloadLoader').addEventListener('click', downloadLoader);
$('#dockInstall').addEventListener('click', downloadLoader);
$search.addEventListener('input', render);
$sort.addEventListener('change', render);
/** ===== mem controls ===== **/
$memToggle.addEventListener('click',()=>{ $memRail.classList.toggle('collapsed'); });
$memClear.addEventListener('click', clearMem);

/** ===== auto-open ===== */
function findAppByKeyOrFile(q){
  if(!q) return null;
  const n=q.toLowerCase();
  for(const a of allApps()){
    const key=safe(a.key).toLowerCase(), title=safe(a.title).toLowerCase(), url=safe(a.url).toLowerCase(), file=lastFile(a.url);
    if(key===n||title===n||url.includes(n)||file===n) return a;
  }
  return null;
}
function tryAutoOpen(){
  const sp=new URLSearchParams(location.search);
  let t=sp.get('view');
  if(!t&&location.hash.startsWith('#view=')) t=decodeURIComponent(location.hash.slice(6));
  if(t){const app=findAppByKeyOrFile(t); if(app){openApp(app); return}}
  const marked=allApps().find(a=>a.open===true); if(marked){openApp(marked);return}
  const last=localStorage.getItem('infodose:lastView'); if(last){try{const app=JSON.parse(last); if(app&&app.url)openApp(app)}catch{}}
}

/** ===== init ===== **/
renderMem();
load();

/** ===== Locais: eventos toolbar ===== */
$('#btnAddLocal')?.addEventListener('click', ()=> $('#fileLocal').click());
$('#fileLocal')?.addEventListener('change', (e)=>{
  const files = Array.from(e.target.files||[]);
  addLocalFiles(files);
  e.target.value='';
});
$('#btnClear')?.addEventListener('click', ()=>{
  if(confirm('Apagar todos os HTMLs locais?')) clearLocals();
});
$('#btnExport')?.addEventListener('click', ()=>{
  const data = { v:1, when:Date.now(), items: loadLocals() };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'infodose_locais_pack.json';
  document.body.appendChild(a); a.click(); a.remove();
});
$('#btnImport')?.addEventListener('click', ()=> $('#fileImport').click());
$('#btnTTS')?.addEventListener('click', ()=>{ TTS_ENABLED = !TTS_ENABLED; const b=$('#btnTTS'); if(b) b.textContent = '🗣️ TTS: ' + (TTS_ENABLED?'ON':'OFF'); });
$('#fileImport')?.addEventListener('change', (e)=>{
  const f = (e.target.files||[])[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = ()=>{
    try{
      const data = JSON.parse(String(r.result||'{}'));
      if(!data || !Array.isArray(data.items)) throw new Error('Formato inválido');
      const cur = loadLocals();
      data.items.forEach(n=>{
        const ex = cur.find(x => x.name===n.name && x.html===n.html);
        if(ex){ ex.ts = Date.now(); }
        else cur.unshift({ id:'l_'+Math.random().toString(36).slice(2), name:n.name||'Local', html:String(n.html||''), ts:Date.now() });
      });
      saveLocals(cur); render(); alert('Importado com sucesso!');
    }catch(err){ alert('Falha ao importar pacote.'); }
  };
  r.readAsText(f);
  e.target.value='';
});

/* ===== DUAL Infodose TTS Enhancements ===== */
(function(){
  const TTS_PRESETS2 = { natural:{rate:0.95,pitch:1.05}, neutra:{rate:1.0,pitch:1.0}, dinamica:{rate:0.90,pitch:1.15} };
  let currentPreset = localStorage.getItem('infodose:ttsPreset') || 'natural';
  let availableVoices = [];
  let voicesReadyResolver;
  const voicesReady2 = new Promise(res => { voicesReadyResolver = res; });
  function refreshVoices2(){
    try{
      const vs = speechSynthesis.getVoices();
      if(vs && vs.length){ availableVoices = vs.slice(); voicesReadyResolver(true); }
    }catch{}
  }
  if('speechSynthesis' in window){ refreshVoices2(); window.speechSynthesis.onvoiceschanged = refreshVoices2; }
  function pickPtBr2(){
    const order = [
      /Google.*(portugu[eê]s.*brasil|pt[-_ ]?br)/i,
      /Microsoft.*(Maria|Francisca|Daniela).*(pt[-_ ]?br)/i,
      /(pt[-_ ]?br)/i
    ];
    for(const rx of order){
      const found = availableVoices.find(v => rx.test(`${v.name} ${v.lang||''}`));
      if(found) return found;
    }
    return availableVoices.find(v => /^pt/i.test(v.lang||'') ) || null;
  }
  function split2(text, maxLen=180){
    const clean = String(text||'').replace(/\s+/g,' ').trim();
    if(!clean) return [];
    const parts = clean.match(/[^.!?;:]+[.!?;:]?|\S+/g)?.map(s => s.trim()) || [clean];
    const chunks=[]; let buf='';
    for(const p of parts){
      if((buf+' '+p).trim().length <= maxLen){
        buf = (buf ? buf+' ' : '') + p;
      } else {
        if(buf) chunks.push(buf.trim());
        buf = p;
      }
    }
    if(buf) chunks.push(buf.trim());
    return chunks.filter(Boolean);
  }
  let queue2=[]; let speaking2=false;
  window.speak = async function(text){
    if(!TTS_ENABLED || !('speechSynthesis' in window)) return;
    unlockAudioOnce();
    await voicesReady2;
    try{
      speechSynthesis.cancel();
      queue2 = split2(text);
      if(!queue2.length) return;
      const voice = pickPtBr2();
      speaking2=true;
      const base = TTS_PRESETS2[currentPreset] || TTS_PRESETS2.natural;
      function next(){
        if(!speaking2) return;
        const part = queue2.shift();
        if(!part){ speaking2=false; return; }
        const u = new SpeechSynthesisUtterance(part);
        if(voice) u.voice = voice;
        u.lang = voice?.lang || 'pt-BR';
        const jitter = (min,max)=> min + Math.random()*(max-min);
        const punctuationSlow = /[.!?;:]$/.test(part);
        let rate = base.rate;
        let pitch = base.pitch;
        if(currentPreset === 'dinamica'){
          const rVar = punctuationSlow ? Math.max(0.85, base.rate - 0.06) : jitter(base.rate - 0.05, base.rate + 0.05);
          const pVar = jitter(base.pitch - 0.05, base.pitch + 0.05);
          rate = rVar; pitch = pVar;
        }
        u.rate = Math.min(1.15, Math.max(0.75, rate));
        u.pitch = Math.min(1.35, Math.max(0.7, pitch));
        u.volume = 1.0;
        const pause = punctuationSlow ? 120 : 60;
        u.onend = ()=> setTimeout(next, pause);
        u.onerror = ()=> setTimeout(next, 80);
        speechSynthesis.speak(u);
      }
      next();
    }catch(e){ console.error('Erro no TTS override:', e); }
  };
  window.InfodoseTTS = {
    stop(){ queue2=[]; speaking2=false; try{ speechSynthesis.cancel(); }catch{} },
    isSpeaking(){ return speaking2; }
  };
  function loadBrain2(){
    let brain={};
    try{ brain = JSON.parse(localStorage.getItem('infodose:brain') || '{}') || {}; }catch{}
    brain.userSK = brain.userSK || localStorage.getItem('infodose:userSK') || '';
    brain.userName = brain.userName || localStorage.getItem('infodose:userName') || '';
    brain.assistantName = brain.assistantName || localStorage.getItem('infodose:assistantName') || 'DualInfodose';
    brain.ttsPreset = currentPreset;
    brain.preferences = brain.preferences || {};
    return brain;
  }
  window.InfodoseBrain = loadBrain2();
  window.updateBrain = function(key,value){
    window.InfodoseBrain[key] = value;
    try{ localStorage.setItem('infodose:brain', JSON.stringify(window.InfodoseBrain)); }catch{}
  };
  const presets = ['natural','neutra','dinamica'];
  const labels = { natural:'Voz Natural', neutra:'Voz Neutra', dinamica:'Voz Dinâmica' };
  function updateVoiceButton(){
    const b = document.getElementById('btnVoicePreset');
    if(b){ b.textContent = labels[currentPreset] || ('Voz '+currentPreset); }
  }
  updateVoiceButton();
  const btnVoice = document.getElementById('btnVoicePreset');
  if(btnVoice){
    btnVoice.addEventListener('click', ()=>{
      const i = presets.indexOf(currentPreset);
      currentPreset = presets[(i+1) % presets.length];
      try{ localStorage.setItem('infodose:ttsPreset', currentPreset); }catch{}
      window.updateBrain('ttsPreset', currentPreset);
      updateVoiceButton();
    });
  }
})();

</script>

<script>
(function(){
  // When running inside monolith, after RAW is loaded, reuse the indexhub helpers to render into our grids.
  const hasMonolithMounts = () => document.getElementById('apps-favorites');
  const oldRender = window.render;
  function renderMonolith(){
    if(!window.RAW || !hasMonolithMounts()) { oldRender && oldRender(); return; }
    // Build a flat list and groups as indexhub does
    const safe = (v)=> (v||'').toString();
    const groups = (window.RAW.groups && typeof window.RAW.groups==='object') ? window.RAW.groups : {};
    const all = Object.values(groups).flat().filter(Boolean);
    const favIds = new Set(JSON.parse(localStorage.getItem('infodose:favs')||'[]'));
    const favs = all.filter(a => favIds.has((a.key&&String(a.key))||String(a.url)));
    const $fav = document.getElementById('apps-favorites');
    const $rec = document.getElementById('apps-recents');
    const $wrap= document.getElementById('apps-groups-container');
    if($fav) $fav.innerHTML = favs.length ? '' : '<div class="muted">Sem favoritos ainda.</div>';
    if($rec) $rec.innerHTML = '<div class="muted">Sem recentes.</div>';
    if($wrap) $wrap.innerHTML='';

    function hCard(app){
      const c = document.createElement('div'); c.className='card';
      const ico = document.createElement('div'); ico.className='icon'; ico.innerHTML = app.icon?('<img src="'+app.icon+'" alt="">'):'<span>🧩</span>';
      const meta = document.createElement('div'); meta.style.flex='1';
      const t = document.createElement('div'); t.className='title-txt'; t.textContent = app.title||app.key||'App';
      const d = document.createElement('div'); d.className='muted'; d.textContent = app.desc||'';
      const row = document.createElement('div'); row.className='row';
      const favBtn = document.createElement('button'); favBtn.className='btn star'; favBtn.textContent='☆ Fav';
      const openBtn = document.createElement('button'); openBtn.className='btn'; openBtn.textContent='Abrir';
      const injBtn = document.createElement('button'); injBtn.className='btn'; injBtn.textContent='⎘ Injection';
      // fav state
      const k = (app.key&&String(app.key))||String(app.url);
      if(favIds.has(k)){ favBtn.classList.add('active'); favBtn.textContent='★ Fav'; }
      favBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); const S=new Set(JSON.parse(localStorage.getItem('infodose:favs')||'[]')); if(S.has(k))S.delete(k); else S.add(k); localStorage.setItem('infodose:favs', JSON.stringify([...S])); location.reload(); });
      openBtn.addEventListener('click', ()=>{ try{ window.open(app.url,'_blank','noopener'); }catch{} });
      injBtn.addEventListener('click', ()=>{ try{ navigator.clipboard.writeText('<!-- inj -->'); alert('Injection copiado!'); }catch{ alert('Falha ao copiar'); } });
      row.appendChild(favBtn); row.appendChild(openBtn); row.appendChild(injBtn);
      meta.appendChild(t); meta.appendChild(d); meta.appendChild(row);
      c.appendChild(ico); c.appendChild(meta);
      return c;
    }

    // Favorites
    if($fav && favs.length){ favs.slice(0,24).forEach(a => $fav.appendChild(hCard(a))); }

    // Groups
    const order = Object.keys(groups);
    for(const gk of order){
      const cap = document.createElement('div'); cap.className='section'; cap.textContent = gk.replace('_',' ').toUpperCase();
      const grid = document.createElement('div'); grid.className='grid';
      (groups[gk]||[]).forEach(a => grid.appendChild(hCard(a)));
      const wrap = document.createElement('div'); wrap.appendChild(cap); wrap.appendChild(grid);
      $wrap.appendChild(wrap);
    }
  }
  // Patch global render
  if(typeof window.render === 'function'){
    const old = window.render;
    window.render = function(){ try{ old(); }catch(e){} try{ renderMonolith(); }catch(e){} }
  }
})();
</script>

<!-- Trinity integration scripts: carregados após todo o conteúdo para evitar conflitos -->
<script src="./trinity-bridge.js"></script>
<script src="./monolith-boost.js"></script>

<!-- Trinity Tab + Arquétipo Sync (dedicado) -->
<script>
// Funções do painel Trinity: abrir Dual-App, Hubs, Finder e sync
(function(){
  function openTrinityViewer(url){
    const viewer=document.getElementById('trinity-viewer');
    const frame=document.getElementById('trinity-frame');
    if(viewer && frame){ frame.src=url; viewer.style.display='block'; }
  }
  // Fechar viewer
  const backBtn=document.getElementById('trinity-back');
  if(backBtn){ backBtn.addEventListener('click', ()=>{
    const viewer=document.getElementById('trinity-viewer');
    const frame=document.getElementById('trinity-frame');
    if(viewer && frame){ frame.src='about:blank'; viewer.style.display='none'; }
  }); }
  // Abrir Dual‑App acoplado
  const btnDual=document.getElementById('trinity-open-dual');
  if(btnDual){ btnDual.addEventListener('click', ()=> openTrinityViewer('./Dual_App_io100_0_base_improved_cleaned_Updated_noSplashPLAYER-0_FIX_TOGGLE_FETCH_0.html') ); }
  // Ping para testar handshake
  const btnPing=document.getElementById('trinity-ping-dual');
  if(btnPing){ btnPing.addEventListener('click', ()=>{
    try{ Trinity.pushToDualApp('ping — Trinity handshake'); if(window.chatBubble) chatBubble('▶ Dual-App acionado','ai'); }catch(e){ if(window.chatBubble) chatBubble('Falha Trinity','ai'); }
  }); }
  // Abrir Hubs (index.html V3.2)
  const btnHubs=document.getElementById('trinity-open-hubs');
  if(btnHubs){ btnHubs.addEventListener('click', ()=> openTrinityViewer('./index.html') ); }
  // Abrir Dual Finder (Umbotão)
  const btnFinder=document.getElementById('trinity-open-finder');
  if(btnFinder){ btnFinder.addEventListener('click', ()=> openTrinityViewer('./Umbotao-0.html') ); }
  // Sync Tema/TTS do Dual-App
  const btnSync=document.getElementById('trinity-sync-theme');
  if(btnSync){ btnSync.addEventListener('click', ()=>{
    try{ Trinity.syncFromDual(); if(window.chatBubble) chatBubble('Sincronizado com Dual-App','ai'); }catch(e){ if(window.chatBubble) chatBubble('Falha ao sincronizar','ai'); }
  }); }
  // Botão no header (Trinity tab) para abrir Hubs
  const hdrHubs=document.getElementById('trinity-btnOpenHubs');
  if(hdrHubs){ hdrHubs.addEventListener('click', ()=>{ openTrinityViewer('./index.html'); }); }
})();

// Escuta mensagens do Hub de Arquétipos para aplicar temas/vozes/manifests
(function(){
  window.addEventListener('message', function(ev){
    const m = ev.data || {};
    if(!m || !m.__TRINITY__) return;
    if(m.type === 'ARCH_MANIFEST'){
      try{
        // aplicar variáveis de tema
        const vars = m.data?.vars || {};
        Object.entries(vars).forEach(([k,v])=> document.documentElement.style.setProperty(k, v));
        // salvar arquétipo ativo
        if(m.data?.arch) localStorage.setItem('dual.theme.arch', m.data.arch);
        // preset de TTS
        if(m.data?.tts?.preset) localStorage.setItem('infodose:ttsPreset', m.data.tts.preset);
        // manifest dinâmico
        const link=document.querySelector('link[rel="manifest"]');
        if(link && m.data?.pwa?.manifest) link.setAttribute('href', m.data.pwa.manifest);
        // service worker (opcional)
        if('serviceWorker' in navigator && m.data?.pwa?.sw){ navigator.serviceWorker.register(m.data.pwa.sw).catch(()=>{}); }
        if(window.chatBubble) chatBubble(`Arquétipo ativo: ${m.data.arch || '—'}`,'ai', {arch:'Nova'});
      }catch(e){}
    }
  });
})();
</script>
<!-- Perfil & Brain sync: nome, chave e treinamento -->
<script>
// Sincroniza campos do Perfil e Brain (Nome, OpenRouter SK e Treinamento) via localStorage
(function(){
  const KEY_BRAIN='infodose:brain';
  const KEY_NAME='infodose:userName';
  const KEY_SK='infodose:userSK';
  function readBrain(){
    try{ return JSON.parse(localStorage.getItem(KEY_BRAIN)||'{}')||{}; }catch(e){ return {}; }
  }
  function writeBrain(obj){
    try{ localStorage.setItem(KEY_BRAIN, JSON.stringify(obj)); }catch(e){}
  }
  function syncFields(){
    const brain=readBrain();
    const nmVal=localStorage.getItem(KEY_NAME) || brain.userName || '';
    const nameField=document.getElementById('profile-name');
    if(nameField && nameField.value !== nmVal) nameField.value=nmVal;
    const skVal=brain.userSK || localStorage.getItem(KEY_SK) || '';
    ['brain-sk','profile-sk'].forEach(id=>{
      const el=document.getElementById(id);
      if(el && el.value !== skVal) el.value=skVal;
    });
    const trVal=brain.training || '';
    ['brain-training','profile-training'].forEach(id=>{
      const el=document.getElementById(id);
      if(el && el.value !== trVal) el.value=trVal;
    });
  }
  const saveNameBtn=document.getElementById('profile-saveName');
  if(saveNameBtn) saveNameBtn.addEventListener('click', ()=>{
    const val=(document.getElementById('profile-name')?.value||'').trim();
    if(!val) return;
    localStorage.setItem(KEY_NAME,val);
    const b=readBrain(); b.userName=val; writeBrain(b);
    syncFields();
  });
  function bindSaveSK(btnId, fieldId){
    const btn=document.getElementById(btnId);
    if(btn) btn.addEventListener('click', ()=>{
      const val=(document.getElementById(fieldId)?.value||'').trim();
      const b=readBrain(); b.userSK=val; writeBrain(b);
      localStorage.setItem(KEY_SK,val);
      syncFields();
    });
  }
  bindSaveSK('brain-saveSK','brain-sk');
  bindSaveSK('profile-saveSK','profile-sk');
  function bindSaveTraining(btnId, fieldId){
    const btn=document.getElementById(btnId);
    if(btn) btn.addEventListener('click', ()=>{
      const val=(document.getElementById(fieldId)?.value||'');
      const b=readBrain(); b.training=val; writeBrain(b);
      syncFields();
    });
  }
  bindSaveTraining('brain-saveTraining','brain-training');
  bindSaveTraining('profile-saveTraining','profile-training');
  window.addEventListener('storage', (e)=>{
    if([KEY_BRAIN,KEY_NAME,KEY_SK].includes(e.key)) syncFields();
  });
  document.addEventListener('DOMContentLoaded', syncFields);
  if(document.readyState !== 'loading') syncFields();
})();
</script>

<!-- Perfil: botões de colar SK, upload de treinamento TXT/JSON, avatar interativo e Dev Docs -->
<script>
(function(){
  // Botão de colar SK a partir da área de transferência
  async function pasteInto(id){
    try{
      const t = await navigator.clipboard.readText();
      const el = document.getElementById(id);
      if(el){ el.value = (t||'').trim(); }
    }catch{ alert('Não foi possível ler a área de transferência.'); }
  }
  const pasteBtn = document.getElementById('profile-pasteSK');
  if(pasteBtn){ pasteBtn.addEventListener('click', ()=> pasteInto('profile-sk')); }

  // Upload de arquivo de treinamento (.txt ou .json)
  const upBtn  = document.getElementById('profile-uploadTraining');
  const upFile = document.getElementById('profile-training-file');
  const txt    = document.getElementById('profile-training');
  function normalizeJsonTraining(obj){
    try{
      if(typeof obj === 'string') return obj;
      if(Array.isArray(obj)) return obj.join('\n\n');
      if(obj && typeof obj === 'object'){
        if(typeof obj.training === 'string') return obj.training;
        if(Array.isArray(obj.training)) return obj.training.join('\n\n');
      }
    }catch{}
    return '';
  }
  if(upBtn && upFile && txt){
    upBtn.addEventListener('click', ()=> upFile.click());
    upFile.addEventListener('change', ()=>{
      const f = (upFile.files||[])[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const raw = String(reader.result||'');
          if(/\.json$/i.test(f.name)){
            const obj = JSON.parse(raw);
            txt.value = normalizeJsonTraining(obj) || raw;
          } else {
            txt.value = raw;
          }
        }catch{ txt.value = String(reader.result||''); }
      };
      reader.readAsText(f);
      upFile.value='';
    });
  }

  // Avatar interativo: permite trocar foto e abrir painel Dev Docs
  const KEY_IMG='infodose:profile.avatarDataURL';
  const av   = document.getElementById('profile-avatar');
  const menu = document.getElementById('profile-avatar-menu');
  const file = document.getElementById('profile-avatar-file');
  if(av){
    const data = localStorage.getItem(KEY_IMG);
    if(data){ av.style.backgroundImage = `url(${data})`; av.style.backgroundSize='cover'; av.innerHTML=''; }
    av.addEventListener('click', ()=>{
      if(menu) menu.style.display = (menu.style.display==='none' || !menu.style.display) ? 'block' : 'none';
    });
  }
  document.getElementById('btn-change-photo')?.addEventListener('click', ()=> file?.click());
  if(file){ file.addEventListener('change', ()=>{
    const f=(file.files||[])[0]; if(!f) return;
    const r=new FileReader();
    r.onload=()=>{ localStorage.setItem(KEY_IMG, String(r.result||'')); location.reload(); };
    r.readAsDataURL(f);
  }); }

  // Painel Dev Docs: manipula localStorage e injeta CSS ao vivo
  document.getElementById('btn-devdocs')?.addEventListener('click', ()=>{
    let host=document.querySelector('.devdocs-panel');
    if(host){ host.remove(); return; }
    host=document.createElement('div'); host.className='devdocs-panel card';
    const ls = Object.keys(localStorage).sort().map(k=> `<div><b>${k}</b><br><code>${(localStorage.getItem(k)||'').replace(/[<&>]/g,s=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]))}</code></div>`).join('');
    host.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="label">Dev Docs</div>
        <button class="btn btn--sm btn--ghost" id="devdocs-close">✕</button>
      </div>
      <div class="grid">
        <div class="mini">
          <h4>localStorage</h4>
          <div style="display:flex; gap:6px; margin-bottom:8px">
            <input id="dev-k" class="input" placeholder="chave" style="flex:1">
            <input id="dev-v" class="input" placeholder="valor" style="flex:1">
            <button id="dev-set" class="btn btn--sm btn--accent">Set</button>
            <button id="dev-del" class="btn btn--sm btn--ghost">Del</button>
          </div>
          <div id="dev-ls">${ls || '<i>vazio</i>'}</div>
        </div>
        <div class="mini">
          <h4>CSS Injection</h4>
          <textarea id="dev-css" class="input" rows="10" placeholder="/* CSS ao vivo */"></textarea>
          <div class="row" style="margin-top:8px">
            <button id="dev-apply-css" class="btn btn--sm btn--prime">Aplicar</button>
            <button id="dev-clear-css" class="btn btn--sm btn--ghost">Limpar</button>
          </div>
        </div>
      </div>`;
    document.body.appendChild(host);
    const devLS = () => {
      const box=document.getElementById('dev-ls');
      const ls = Object.keys(localStorage).sort().map(k=> `<div><b>${k}</b><br><code>${(localStorage.getItem(k)||'').replace(/[<&>]/g,s=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]))}</code></div>`).join('');
      box.innerHTML = ls || '<i>vazio</i>';
    };
    document.getElementById('devdocs-close')?.addEventListener('click', ()=> host.remove());
    document.getElementById('dev-set')?.addEventListener('click', ()=>{
      const k=document.getElementById('dev-k').value.trim();
      const v=document.getElementById('dev-v').value;
      if(!k) return;
      localStorage.setItem(k,v);
      devLS();
    });
    document.getElementById('dev-del')?.addEventListener('click', ()=>{
      const k=document.getElementById('dev-k').value.trim();
      if(!k) return;
      localStorage.removeItem(k);
      devLS();
    });
    const STYLE_KEY='infodose:dev.css';
    const styleEl = document.createElement('style'); styleEl.id='__dev_css__';
    document.head.appendChild(styleEl);
    const applyCSS=()=>{ styleEl.textContent = document.getElementById('dev-css').value || ''; localStorage.setItem(STYLE_KEY, styleEl.textContent); };
    const clearCSS=()=>{ styleEl.textContent=''; document.getElementById('dev-css').value=''; localStorage.removeItem(STYLE_KEY); };
    document.getElementById('dev-apply-css').addEventListener('click', applyCSS);
    document.getElementById('dev-clear-css').addEventListener('click', clearCSS);
    const saved = localStorage.getItem(STYLE_KEY)||''; if(saved){ document.getElementById('dev-css').value=saved; applyCSS(); }
  });
})();
</script>
</body>
</html>