<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>HUB DUAL — UNO Dual Trinity</title>
<link rel="icon" href="icons/others/favicon.svg" type="image/svg+xml"/>
<meta name="theme-color" content="#0ff"/>
<style>
  :root{
    --bg1:#ff00ff; --bg2:#00ffff;
    --ink:#eaf6ff; --ink-dim:#cfe3ff; --ink-muted:#9bb3d1;
    --card:#130a22cc; --card-strong:#0d0818ee; --edge:#ffffff10;
    --glow: 0 10px 40px rgba(255,255,255,.15), 0 6px 22px rgba(0,255,255,.18);
    --radius:22px; --radius-sm:16px; --radius-xs:12px;
    --pad:14px; --pad-lg:18px; --pad-sm:10px;
    --h:56px; --f:64px;
    --accent:#7ee8ff; --accent2:#e49bff; --ok:#9affc6; --warn:#ffd36e; --bad:#ff7e9e;
    --blur: 14px;
    --shadow: 0 8px 22px rgba(0,0,0,.35);
    --ring: 0 0 0 1px var(--edge) inset, 0 0 22px rgba(0,0,0,.2) inset;
    --xs:12px; --sm:13px; --md:14.5px; --lg:16px; --xl:18px; --xxl:22px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font:400 var(--md)/1.45 ui-sans-serif,system-ui,Inter,Segoe UI,Roboto,Arial;
    color:var(--ink);
    background:
      radial-gradient(1200px 1200px at 20% -10%, #ff62ff22, transparent 60%),
      radial-gradient(1000px 900px at 120% 110%, #3df6ff22, transparent 60%),
      linear-gradient(42deg,var(--bg1),var(--bg2));
    background-attachment: fixed;
  }
  .glass{background:var(--card); backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur)); border:1px solid var(--edge)}
  header, footer{
    position:fixed; left:0; right:0; z-index:20;
    display:flex; align-items:center; gap:12px; padding:0 var(--pad);
    height:var(--h);
  }
  header{top:0; border-bottom:1px solid var(--edge); box-shadow: var(--glow)}
  footer{bottom:0; border-top:1px solid var(--edge); box-shadow: var(--glow)}
  .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.5px}
  .brand .spark{display:inline-flex; width:22px; height:22px; place-content:center; border-radius:50%;
    background:linear-gradient(42deg,var(--accent),var(--accent2)); box-shadow:0 0 24px rgba(127,255,255,.45)}
  .title{font-size:var(--xl)}
  .sub{font-size:var(--sm); color:var(--ink-muted); margin-top:-4px}
  .spacer{flex:1}
  .iconbtn{display:inline-grid; place-content:center; width:36px; height:36px; border-radius:12px; border:1px solid var(--edge);
    background:#0c0616a6; cursor:pointer; transition:transform .15s ease, background .2s}
  .iconbtn:active{transform:scale(.96)}
  .badge{min-width:18px; height:18px; border-radius:9px; padding:0 6px; display:inline-grid; place-content:center;
    background:linear-gradient(42deg,#6ff,#c9f); color:#002; font-weight:700; font-size:11px; margin-left:6px}
  main{padding: calc(var(--h) + 12px) var(--pad) calc(var(--f) + 12px)}
  .section{margin:14px 0}
  .row{display:flex; gap:12px; align-items:center}
  .grid{display:grid; gap:12px}
  @media (min-width:800px){ .grid.cols-2{grid-template-columns:1fr 1fr} .grid.cols-3{grid-template-columns:repeat(3,1fr)}}
  .card{border-radius:var(--radius); padding:var(--pad); box-shadow: var(--shadow); position:relative}
  .cardTitle{font-weight:700; font-size:var(--lg)}
  .muted{color:var(--ink-muted); font-size:var(--sm)}
  .chip{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; border:1px solid var(--edge);
    background:#0f0a1bba; font-size:var(--sm)}
  .appsList{display:grid; gap:10px}
  .appItem{display:flex; align-items:center; gap:12px; padding:10px; border-radius:15px; border:1px solid var(--edge); background:#0c0717b8}
  .appItem img,.appItem .ico{width:32px; height:32px; border-radius:8px; border:1px solid var(--edge); background:#090512}
  .appMeta{flex:1; min-width:0}
  .appMeta .t{font-weight:700; font-size:var(--md)}
  .appMeta .d{font-size:var(--sm); color:var(--ink-muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .appActions{display:flex; gap:8px}
  .btn{padding:8px 12px; border-radius:12px; border:1px solid var(--edge); background:#0a0614a6; color:var(--ink); font-size:var(--sm); cursor:pointer}
  .btn.pri{background:linear-gradient(42deg,#46ecffcc,#c796ffcc)}
  .btn.ghost{background:#090513; color:var(--ink-dim)}
  .btn.star[data-on="true"]{background:linear-gradient(42deg,#ffd36ecc,#ff8f6ecc); color:#320}
  /* Session blocks (opened apps) */
  .session{border-radius:22px; overflow:hidden; border:1px solid var(--edge); margin:16px 0; box-shadow:var(--shadow)}
  .sessionHeader{display:flex; align-items:center; gap:10px; padding:10px var(--pad); background:var(--card-strong)}
  .sessionTitle{font-weight:700}
  .sessionBar{display:flex; gap:8px; margin-left:auto}
  .sessionBtn{width:34px; height:34px; border-radius:10px; border:1px solid var(--edge); background:#0c0717b8; display:grid; place-content:center; cursor:pointer}
  .sessionBody{height:420px; background:#080512; border-top:1px solid var(--edge)}
  .sessionBody iframe{width:100%; height:100%; border:0}
  /* Footer */
  .dock{display:flex; align-items:center; gap:12px; width:100%}
  .dock .slot{display:flex; gap:8px; align-items:center}
  .dock .quick{flex:1; display:flex; gap:8px; overflow:auto; scrollbar-width:none}
  .dock .quick::-webkit-scrollbar{display:none}
  .mini{display:inline-flex; gap:8px; align-items:center; background:#0e0a18cc; border:1px solid var(--edge); border-radius:999px; padding:6px 10px}
  .mini .dot{width:9px; height:9px; border-radius:50%; background:linear-gradient(42deg,#7ff,#f9f); box-shadow:0 0 12px #7ff}
  .tooltip{position:absolute; inset:auto 12px 72px auto; min-width:240px}
  /* Brain menu (popover) */
  .popover{position:absolute; top:calc(var(--h) + 8px); right:12px; width:min(86vw,360px); border-radius:18px; padding:10px; z-index:40}
  .menuItem{display:flex; align-items:center; gap:10px; padding:10px; border-radius:12px; border:1px solid var(--edge); background:#0b0616cc; cursor:pointer}
  .menuItem + .menuItem{margin-top:8px}
  .menuItem small{color:var(--ink-muted); font-size:var(--sm)}
  .input{display:flex; gap:8px; align-items:center; background:#090513; border:1px solid var(--edge); border-radius:12px; padding:8px 10px}
  .input input,.input select{flex:1; background:transparent; border:0; outline:0; color:var(--ink); font-size:var(--sm)}
  .notice{font-size:var(--xs); color:var(--ink-muted); margin-top:6px}
  .ok{color:var(--ok)}
  .warn{color:var(--warn)}
  .divider{height:1px; background:var(--edge); margin:10px 0}
  /* Density switch (Perf) */
  [data-perf="low"] .sessionBody{height:360px}
  [data-perf="high"] .sessionBody{height:520px}
  /* Hide helpers */
  .hide{display:none !important}
  .fadeIn{animation:fade .25s ease}
  @keyframes fade{from{opacity:.0; transform:translateY(4px)} to{opacity:1; transform:none}}
  /* pixel-ish outline */
  .outline{box-shadow:var(--ring)}
  /* small helpers for inline SVGs */
  svg{display:block}
  .ico24{width:24px;height:24px}
  .ico18{width:18px;height:18px}
  .ico16{width:16px;height:16px}
</style>
</head>
<body>

<header class="glass">
  <div class="brand">
    <span class="spark"></span>
    <div>
      <div class="title">HUB DUAL</div>
      <div class="sub">UNO • Dual • Trinity</div>
    </div>
  </div>
  <div class="spacer"></div>

  <!-- Download current HTML -->
  <button class="iconbtn" id="btnDownload" title="Baixar HTML">
    <img alt="" width="20" height="20" src="icons/others/hub_download.svg" onerror="this.replaceWith(svgDL())"/>
  </button>

  <!-- Brain (perfil/keys/perf/tts/log) -->
  <button class="iconbtn" id="btnBrain" title="Brain & Perfil">
    <img alt="" width="20" height="20" src="icons/others/hub_config.svg" onerror="this.replaceWith(svgCog())"/>
  </button>
</header>

<main id="main" class="fadeIn">

  <!-- SESSÕES ATIVAS surgem aqui (prepend) -->
  <section id="sessionsAnchor"></section>

  <!-- HOME -->
  <section class="section">
    <div class="card glass outline">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="cardTitle">Home</div>
          <div class="muted">Abra apps empilhados, minimize e reabra pelo dock.</div>
        </div>
        <div class="chip">
          <img class="ico18" src="icons/others/hub_lightning.svg" onerror="this.replaceWith(svgBolt(18))" alt=""/>
          Nebula Pro
        </div>
      </div>

      <div id="favoritesWrap" class="section hide">
        <div class="row" style="margin-bottom:8px">
          <div class="cardTitle">Favoritos</div>
          <span class="muted">seus apps fixados</span>
        </div>
        <div id="favoritesList" class="appsList"></div>
      </div>

      <div class="divider"></div>

      <div id="groupsWrap" class="grid cols-2"></div>
    </div>
  </section>

  <!-- MINIMIZADOS -->
  <section class="section">
    <div class="card glass outline">
      <div class="row" style="justify-content:space-between">
        <div class="cardTitle">Minimizados</div>
        <span class="muted" id="miniCount">0</span>
      </div>
      <div id="miniWrap" class="row" style="flex-wrap:wrap; gap:8px"></div>
    </div>
  </section>

</main>

<footer class="glass">
  <nav class="dock">
    <div class="slot">
      <button class="iconbtn" id="btnHome" title="Home">
        <img alt="" width="20" height="20" src="icons/others/hub_home.svg" onerror="this.replaceWith(svgHome())"/>
      </button>
      <button class="iconbtn" id="btnApps" title="Apps">
        <img alt="" width="20" height="20" src="icons/others/hub_apps.svg" onerror="this.replaceWith(svgApps())"/>
      </button>
    </div>
    <!-- Badges de reabrir sessões -->
    <div class="quick" id="quickBadges"></div>
    <div class="slot">
      <button class="iconbtn" id="btnLogs" title="Logs">
        <img alt="" width="20" height="20" src="icons/others/hub_relatorio.svg" onerror="this.replaceWith(svgList())"/>
      </button>
    </div>
  </nav>
</footer>

<!-- Brain Popover -->
<div id="brain" class="popover glass outline hide fadeIn" role="dialog" aria-label="Dual Brain">
  <div class="menuItem" style="cursor:default">
    <img class="ico24" src="icons/others/hub_perfil.svg" onerror="this.replaceWith(svgUser())" alt=""/>
    <div style="flex:1">
      <div style="font-weight:700">Perfil</div>
      <div class="notice">Nome e rótulo do seu Dual</div>
    </div>
  </div>
  <div class="input" style="margin:8px 0">
    <input id="inpName" placeholder="Seu nome" autocomplete="name"/>
  </div>
  <div class="input">
    <input id="inpDual" placeholder="Nome do seu Dual Infodose"/>
  </div>

  <div class="divider"></div>

  <div class="menuItem" style="cursor:default">
    <img class="ico24" src="icons/others/hub_cloud.svg" onerror="this.replaceWith(svgKey())" alt=""/>
    <div style="flex:1">
      <div style="font-weight:700">Chave SK (OpenRouter)</div>
      <div class="notice">Guardada localmente (localStorage)</div>
    </div>
  </div>
  <div class="input">
    <input id="inpSK" placeholder="sk-..." autocomplete="off" />
    <button class="btn ghost" id="btnSaveSK">Salvar</button>
  </div>

  <div class="divider"></div>

  <div class="menuItem" style="cursor:default">
    <img class="ico24" src="icons/others/hub_health.svg" onerror="this.replaceWith(svgPerf())" alt=""/>
    <div style="flex:1">
      <div style="font-weight:700">Performance</div>
      <small id="perfLabel">Low / Med / High</small>
    </div>
  </div>
  <div class="input">
    <select id="selPerf">
      <option value="low">Low</option>
      <option value="med">Med</option>
      <option value="high">High</option>
    </select>
    <button class="btn ghost" id="btnPerf">Aplicar</button>
  </div>

  <div class="divider"></div>

  <div class="menuItem" style="cursor:default">
    <img class="ico24" src="icons/others/hub_bind.svg" onerror="this.replaceWith(svgVoice())" alt=""/>
    <div style="flex:1">
      <div style="font-weight:700">Vozes / TTS</div>
      <small>menu de vozes por arquétipo (placeholder)</small>
    </div>
  </div>
  <div class="input">
    <select id="selVoice">
      <option>Nova</option><option>Elysha</option><option>Kaion</option><option>Serena</option>
    </select>
    <button class="btn ghost" id="btnVoice">Salvar</button>
  </div>

  <div class="divider"></div>

  <div class="menuItem" id="btnClear">
    <img class="ico24" src="icons/others/hub_memoria.svg" onerror="this.replaceWith(svgTrash())" alt=""/>
    <div style="flex:1">
      <div style="font-weight:700">Limpar Memória</div>
      <small>apaga preferências e favoritos</small>
    </div>
  </div>

  <div class="divider"></div>

  <div class="menuItem" style="cursor:default">
    <img class="ico24" src="icons/others/hub_relatorio.svg" onerror="this.replaceWith(svgList())" alt=""/>
    <div style="flex:1">
      <div style="font-weight:700">Logs</div>
      <small>eventos recentes</small>
    </div>
  </div>
  <div class="card glass" style="max-height:120px; overflow:auto; margin-top:8px">
    <pre id="logs" style="white-space:pre-wrap; font-size:12px; margin:0; color:var(--ink-dim)"></pre>
  </div>
</div>

<script>
/* ---------- Inline SVG fallbacks (se faltar icons/others/*.svg) ---------- */
function svgWrap(svg){ const span=document.createElement('span'); span.innerHTML=svg.trim(); return span.firstChild }
function svgDL(s=20){return svgWrap(`<svg viewBox="0 0 24 24" width="${s}" height="${s}" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M12 3v12"/><path d="M8 11l4 4 4-4"/><rect x="4" y="19" width="16" height="2" rx="1" fill="currentColor"/></svg>`)}
function svgCog(s=20){return svgWrap(`<svg viewBox="0 0 24 24" width="${s}" height="${s}" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1 1 0 0 0 .2 1.1l.1.1-1.5 2.6-1.2-.5a8.1 8.1 0 0 1-1 .6l-.2 1.3H8.2l-.2-1.3a8.1 8.1 0 0 1-1-.6l-1.2.5-1.5-2.6.1-.1A1 1 0 0 0 4.6 15a8.8 8.8 0 0 1 0-2 1 1 0 0 0-.2-1.1l-.1-.1L5.8 9l1.2.5c.3-.2.6-.4 1-.6l.2-1.3h7.2l.2 1.3c.4.2.7.4 1 .6l1.2-.5 1.5 2.6-.1.1a1 1 0 0 0-.2 1.1 8.8 8.8 0 0 1 0 2z"/></svg>`)}
function svgHome(s=20){return svgWrap(`<svg viewBox="0 0 24 24" width="${s}" height="${s}" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M3 11L12 3l9 8"/><path d="M5 10v10h14V10"/></svg>`)}
function svgApps(s=20){return svgWrap(`<svg viewBox="0 0 24 24" width="${s}" height="${s}" fill="none" stroke="currentColor" stroke-width="1.6"><rect x="3" y="3" width="7" height="7" rx="2"/><rect x="14" y="3" width="7" height="7" rx="2"/><rect x="3" y="14" width="7" height="7" rx="2"/><rect x="14" y="14" width="7" height="7" rx="2"/></svg>`)}
function svgList(s=20){return svgWrap(`<svg viewBox="0 0 24 24" width="${s}" height="${s}" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M9 6h12M9 12h12M9 18h12"/><circle cx="4" cy="6" r="1.6"/><circle cx="4" cy="12" r="1.6"/><circle cx="4" cy="18" r="1.6"/></svg>`)}
function svgUser(s=24){return svgWrap(`<svg viewBox="0 0 24 24" width="${s}" height="${s}" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="12" cy="8" r="4"/><path d="M4 20a8 8 0 0 1 16 0"/></svg>`)}
function svgKey(s=24){return svgWrap(`<svg viewBox="0 0 24 24" width="${s}" height="${s}" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="8" cy="15" r="4"/><path d="M12 15h10l-2 2 2 2-2 2"/></svg>`)}
function svgPerf(s=24){return svgWrap(`<svg viewBox="0 0 24 24" width="${s}" height="${s}" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M4 19a8 8 0 1 1 16 0"/><path d="M12 12v4"/><path d="M7 12v2"/><path d="M17 12v3"/></svg>`)}
function svgVoice(s=24){return svgWrap(`<svg viewBox="0 0 24 24" width="${s}" height="${s}" fill="none" stroke="currentColor" stroke-width="1.6"><rect x="9" y="3" width="6" height="12" rx="3"/><path d="M5 10a7 7 0 0 0 14 0"/><path d="M12 17v4"/></svg>`)}
function svgTrash(s=24){return svgWrap(`<svg viewBox="0 0 24 24" width="${s}" height="${s}" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M3 6h18"/><path d="M8 6V4h8v2"/><rect x="6" y="6" width="12" height="14" rx="2"/></svg>`)}
function svgBolt(s=18){return svgWrap(`<svg viewBox="0 0 24 24" width="${s}" height="${s}" fill="currentColor"><path d="M13 3L4 14h6l-1 7 9-11h-6l1-7z"/></svg>`)}
/* ---------- State ---------- */
const $ = sel => document.querySelector(sel);
const appState = {
  sessions: [], // {id,key,title,url,icon,minimized:false}
  minimized: [],
  favorites: new Set(JSON.parse(localStorage.getItem('hub.favs')||'[]')),
  profile: JSON.parse(localStorage.getItem('hub.profile')||'{}'),
  perf: localStorage.getItem('hub.perf') || 'med',
  voice: localStorage.getItem('hub.voice') || 'Nova',
  sk: localStorage.getItem('hub.sk') || '',
  logs: []
};
document.documentElement.setAttribute('data-perf', appState.perf);
/* ---------- Log helper ---------- */
function log(msg){
  const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
  appState.logs.unshift(line);
  $('#logs').textContent = appState.logs.slice(0,50).join('\n');
}
/* ---------- Brain UI ---------- */
const brain = $('#brain');
$('#btnBrain').addEventListener('click', ()=>brain.classList.toggle('hide'));
document.addEventListener('click', (e)=>{
  if(!brain.contains(e.target) && !$('#btnBrain').contains(e.target)) brain.classList.add('hide');
});
function loadProfileUI(){
  $('#inpName').value = appState.profile.name || '';
  $('#inpDual').value = appState.profile.dual || '';
  $('#inpSK').value = appState.sk || '';
  $('#selPerf').value = appState.perf;
  $('#perfLabel').textContent = appState.perf.toUpperCase();
  $('#selVoice').value = appState.voice;
}
['inpName','inpDual'].forEach(id=>{
  $('#'+id).addEventListener('change', ()=>{
    appState.profile.name = $('#inpName').value.trim();
    appState.profile.dual = $('#inpDual').value.trim();
    localStorage.setItem('hub.profile', JSON.stringify(appState.profile));
    log('Perfil atualizado');
  });
});
$('#btnSaveSK').addEventListener('click', ()=>{
  appState.sk = $('#inpSK').value.trim();
  localStorage.setItem('hub.sk', appState.sk);
  log('SK salva (local)');
});
$('#btnPerf').addEventListener('click', ()=>{
  appState.perf = $('#selPerf').value;
  localStorage.setItem('hub.perf', appState.perf);
  document.documentElement.setAttribute('data-perf', appState.perf);
  $('#perfLabel').textContent = appState.perf.toUpperCase();
  log('Performance: '+appState.perf);
});
$('#btnVoice').addEventListener('click', ()=>{
  appState.voice = $('#selVoice').value;
  localStorage.setItem('hub.voice', appState.voice);
  log('Voz padrão: '+appState.voice);
});
$('#btnClear').addEventListener('click', ()=>{
  localStorage.removeItem('hub.favs');
  localStorage.removeItem('hub.profile');
  localStorage.removeItem('hub.perf');
  localStorage.removeItem('hub.voice');
  localStorage.removeItem('hub.sk');
  appState.favorites = new Set();
  loadProfileUI();
  renderFavorites();
  log('Memória limpa');
});
/* ---------- Download self ---------- */
$('#btnDownload').addEventListener('click', ()=>{
  fetch(location.href).then(r=>r.text()).then(txt=>{
    const blob = new Blob([txt], {type:'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'HUB_DUAL_UNO_Trinity.html';
    a.click();
    URL.revokeObjectURL(a.href);
    log('Download do HTML gerado');
  }).catch(()=>{
    // fallback: serializar DOM atual
    const blob = new Blob([document.documentElement.outerHTML], {type:'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'HUB_DUAL_UNO_Trinity_runtime.html';
    a.click();
    URL.revokeObjectURL(a.href);
    log('Download (fallback) do HTML em runtime');
  });
});
/* ---------- Render groups/apps from apps.json ---------- */
const groupsWrap = $('#groupsWrap');
const favoritesWrap = $('#favoritesWrap');
const favoritesList = $('#favoritesList');

async function loadApps(){
  try{
    const res = await fetch('./apps/apps.json', {cache:'no-store'});
    const data = await res.json();
    const groups = data.groups || {};
    groupsWrap.innerHTML = '';
    for(const [gname, items] of Object.entries(groups)){
      const groupCard = document.createElement('div');
      groupCard.className = 'card glass outline';
      groupCard.innerHTML = `
        <div class="row" style="justify-content:space-between; margin-bottom:6px">
          <div class="cardTitle">${labelize(gname)}</div>
          <span class="muted">${items.length} apps</span>
        </div>
        <div class="appsList"></div>`;
      const listEl = groupCard.querySelector('.appsList');
      items.forEach(app=>{
        const row = document.createElement('div');
        row.className = 'appItem';
        const iconSrc = app.icon || 'icons/others/hub_apps.svg';
        row.innerHTML = `
          <img alt="" onerror="this.replaceWith(svgApps(32))" src="${iconSrc}">
          <div class="appMeta">
            <div class="t">${app.title||app.key}</div>
            <div class="d" title="${app.desc||''}">${app.desc||''}</div>
          </div>
          <div class="appActions">
            <button class="btn star" title="Favoritar" data-key="${app.key}" data-on="${appState.favorites.has(app.key)}">★</button>
            <button class="btn ghost" title="Preview" onclick="openSession('${app.key}', '${escapeHtml(app.title||app.key)}', '${app.url||''}', '${iconSrc}')">Abrir</button>
          </div>`;
        listEl.appendChild(row);
      });
      groupsWrap.appendChild(groupCard);
    }
    renderFavorites();
    log('apps.json carregado');
  }catch(e){
    console.error(e);
    groupsWrap.innerHTML = `<div class="muted">Não foi possível carregar apps/apps.json</div>`;
    log('Falha ao carregar apps.json');
  }
}
function labelize(k){ return k.replaceAll('_',' ').replace(/\b\w/g, m=>m.toUpperCase()) }
function escapeHtml(s){return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;' }[m]))}
document.addEventListener('click', (e)=>{
  const starBtn = e.target.closest('.btn.star');
  if(!starBtn) return;
  const key = starBtn.dataset.key;
  const on = starBtn.getAttribute('data-on') === 'true';
  if(on){ appState.favorites.delete(key) } else { appState.favorites.add(key) }
  starBtn.setAttribute('data-on', String(!on));
  localStorage.setItem('hub.favs', JSON.stringify([...appState.favorites]));
  renderFavorites();
});
function renderFavorites(){
  favoritesList.innerHTML = '';
  const favs = [...appState.favorites];
  favoritesWrap.classList.toggle('hide', favs.length===0);
  if(!favs.length) return;
  // procure nos cards renderizados
  const all = groupsWrap.querySelectorAll('.appItem');
  favs.forEach(k=>{
    const row = [...all].find(r => r.querySelector('.btn.star')?.dataset.key === k);
    if(row){
      const clone = row.cloneNode(true);
      clone.querySelector('.btn.star').remove(); // não duplicar toggle aqui
      favoritesList.appendChild(clone);
    }
  });
}
/* ---------- Sessions (stacked) ---------- */
const sessionsAnchor = $('#sessionsAnchor');
const miniWrap = $('#miniWrap');
const miniCount = $('#miniCount');
const quickBadges = $('#quickBadges');

function openSession(key,title,url,icon){
  const id = 'S'+Date.now()+Math.random().toString(36).slice(2,6);
  const sess = {id,key,title,url,icon,minimized:false};
  appState.sessions.unshift(sess);
  const el = document.createElement('section');
  el.className = 'session glass fadeIn';
  el.id = id;
  el.innerHTML = `
    <div class="sessionHeader">
      <img class="ico16" src="${icon}" onerror="this.replaceWith(svgApps(16))" alt=""/>
      <div class="sessionTitle">${escapeHtml(title)}</div>
      <div class="sessionBar">
        <button class="sessionBtn" title="Minimizar" onclick="minimizeSession('${id}')">${icoMinus()}</button>
        <button class="sessionBtn" title="Fechar" onclick="closeSession('${id}')">${icoClose()}</button>
      </div>
    </div>
    <div class="sessionBody"><iframe src="${url}"></iframe></div>`;
  sessionsAnchor.prepend(el);
  addBadge(sess);
  log('Sessão aberta: '+title);
  window.scrollTo({top:0,behavior:'smooth'});
}
function minimizeSession(id){
  const sEl = document.getElementById(id);
  if(!sEl) return;
  sEl.classList.add('hide');
  const s = appState.sessions.find(x=>x.id===id);
  if(s){ s.minimized = true; addBadge(s) }
  renderMinimized();
  log('Sessão minimizada');
}
function closeSession(id){
  const sEl = document.getElementById(id);
  if(sEl) sEl.remove();
  appState.sessions = appState.sessions.filter(x=>x.id!==id);
  removeBadge(id);
  renderMinimized();
  log('Sessão fechada');
}
function addBadge(sess){
  if(quickBadges.querySelector(`[data-id="${sess.id}"]`)) return;
  const badge = document.createElement('button');
  badge.className = 'mini';
  badge.setAttribute('data-id', sess.id);
  badge.innerHTML = `<span class="dot"></span> <span class="muted" style="color:var(--ink)">${sess.title}</span>`;
  badge.addEventListener('click', ()=>restoreSession(sess.id));
  quickBadges.prepend(badge);
}
function removeBadge(id){
  quickBadges.querySelector(`[data-id="${id}"]`)?.remove();
}
function renderMinimized(){
  miniWrap.innerHTML='';
  const minimized = appState.sessions.filter(s=>s.minimized);
  minimized.forEach(s=>{
    const chip = document.createElement('button');
    chip.className='mini'; chip.innerHTML=`<span class="dot"></span> ${s.title}`;
    chip.addEventListener('click',()=>restoreSession(s.id));
    miniWrap.appendChild(chip);
  });
  miniCount.textContent = minimized.length;
}
function restoreSession(id){
  const sEl = document.getElementById(id);
  if(!sEl) return;
  sEl.classList.remove('hide');
  const s = appState.sessions.find(x=>x.id===id);
  if(s){ s.minimized=false }
  renderMinimized();
  log('Sessão reaberta');
}
/* ---------- Simple icons for session buttons ---------- */
function icoMinus(){return `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M5 12h14"/></svg>`}
function icoClose(){return `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M6 6l12 12M18 6L6 18"/></svg>`}
/* ---------- Footer buttons ---------- */
$('#btnHome').addEventListener('click', ()=>window.scrollTo({top: sessionsAnchor.offsetTop + 1, behavior:'smooth'}));
$('#btnApps').addEventListener('click', ()=>{
  const y = groupsWrap.getBoundingClientRect().top + window.scrollY - 88;
  window.scrollTo({top:y,behavior:'smooth'});
});
$('#btnLogs').addEventListener('click', ()=>{
  brain.classList.remove('hide');
  brain.scrollIntoView({behavior:'smooth', block:'nearest'});
});
/* ---------- Init ---------- */
loadProfileUI();
loadApps();
log('Hub iniciado');
</script>
</body>
</html>
