<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<link rel="manifest" href="./manifest.json"/>
<title>Hub Dual — Nebula Pro (Expandido)</title>
<style>
:root{
  --grad-a:#ff52e5; --grad-b:#00c5e5;
  --text:#f5f7ff; --muted:rgba(245,247,255,.75);
  --surface:rgba(15,17,32,.45); --surface-strong:rgba(15,17,32,.88);
  --border:1px solid rgba(255,255,255,.12);
  --r:22px; --r-lg:28px; --shadow:0 10px 30px rgba(0,0,0,.35);
  --gold:#F2C75C;
}
*{box-sizing:border-box;min-width:0}
html,body{height:100%;margin:0}
body{
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  background:linear-gradient(42deg,var(--grad-a),var(--grad-b)) fixed;
  color:var(--text); overflow-x:hidden; -webkit-text-size-adjust:100%;
}
a{color:#7fd}
.mast{position:fixed;inset:env(safe-area-inset-top,0) 0 auto 0;height:76px;
  display:flex;align-items:center;gap:12px;padding:0 14px;z-index:100;
  backdrop-filter:blur(16px) saturate(120%)}
.title{flex:1;text-align:center;line-height:1.1}
.title h1{margin:0;font-size:20px;font-weight:900;letter-spacing:.06em}
.title small{display:block;font-size:12px;letter-spacing:.08em;color:var(--muted)}
.icon-btn{width:40px;height:40px;border-radius:50%;display:grid;place-items:center;
  background:var(--surface);border:var(--border);box-shadow:var(--shadow);color:var(--text);cursor:pointer}
main{padding:92px 16px 100px;max-width:860px;margin:0 auto}
footer.tabbar{position:fixed;inset:auto 0 env(safe-area-inset-bottom,0) 0;height:80px;display:flex;align-items:center;justify-content:center}
footer .container{width:100%;max-width:520px;background:var(--surface);border:var(--border);border-radius:var(--r-lg);box-shadow:var(--shadow);display:flex;justify-content:space-around;align-items:center;padding:10px 16px}
footer .tab{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;color:var(--muted);font-size:11px;font-weight:800;cursor:pointer;padding:6px;border-radius:14px}
footer .tab.active{color:var(--text);background:rgba(255,255,255,.08)}
.card{background:var(--surface);border:var(--border);border-radius:var(--r);box-shadow:var(--shadow);padding:16px}
.btn{appearance:none;border:var(--border);background:linear-gradient(42deg,var(--grad-a),var(--grad-b));
  color:#fff;border-radius:999px;padding:.72rem 1.05rem;font-weight:900;cursor:pointer}
.badge{padding:.3rem .6rem;border:var(--border);border-radius:999px}
.loader{--size:52px;position:relative;width:var(--size);height:var(--size)}
.loader .ring{position:absolute;inset:0;border:2px solid var(--gold);border-radius:50%;animation:spin 6s linear infinite}
.loader .bar{position:absolute;left:50%;top:50%;width:62%;height:2px;background:var(--gold);
  transform:translate(-50%,-50%);border-radius:999px;animation:breathe 2.4s ease-in-out infinite}
@keyframes spin{to{transform:rotate(360deg)}}@keyframes breathe{0%,100%{opacity:.9}50%{opacity:1}}
</style>
</head>
<body>
<header class="mast">
  <button class="icon-btn" id="backBtn" aria-label="Voltar">⟵</button>
  <div class="title"><h1>HUB DUAL</h1><small>UNO • DUAL • TRINITY</small></div>
  <button class="icon-btn" id="brainBtn" title="Dual Brain">◐</button>
</header>

<main>
  <section class="card">
    <h2 style="margin:0 0 8px;font-size:18px">Launcher</h2>
    <p style="margin:0 0 12px;color:var(--muted)">Carrega os apps de <code>./apps/apps.json</code> e também apps locais enviados.</p>
    <div id="appsGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:12px"></div>
  </section>

  <section class="card" style="margin-top:16px">
    <h2 style="margin:0 0 8px;font-size:18px">Stack</h2>
    <div id="stackList" style="display:flex;flex-direction:column;gap:10px"></div>
  </section>
</main>

<footer class="tabbar">
  <div class="container">
    <div class="tab active"><span>Home</span></div>
    <div class="tab" onclick="location.href='chat.html'"><span>Chat</span></div>
    <div class="tab" onclick="location.href='editor.html'"><span>Editor</span></div>
  </div>
</footer>

<div id="dualLoader" style="position:fixed;inset:0;display:none;place-items:center;z-index:9999;background:rgba(10,13,31,.66);backdrop-filter:blur(6px)">
  <span class="loader"><span class="ring"></span><span class="bar"></span></span>
</div>

<script>
const LS={};
LS.get=(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch(e){return d}};
LS.set=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch(e){}};
LS.raw=(k)=>localStorage.getItem(k)||'';

const appsGrid=document.getElementById('appsGrid');
const stackList=document.getElementById('stackList');
function dualShowLoader(){document.getElementById('dualLoader').style.display='grid'}
function dualHideLoader(){document.getElementById('dualLoader').style.display='none'}

const iconCache=new Map();
function normKey(s){return (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9_-]+/g,'_').replace(/_+/g,'_').replace(/^_|_$/g,'')}
async function getIconNode(app){
  if(app.icon && /\.(png|jpg|jpeg|gif|webp|svg)$/i.test(app.icon)){
    const d=document.createElement('div'); d.style.cssText='display:grid;place-items:center;height:52px';
    const img=new Image(); img.src=app.icon; img.alt=app.name||'app'; img.style.width='32px'; img.style.height='32px';
    d.appendChild(img); return d;
  }
  const key=normKey(app.iconKey||app.key||app.id||app.title||app.name||'app');
  const path=`./icons/others/${key}.svg`;
  try{
    const cacheKey='svg:'+path;
    if(iconCache.has(cacheKey)){const d=document.createElement('div'); d.innerHTML=iconCache.get(cacheKey); return d}
    const res=await fetch(path); if(res.ok){const svg=await res.text(); iconCache.set(cacheKey,svg); const d=document.createElement('div'); d.innerHTML=svg; return d;}
  }catch(e){}
  const d=document.createElement('div'); d.textContent='◇'; return d;
}

function readStack(){return LS.get('dual.stack',[])}
function writeStack(v){LS.set('dual.stack',v)}
function addToStack(app,opts={}){
  const st=readStack(); const i=st.findIndex(s=>s.id===app.id);
  const item={id:app.id,title:app.name,url:app.url,minimized:!!opts.minimized,mode:opts.mode||'embed',t:Date.now()};
  if(i>=0) st[i]=item; else st.unshift(item);
  writeStack(st); renderStack();
}
function setMinimized(id,val){const st=readStack(); const i=st.findIndex(s=>s.id===id); if(i>=0){st[i].minimized=!!val;writeStack(st);renderStack()}}
function removeFromStack(id){writeStack(readStack().filter(s=>s.id!==id)); renderStack()}

function renderStack(){
  const st=readStack(); stackList.innerHTML='';
  if(!st.length){stackList.innerHTML='<div class="badge" style="opacity:.8">Stack vazio</div>'; return;}
  st.forEach(s=>{
    const row=document.createElement('div'); row.className='card';
    row.innerHTML=`<div style="display:flex;gap:10px;align-items:center;justify-content:space-between">
      <div style="font-weight:900">${s.title}</div>
      <div style="display:flex;gap:8px">
        <button class="btn" style="padding:.45rem .8rem" onclick="window.location.href='${s.url}'">Abrir</button>
        <button class="btn" style="padding:.45rem .8rem" onclick="setMinimized('${s.id}',true)">Min</button>
        <button class="btn" style="padding:.45rem .8rem" onclick="removeFromStack('${s.id}')">Fechar</button>
      </div>
    </div>`;
    if(s.minimized){const b=document.createElement('div'); b.className='badge'; b.textContent='Minimized'; row.appendChild(b)}
    stackList.appendChild(row);
  });
}

function openApp(app){
  const mode = LS.get('dual.app.openMode.'+app.id, app.defaultOpenMode||'embed');
  if(mode==='tab'){ window.open(app.url,'_blank','noopener,noreferrer'); addToStack(app,{minimized:false,mode:'tab'}); return; }
  addToStack(app,{minimized:false,mode:'embed'});
  window.location.href = app.url;
}

function normalizeApps(data){
  if(Array.isArray(data)) return data.map(x=>({id:x.id||x.key||normKey(x.title||x.name), name:x.name||x.title||x.key, url:x.url, iconKey:x.iconKey, icon:x.icon, defaultOpenMode:x.defaultOpenMode||'embed'}));
  if(data && data.groups){
    const out=[]; for(const g of Object.keys(data.groups)){ for(const app of (data.groups[g]||[])){
      out.push({id:app.key||app.id||normKey(app.title||app.name), name:app.title||app.name||app.key, url:app.url, iconKey:app.iconKey||app.key, icon:app.icon, defaultOpenMode:app.defaultOpenMode||'embed'});
    }}
    return out;
  }
  return [];
}

async function readApps(){
  const override=LS.raw('dual.apps.override');
  if(override){ try{ const data=JSON.parse(override); return normalizeApps(data) }catch(e){} }
  try{
    dualShowLoader();
    const res=await fetch('./apps/apps.json',{cache:'no-store'});
    const data=await res.json(); return normalizeApps(data);
  }catch(e){
    return normalizeApps([
      {id:'chat',name:'Chat',url:'chat.html',iconKey:'hub_chat'},
      {id:'editor',name:'Editor',url:'editor.html',iconKey:'hub_editor'},
      {id:'books',name:'Books',url:'books.html',iconKey:'hub_books'},
      {id:'player',name:'KOBLOX',url:'player.html',iconKey:'hub_player'}
    ]);
  } finally { dualHideLoader(); }
}

async function renderApps(){
  const apps=await readApps();
  appsGrid.innerHTML='';
  for(const app of apps){
    const tile=document.createElement('div'); tile.className='card'; tile.style.textAlign='center';
    const iconNode=await getIconNode(app); iconNode.style.margin='10px auto'; tile.appendChild(iconNode);
    const name=document.createElement('div'); name.textContent=app.name; name.style.fontWeight='900'; tile.appendChild(name);
    const btn=document.createElement('button'); btn.className='btn'; btn.textContent='Abrir'; btn.onclick=()=>openApp(app); btn.style.marginTop='8px'; tile.appendChild(btn);
    appsGrid.appendChild(tile);
  }
}
document.getElementById('backBtn').onclick=()=>history.back();
document.getElementById('brainBtn').onclick=()=>alert('Brain: defina SK e Modelo via Hub PERFECT/Chat (localStorage).');
if('serviceWorker' in navigator){ try{ navigator.serviceWorker.register('./service-worker.js') }catch(e){} }
renderApps(); renderStack();
</script>
</body></html>
