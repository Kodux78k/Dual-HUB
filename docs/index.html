<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>DUAL.InfodoseüîòHUB ‚Äî BASE</title>
<meta name="theme-color" content="#0b0b0b">
<style>
  :root{ --bg:#0b0b0b; --fg:#fff; --muted:#b9c7cf; --acc:#E7C65A; --stroke:rgba(255,235,180,.20); --stroke-soft:rgba(255,235,180,.12); --blur:22px; --dock-space:84px; --maxw:980px; }
  html,body{height:100%;margin:0} html{background:var(--bg)}
  body{background:var(--bg);color:var(--fg);font-family:ui-rounded,system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial;min-height:100vh;min-height:100svh}
  .header{position:sticky;top:0;z-index:10;backdrop-filter:blur(var(--blur)) saturate(150%);background:rgba(0,0,0,.45);border-bottom:1px solid var(--stroke);box-shadow:0 12px 34px rgba(0,0,0,.42);padding-top:env(safe-area-inset-top)}
  .inner{max-width:var(--maxw);margin:0 auto;padding:14px;display:flex;gap:14px;align-items:center}
  .logo{width:46px;height:46px;border-radius:50%;display:grid;place-items:center;position:relative;background:rgba(0,0,0,.25)}
  .ring{position:absolute;inset:0;border:2px solid var(--acc);border-radius:50%;animation:spin 6s linear infinite}
  .bar{position:absolute;left:50%;top:50%;width:60%;height:2px;background:var(--acc);transform:translate(-50%,-50%);border-radius:999px;animation:breathe 2.4s ease-in-out infinite}
  @keyframes spin{to{transform:rotate(360deg)}} @keyframes breathe{0%,100%{opacity:.8}50%{opacity:1}}
  h1{font-size:1.16rem;margin:.12rem 0 0;font-weight:800}.kicker{font-size:.72rem;letter-spacing:.16em;color:#e0e0e0;text-transform:uppercase}

  .toolbar{max-width:var(--maxw);margin:10px auto 0;padding:0 14px 8px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{border:1px solid var(--stroke-soft);border-radius:999px;padding:.5rem .8rem;background:rgba(255,255,255,.04);font-weight:700;display:flex;gap:.45rem;align-items:center}
  .input{flex:1;min-width:180px;border:1px solid var(--stroke-soft);border-radius:999px;padding:.6rem .9rem;background:rgba(255,255,255,.06);color:#fff;outline:none}
  .select{border:1px solid var(--stroke-soft);border-radius:999px;padding:.56rem .9rem;background:rgba(255,255,255,.06);color:#fff}
  /* Viewer status */
  .status-dot{width:10px;height:10px;border-radius:999px;background:#597092;box-shadow:0 0 0 0 rgba(41,211,255,.0);transition:all .25s}
  .status-active .status-dot{background:#29d3ff;box-shadow:0 0 18px 2px rgba(41,211,255,.55)}
  .status-label{opacity:.85}

  .section{max-width:var(--maxw);margin:14px auto 6px;padding:0 14px}
  .section h2{font-size:.92rem;letter-spacing:.12em;text-transform:uppercase;color:#e6e6e6;margin:14px 0 8px;opacity:.9}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px}
  @media(max-width:560px){.grid{grid-template-columns:1fr}}
  .card{background:rgba(0,0,0,.32);border:1px solid var(--stroke-soft);border-radius:18px;padding:12px;display:flex;gap:12px;align-items:center;box-shadow:0 6px 18px rgba(0,0,0,.45);position:relative}
  .icon{width:56px;height:56px;border-radius:14px;display:grid;place-items:center;overflow:hidden;background:#0f1320;border:1px solid var(--stroke-soft);position:relative}
  .icon img{width:100%;height:100%;object-fit:cover;display:block}
  .icon .fav-dot{position:absolute;top:6px;right:6px;width:8px;height:8px;border-radius:999px;background:#ffd86a;box-shadow:0 0 8px rgba(255,216,106,.8)}
  .title{font-weight:800;margin-bottom:4px;display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .badges{display:flex;gap:6px;flex-wrap:wrap}
  .badge{font-size:.72rem;padding:.16rem .5rem;border-radius:999px;border:1px solid var(--stroke-soft);background:rgba(255,255,255,.06);color:#eaf6ff}
  .muted{color:var(--muted);font-size:.86rem}
  .row{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid var(--stroke-soft);cursor:pointer;background:rgba(255,255,255,.06);color:#fff;padding:.64rem .9rem;border-radius:999px;font-weight:800}
  .btn.star.active{background:rgba(231,198,90,.18);border-color:rgba(231,198,90,.5);color:#ffd86a}

  .dock{position:fixed;left:0;right:0;bottom:0;z-index:30;display:block}
  .dock-inner{max-width:var(--maxw);margin:0 auto;padding:8px 10px calc(8px + env(safe-area-inset-bottom));display:flex;gap:8px;justify-content:space-between;align-items:center;backdrop-filter:blur(18px) saturate(140%);background:rgba(0,0,0,.50);border-top:1px solid var(--stroke);box-shadow:0 -10px 30px rgba(0,0,0,.45)}
  .dbtn{appearance:none;border:1px solid var(--stroke);background:rgba(255,255,255,.06);color:#fff;padding:.64rem .9rem;border-radius:12px;font-weight:700}
  footer{color:#fff;font-size:.8rem;text-align:center;margin:18px 0 calc(18px + var(--dock-space));opacity:.9}
  .spacer{height:calc(var(--dock-space) + env(safe-area-inset-bottom) + 8px)}

  .viewer{position:fixed;inset:0;z-index:50;background:#000;touch-action:pan-y}
  .viewer iframe{position:absolute;inset:0 0 60px 0;border:0;width:100%;height:calc(100% - 60px)}
  .viewer-footer{position:fixed;left:0;right:0;bottom:0;height:60px;display:flex;gap:8px;align-items:center;justify-content:center;padding:8px 10px calc(8px + env(safe-area-inset-bottom));backdrop-filter:blur(18px) saturate(140%);background:rgba(0,0,0,.65);border-top:1px solid var(--stroke)}
  .swipe-hint{position:absolute;top:8px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);color:#fff;padding:.35rem .6rem;border-radius:999px;font-weight:800;opacity:.95;transition:opacity .4s}
  .swipe-hint.hide{opacity:0}

  .help-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(6px);z-index:60;opacity:0;pointer-events:none;transition:opacity .2s}
  .help-backdrop.show{opacity:1;pointer-events:auto}
  .help-sheet{position:fixed;left:50%;bottom:0;transform:translate(-50%, 8px);width:min(720px, calc(100vw - 24px));max-height:70vh;overflow:auto;background:rgba(20,20,24,.98);color:#eaf6ff;border:1px solid var(--stroke);border-radius:16px 16px 12px 12px;box-shadow:0 18px 60px rgba(0,0,0,.55);padding:14px;z-index:61;opacity:0;transition:opacity .2s, transform .2s}
  .help-backdrop.show .help-sheet{opacity:1;transform:translate(-50%, -8px)}
  .help-sheet h3{margin:.2rem 0 .6rem;font-size:1rem}
  .help-sheet .row{display:flex;gap:8px;flex-wrap:wrap;margin:.4rem 0}
  .help-chip{border:1px solid var(--stroke-soft);background:rgba(255,255,255,.04);padding:.4rem .6rem;border-radius:999px;font-weight:700}
  .help-close{float:right;appearance:none;border:1px solid var(--stroke);background:rgba(255,255,255,.06);color:#fff;padding:.5rem .75rem;border-radius:10px;font-weight:800}
  .help-list{margin:.4rem 0 .2rem;padding-left:1.1rem}
  .help-list li{margin:.28rem 0}
</style>
</head>
<body>
<header class="header">
  <div class="inner">
    <span class="logo" aria-hidden="true"><span class="ring"></span><span class="bar"></span></span>
    <div style="flex:1">
      <div class="kicker">Infodose ‚Ä¢ Hub Principal</div>
      <h1>Infodose Hub Ultra</h1>
    </div>
    <nav aria-label="A√ß√µes">
      <button class="pill" id="btnDownloadLoader" type="button">‚§ì Baixar Loader</button>
    </nav>
  </div>
</header>

<div class="toolbar">
  <input id="search" class="input" type="search" placeholder="Buscar e filtrar por nome, url, tag‚Ä¶" autocomplete="off"/>
  <select id="sort" class="select" title="Ordena√ß√£o">
    <option value="group">Ordenar por grupos</option>
    <option value="az">A ‚Üí Z</option>
    <option value="za">Z ‚Üí A</option>
  </select>

  <!-- Abrir na mesma aba (viewer) -->
  <label class="pill" title="Quando marcado, abre no overlay (viewer)">
    <input id="sameTab" type="checkbox" style="accent-color:#29d3ff" checked> üîò
  </label>

  <!-- Status do Viewer (Simbiose/Pulse) -->
  <button id="viewerStatus" class="pill" type="button" title="Mostra o estado do overlay">
    <span class="status-dot" aria-hidden="true"></span>
    <span class="status-label">Simbiose desconectada</span>
  </button>

  <!-- Perfil -->
  <button id="profileBtn" class="pill" type="button"><span id="profileText">Usu√°rio ‚Ä¢ Assistente</span></button>

  <!-- Ajuda -->
  <button id="helpBtn" class="pill" type="button">?</button>

  <div class="pill" id="countApps">Carregando‚Ä¶</div>
</div>

<main id="content"></main>
<footer>DualInfodose ‚Ä¢ HUB</footer>

<div class="dock" role="navigation" aria-label="Dock">
  <div class="dock-inner">
    <button class="dbtn" id="dockHome" type="button">üèòÔ∏è</button>
    <button class="dbtn" id="dockInfodose" type="button">üíä</button>
    <button class="dbtn" id="dockInstall" type="button">‚§ì ü¶† ‚§ì</button>
  </div>
</div>

<!-- Help -->
<div id="helpBackdrop" class="help-backdrop" aria-hidden="true">
  <div class="help-sheet" role="dialog" aria-modal="true" aria-label="Ajuda do Hub">
    <button class="help-close" id="helpClose">Fechar</button>
    <h3>Ajuda do Hub Dual.Infodose</h3>
    <div class="row">
      <span class="help-chip">üîµ Viewer / Simbiose</span>
      <span class="help-chip">‚≠ê Favoritos</span>
      <span class="help-chip">üë§ Perfil</span>
      <span class="help-chip">‚§ì Loader</span>
      <span class="help-chip">‚éò / ‚§ì Injection</span>
    </div>
    <ul class="help-list">
      <li><b>üîµ Viewer</b>: luz azul = <i>Simbiose conectada</i> (overlay aberto). Toque para alternar r√≥tulo <i>Simbiose‚ÜîPulse</i>.</li>
      <li><b>Swipe-down</b>: arraste ‚âà48px para fechar (hint por 2s).</li>
      <li><b>‚≠ê Favoritos</b>: ‚Äú‚òÖ/‚òÜ Fav‚Äù no card (um ‚Äú‚óè‚Äù marca no √≠cone).</li>
      <li><b>‚§ì Loader</b> & <b>‚éò/‚§ì Injection</b>: gerar loader; copiar/baixar HTML com barra ‚ÄúVoltar ao Hub‚Äù.</li>
      <li><b>Auto-open</b>: `?view=KEY`, `#view=arquivo.html`, `"open": true` no `apps.json`, ou reabre o √∫ltimo app.</li>
    </ul>
  </div>
</div>

<script>
const $=(q,root=document)=>root.querySelector(q);
const $content=$('#content'),$count=$('#countApps'),$search=$('#search'),$sort=$('#sort');
const $sameTab=$('#sameTab'),$viewerStatus=$('#viewerStatus'),$profileBtn=$('#profileBtn'),$profileText=$('#profileText');
const $helpBtn=$('#helpBtn'),$helpBackdrop=$('#helpBackdrop'),$helpClose=$('#helpClose');
let VIEWER_OPEN=false;

/* Perfil */
function loadProfile(){const u=localStorage.getItem('infodose:userName')||'Usu√°rio',a=localStorage.getItem('infodose:assistantName')||'Assistente';$profileText.textContent=`${u} ‚Ä¢ ${a}`;}
function editProfile(){const u0=localStorage.getItem('infodose:userName')||'',a0=localStorage.getItem('infodose:assistantName')||'';const u=prompt('Seu nome (Usu√°rio):',u0)??u0;const a=prompt('Nome do Assistente:',a0)??a0;try{localStorage.setItem('infodose:userName',u||'Usu√°rio');localStorage.setItem('infodose:assistantName',a||'Assistente');}catch{}loadProfile();}

/* Status Simbiose/Pulse */
function getStatusMode(){return localStorage.getItem('infodose:statusLabelMode')||'Simbiose';}
function toggleStatusMode(){const nxt=getStatusMode()==='Simbiose'?'Pulse':'Simbiose';try{localStorage.setItem('infodose:statusLabelMode',nxt);}catch{}updateViewerStatus();}
function updateViewerStatus(){const mode=getStatusMode();const on=VIEWER_OPEN&&$sameTab.checked;$viewerStatus.classList.toggle('status-active',on);$viewerStatus.querySelector('.status-label').textContent=on?`${mode} conectada`:`${mode} desconectada`;}

/* Favoritos */
function appKey(app){return (app.key&&String(app.key))||String(app.url);}
function loadFavs(){try{return new Set(JSON.parse(localStorage.getItem('infodose:favs')||'[]'));}catch{return new Set();}}
function saveFavs(s){try{localStorage.setItem('infodose:favs',JSON.stringify([...s]));}catch{}}
const FAVS=loadFavs();function isFav(app){return FAVS.has(appKey(app));}
function toggleFav(app){const k=appKey(app);FAVS.has(k)?FAVS.delete(k):FAVS.add(k);saveFavs(FAVS);render();}

/* √çcones fallback */
const FALLBACK_ICONS={base:'icons/icon-192.png',chats:'icons/icon-192-chats.png',editors:'icons/icon-192-editors.png',indexrs:'icons/icon-192-indexrs.png'};

/* Grupos/Regras */
const GROUP_TITLES={favorites:'Favoritos',index_hubs:'Index / Hubs',chats:'Chats / Render',editors_tools:'Editors & Tools',menus:'Menus',tutorials:'Tutoriais',visual_splash:'Visual / Splash',docs:'Docs',players:'Players',others:'Outros'};
const TAG_PRIORITIES={index_hubs:['hub','index','nebula','metalux','sumbus','s√ºmb√ºs','barra','barrao'],chats:['chat','render','response','kobllux','autoload'],editors_tools:['editor','edit','labs','xml','conv','converter','kblx','sigma','metalux','apps.json'],menus:['menu'],tutorials:['tutorial','ativacoes','ativa√ß√£o','v7','guia'],visual_splash:['splash','visual'],docs:['book','oidual','doc','.txt'],players:['player','audio','tts']};
const REGEX_RULES=[{key:'index_hubs',rx:/(index|hub|nebula|metalux|s[√ºu]mb[√ºu]s|barrao)/i},{key:'chats',rx:/(chat|render[-_ ]?response|autoload|kobllux)/i},{key:'editors_tools',rx:/(editor|labs|xml|conv|converter|apps\.json|kblx|sigma|metalux)/i},{key:'menus',rx:/(^|[-_ ])menu([-_ ]|$)/i},{key:'tutorials',rx:/(tutorial|ativa[c√ß][o√µ]es|v7\b)/i},{key:'visual_splash',rx:/splash/i},{key:'docs',rx:/(book|oidual|\.txt\b)/i},{key:'players',rx:/(player|audio|tts)/i}];

/* helpers */
function safe(v){return (v||'').toString();}
function lastFile(url){try{const u=new URL(url,location.href);return (u.pathname.split('/').pop()||'').toLowerCase();}catch{return (url||'').split('/').pop()?.toLowerCase()||'';}}
function folderHint(url){try{const u=new URL(url,location.href);const p=u.pathname.split('/').filter(Boolean);const i=p.indexOf('apps');if(i>=0&&p[i+1])return p[i+1].toLowerCase();}catch{}return '';}
function sourceString(app){return [app.key,app.title,app.desc,app.url].map(safe).join(' ').toLowerCase()+' '+lastFile(app.url);}
function classify(app){
  if(app.group&&GROUP_TITLES[app.group]) return app.group;
  if(Array.isArray(app.tags)){const t=app.tags.map(x=>safe(x).toLowerCase());for(const[g,list] of Object.entries(TAG_PRIORITIES)){if(list.some(v=>t.includes(v))) return g;}}
  const f=folderHint(app.url); if(f){ if(/(hub|index|nebula|metalux|s[√ºu]mb[√ºu]s|bar)/i.test(f)) return 'index_hubs';
    if(/(chat|render|resp|kobllux|auto)/i.test(f)) return 'chats';
    if(/(edit|labs|xml|conv|kblx|sigma)/i.test(f)) return 'editors_tools';
    if(/menu/i.test(f)) return 'menus';
    if(/(tutorial|ativ|v7)/i.test(f)) return 'tutorials';
    if(/splash/i.test(f)) return 'visual_splash';
    if(/(doc|book|oidual|txt)/i.test(f)) return 'docs';
    if(/(player|audio|tts)/i.test(f)) return 'players'; }
  const s=sourceString(app); for(const r of REGEX_RULES) if(r.rx.test(s)) return r.key;
  return 'others';
}
function deriveBadges(app){const out=[];if(Array.isArray(app.tags)) out.push(...app.tags.slice(0,5));const f=(safe(app.key)+' '+safe(app.title)+' '+safe(app.url)).toLowerCase();if(/fix/.test(f)) out.push('fix');if(/final/.test(f)) out.push('final');if(/beta|rc/.test(f)) out.push('beta');if(/metalux/.test(f)) out.push('metalux');if(/nebula/.test(f)) out.push('nebula');if(/menu/.test(f)) out.push('menu');if(/splash/.test(f)) out.push('splash');return [...new Set(out)].slice(0,6);}
function groupIconFor(key,defaults){return (defaults&&(defaults[key]||defaults[ mapGroupKeyToType(key) ]))||({index_hubs:FALLBACK_ICONS.indexrs,chats:FALLBACK_ICONS.chats,editors_tools:FALLBACK_ICONS.editors,menus:FALLBACK_ICONS.editors,tutorials:FALLBACK_ICONS.base,visual_splash:FALLBACK_ICONS.base,docs:FALLBACK_ICONS.base,players:FALLBACK_ICONS.base,others:FALLBACK_ICONS.base}[key]||FALLBACK_ICONS.base);}
function mapGroupKeyToType(key){if(key==='index_hubs')return'indexrs';if(key==='chats')return'chats';if(key==='editors_tools'||key==='menus')return'editors';return'base';}
function pickIcon(app,groupKey,defaults){return (app.icon&&app.icon.trim())?app.icon:groupIconFor(groupKey,defaults);}

/* UI builders */
function h(el,attrs={},children=[]){const e=document.createElement(el);Object.entries(attrs).forEach(([k,v])=>{if(k==='class')e.className=v;else if(k==='html')e.innerHTML=v;else e.setAttribute(k,v);});(Array.isArray(children)?children:[children]).filter(Boolean).forEach(c=>e.appendChild(c));return e;}
function badgeEl(t){return h('span',{class:'badge',html:t});}
function sectionWrap(title,key){return h('section',{class:'section','data-group':key},[h('h2',{html:title}),h('div',{class:'grid'})]);}
function favButton(app){const b=h('button',{class:'btn star'+(isFav(app)?' active':''),html:(isFav(app)?'‚òÖ Fav':'‚òÜ Fav'),title:'Adicionar/remover dos Favoritos'}); b.addEventListener('click',ev=>{ev.stopPropagation();toggleFav(app);});return b;}
function card(app,groupKey,defaults){
  const iconSrc=pickIcon(app,groupKey,defaults), badges=deriveBadges(app);
  const iconDiv=h('div',{class:'icon',html:`<img src="${iconSrc}" alt="">`}); if(isFav(app)) iconDiv.appendChild(h('i',{class:'fav-dot'}));
  const c=h('div',{class:'card'},[
    iconDiv,
    h('div',{style:'flex:1'},[
      h('div',{class:'title',html:`${safe(app.title||app.key)}`}),
      badges.length?h('div',{class:'badges'},badges.map(badgeEl)):null,
      h('div',{class:'muted',html:safe(app.desc||'')}),
      h('div',{class:'row'},[
        favButton(app),
        h('button',{class:'btn',html:'Abrir',title:'Abrir app'}),
        h('button',{class:'btn',html:'‚éò Injection',title:'Copiar snippet de injection'})
      ])
    ])
  ]);
  c.querySelectorAll('.btn')[1].addEventListener('click',()=>openApp(app));
  c.querySelectorAll('.btn')[2].addEventListener('click',ev=>{ev.stopPropagation();copyInjection(app);});
  return c;
}

/* Busca */
function applySearchFilter(original,isGrouped){
  const q=$search.value.trim().toLowerCase(); if(!q) return original;
  const byTag=app=>Array.isArray(app.tags)&&app.tags.some(t=>safe(t).toLowerCase().includes(q));
  const match=app=>{const s=(safe(app.key)+' '+safe(app.title)+' '+safe(app.desc)+' '+safe(app.url)).toLowerCase(); return s.includes(q)||byTag(app);};
  if(isGrouped){const out={};Object.entries(original).forEach(([gk,list])=>{const f=list.filter(match); if(f.length) out[gk]=f;});return out;}
  return original.filter(match);
}

/* Load/Render */
let RAW=null, DEFAULTS=null;
function allApps(){if(!RAW)return[]; if(Array.isArray(RAW.apps))return RAW.apps; if(RAW.groups&&typeof RAW.groups==='object')return Object.values(RAW.groups).flat().filter(Boolean); return [];}
function findAppByKeyOrFile(q){ if(!q)return null; const n=q.toLowerCase(); for(const app of allApps()){const key=safe(app.key).toLowerCase(),title=safe(app.title).toLowerCase(),url=safe(app.url).toLowerCase(),file=lastFile(app.url); if(key===n||title===n||url.includes(n)||file===n) return app;} return null;}
function getViewTargetFromURL(){const sp=new URLSearchParams(location.search);let t=sp.get('view');if(!t&&location.hash.startsWith('#view=')) t=decodeURIComponent(location.hash.slice(6)); return t;}

async function load(){
  try{
    const res=await fetch('./apps/apps.json',{cache:'no-store'}); const data=await res.json(); RAW=data;
    DEFAULTS=data.defaultIcons||data.groups?.defaultIcons||{base:FALLBACK_ICONS.base,chats:FALLBACK_ICONS.chats,editors:FALLBACK_ICONS.editors,indexrs:FALLBACK_ICONS.indexrs,index_hubs:FALLBACK_ICONS.indexrs};
    render(); setTimeout(tryAutoOpen,0);
  }catch(e){
    console.error(e);
    $content.innerHTML=`<section class="section"><div class="card"><div class="icon">‚ö†Ô∏è</div><div><div class="title">Falha ao carregar apps</div><div class="muted">apps/apps.json n√£o encontrado ou inv√°lido.</div></div></div></section>`;
    $count.textContent='Erro no apps.json';
  }
}
function buildGroupedFromFlat(list){const groups={};const fav=list.filter(a=>isFav(a));if(fav.length)groups.favorites=fav;for(const app of list){const g=classify(app);(groups[g] ||= []).push(app);}return groups;}
function render(){
  if(!RAW)return; const mode=$sort.value;
  if(RAW.groups&&typeof RAW.groups==='object'){
    let groups=RAW.groups; const all=Object.values(groups).flat().filter(Boolean), favs=all.filter(a=>isFav(a)); if(favs.length) groups={favorites:favs,...groups};
    groups=applySearchFilter(groups,true);
    if(mode==='az'||mode==='za'){const dir=(mode==='az')?1:-1; const g2={}; Object.keys(groups).forEach(g=>{g2[g]=[...groups[g]].sort((a,b)=>safe(a.title||a.key).localeCompare(safe(b.title||b.key))*dir);}); groups=g2;}
    renderGrouped(groups,DEFAULTS);
  }else if(Array.isArray(RAW.apps)){
    let list=applySearchFilter(RAW.apps,false);
    if(mode==='az'||mode==='za'){const dir=(mode==='az')?1:-1; list=[...list].sort((a,b)=>safe(a.title||a.key).localeCompare(safe(b.title||b.key))*dir);}
    renderGrouped(buildGroupedFromFlat(list),DEFAULTS);
  }else{
    $content.innerHTML=`<section class="section"><div class="card"><div class="icon">‚ö†Ô∏è</div><div><div class="title">Formato n√£o reconhecido</div><div class="muted">Use {groups:{...}} ou {apps:[...]}</div></div></div></section>`;
  }
  updateViewerStatus(); loadProfile();
}
function renderGrouped(groups,defaults){
  $content.innerHTML='';let total=0;const ORDER=['favorites','index_hubs','chats','editors_tools','menus','tutorials','visual_splash','docs','players','others'];
  ORDER.forEach(gk=>{const list=groups[gk];if(Array.isArray(list)&&list.length){total+=list.length;const sec=sectionWrap(GROUP_TITLES[gk]||gk,gk);const grid=sec.querySelector('.grid');list.forEach(app=>grid.appendChild(card(app,gk,defaults)));$content.appendChild(sec);}});
  Object.keys(groups).forEach(gk=>{if(!ORDER.includes(gk)){const list=groups[gk];if(Array.isArray(list)&&list.length){total+=list.length;const sec=sectionWrap(GROUP_TITLES[gk]||gk,gk);const grid=sec.querySelector('.grid');list.forEach(app=>grid.appendChild(card(app,gk,defaults)));$content.appendChild(sec);}}});
  const spacer=document.createElement('div');spacer.className='spacer';$content.appendChild(spacer);$count.textContent=`${total} itens organizados`;
}

/* Viewer & Injection */
function injectionSnippet(){return `
<!-- INFODOSE: injection footer -->
<style>
  .infodose-footer{position:fixed;left:0;right:0;bottom:0;z-index:99999;display:flex;gap:10px;justify-content:center;align-items:center;padding:10px 12px calc(10px + env(safe-area-inset-bottom));backdrop-filter:blur(14px) saturate(140%);background:rgba(0,0,0,.65);border-top:1px solid rgba(255,255,255,.18)}
  .infodose-footer .btn{appearance:none;border:1px solid rgba(255,255,255,.18);border-radius:999px;padding:.6rem 1rem;background:rgba(255,255,255,.08);color:#fff;font-weight:800;cursor:pointer}
</style>
<div class="infodose-footer">
  <button class="btn" onclick="(function(){try{if(window.history.length>1)history.back();else location.href='index.html';}catch(e){location.href='index.html';}})()">‚¨Ö Voltar ao Hub</button>
</div>
<!-- /INFODOSE -->
`.trim();}
async function downloadInjected(app){try{const res=await fetch(app.url,{cache:'no-store'});const html=await res.text();const inj=injectionSnippet();const out=html.includes('</body>')?html.replace('</body>',inj+'\n</body>'):(html+'\n'+inj);const blob=new Blob([out],{type:'text/html'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=(lastFile(app.url)||'page')+'.injected.html';document.body.appendChild(a);a.click();a.remove();}catch(e){alert('N√£o foi poss√≠vel baixar/injetar este HTML (CORS?).');}}
function copyInjection(app){const inj=injectionSnippet();navigator.clipboard.writeText(inj).then(()=>alert('Injection copiado!'),()=>alert('Falha ao copiar (permiss√µes do navegador).'));}

function openApp(app){
  try{localStorage.setItem('infodose:lastView',JSON.stringify(app));}catch{}
  if(!$sameTab.checked){window.open(app.url,'_blank','noopener');return;}
  const v=document.createElement('div');v.className='viewer';
  v.innerHTML=`<div class="swipe-hint" id="swipeHint">‚¨áÔ∏è Arraste para fechar</div>
    <iframe src="${app.url}" allow="autoplay; clipboard-read; clipboard-write"></iframe>
    <div class="viewer-footer">
      <button class="btn" id="backHub">‚¨Ö Hub</button>
      <button class="btn" id="dlHtml" title="Baixar HTML com a barra de retorno injetada">‚§ì S√ºmb√ºs)</button>
      <button class="btn" id="copyInj" title="Copiar snippet da barra de retorno">‚éò Unjekt</button>
    </div>`;
  document.body.appendChild(v);
  setTimeout(()=>{const h=document.getElementById('swipeHint');if(h){h.classList.add('hide');setTimeout(()=>h.remove(),600);}},2000);

  const prevOverflow=document.body.style.overflow;document.body.style.overflow='hidden';VIEWER_OPEN=true;updateViewerStatus();

  // swipe
  let startY=null,lastY=null;const thr=48;
  v.addEventListener('touchstart',e=>{const t=e.touches?.[0]||e;startY=t.clientY;lastY=startY;},{passive:true});
  v.addEventListener('touchmove',e=>{const t=e.touches?.[0]||e;lastY=t.clientY;},{passive:true});
  v.addEventListener('touchend',()=>{if(startY!=null&&lastY-startY>thr) back();startY=null;lastY=null;},{passive:true});

  function back(){v.remove();document.body.style.overflow=prevOverflow;VIEWER_OPEN=false;updateViewerStatus();}
  v.querySelector('#backHub').addEventListener('click',back);
  v.querySelector('#dlHtml').addEventListener('click',()=>downloadInjected(app));
  v.querySelector('#copyInj').addEventListener('click',()=>copyInjection(app));
}

/* Help & Eventos */
function openHelp(){if(!$helpBackdrop)return;$helpBackdrop.classList.add('show');$helpBackdrop.setAttribute('aria-hidden','false');document.body.dataset.prevOverflow=document.body.style.overflow||'';document.body.style.overflow='hidden';}
function closeHelp(){if(!$helpBackdrop)return;$helpBackdrop.classList.remove('show');$helpBackdrop.setAttribute('aria-hidden','true');document.body.style.overflow=document.body.dataset.prevOverflow||'';delete document.body.dataset.prevOverflow;}

$('#dockHome').addEventListener('click',()=>{window.scrollTo({top:0,behavior:'smooth'});history.pushState('',document.title,location.pathname+location.search);});
$('#dockInfodose').addEventListener('click',()=>window.open('https://infodose.com.br','_blank','noopener'));
$('#btnDownloadLoader').addEventListener('click',()=>{const html='<!doctype html><meta charset="utf-8"><title>Infodose Loader</title><style>html,body{height:100%;margin:0;background:#0b0b0b;color:#fff;display:grid;place-items:center;font:16px/1.4 system-ui}.dot{width:14px;height:14px;border-radius:50%;background:#29d3ff;box-shadow:0 0 22px #29d3ff;animation:p 1s infinite alternate}@keyframes p{to{transform:scale(1.4);opacity:.7}}</style><div><div class=\"dot\"></div><p>Carregando‚Ä¶</p></div>';const blob=new Blob([html],{type:'text/html;charset=utf-8'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='Infodose_Loader.html';document.body.appendChild(a);a.click();a.remove();});
$('#dockInstall').addEventListener('click',()=>$('#btnDownloadLoader').click());

$search.addEventListener('input',()=>render()); $sort.addEventListener('change',()=>render());
$sameTab.addEventListener('change',()=>updateViewerStatus());
$viewerStatus.addEventListener('click',toggleStatusMode);
$profileBtn.addEventListener('click',editProfile);
$helpBtn.addEventListener('click',openHelp);
$helpClose.addEventListener('click',closeHelp);
$helpBackdrop.addEventListener('click',ev=>{if(ev.target===$helpBackdrop) closeHelp();});
document.addEventListener('keydown',e=>{if(e.key==='Escape'&&$helpBackdrop.classList.contains('show')) closeHelp();});

/* Auto-open */
function tryAutoOpen(){
  const sp=new URLSearchParams(location.search); let t=sp.get('view'); if(!t&&location.hash.startsWith('#view=')) t=decodeURIComponent(location.hash.slice(6));
  if(t){ const app=findAppByKeyOrFile(t); if(app){ openApp(app); return; } }
  const marked=allApps().find(a=>a.open===true); if(marked){ openApp(marked); return; }
  const j=localStorage.getItem('infodose:lastView'); if(j){ try{ const app=JSON.parse(j); if(app?.url){ openApp(app); } }catch{} }
}

/* Boot */
let RAW=null,DEFAULTS=null;
async function load(){
  try{const res=await fetch('./apps/apps.json',{cache:'no-store'});const data=await res.json();RAW=data;DEFAULTS=data.defaultIcons||data.groups?.defaultIcons||{base:FALLBACK_ICONS.base,chats:FALLBACK_ICONS.chats,editors:FALLBACK_ICONS.editors,indexrs:FALLBACK_ICONS.indexrs,index_hubs:FALLBACK_ICONS.indexrs};render();setTimeout(tryAutoOpen,0);}
  catch(e){console.error(e);$content.innerHTML=`<section class="section"><div class="card"><div class="icon">‚ö†Ô∏è</div><div><div class="title">Falha ao carregar apps</div><div class="muted">apps/apps.json n√£o encontrado ou inv√°lido.</div></div></div></section>`;$count.textContent='Erro no apps.json';}
}
function allApps(){ if(!RAW) return []; if(Array.isArray(RAW.apps)) return RAW.apps; if(RAW.groups&&typeof RAW.groups==='object') return Object.values(RAW.groups).flat().filter(Boolean); return []; }
function findAppByKeyOrFile(q){ if(!q) return null; const n=q.toLowerCase(); for(const app of allApps()){ const key=safe(app.key).toLowerCase(),title=safe(app.title).toLowerCase(),url=safe(app.url).toLowerCase(),file=lastFile(app.url); if(key===n||title===n||url.includes(n)||file===n) return app; } return null; }
load();
</script>
</body>
</html>
