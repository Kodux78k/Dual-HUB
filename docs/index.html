<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>DUAL.Infodose🔘HUB</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0b0b0b" id="metaThemeColor">
  <style>
    :root{
      --bg:#0b0b0b; --fg:#fff; --muted:#b9c7cf; --acc:#E7C65A;
      --stroke:rgba(255,235,180,.20); --stroke-soft:rgba(255,235,180,.12);
      --blur:22px; --radius:18px; --dock-space:84px; --maxw:980px;
    }
    /* Base */
    html,body{height:100%;margin:0}
    html{background:var(--bg)}
    body{
      background:var(--bg); color:var(--fg);
      font-family:ui-rounded,system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial;
      min-height:100vh; min-height:100svh;
    }
    /* Header */
    .header{
      position:sticky;top:0;z-index:10;
      backdrop-filter:blur(var(--blur)) saturate(150%);
      background:rgba(0,0,0,.45);
      border-bottom:1px solid var(--stroke);
      box-shadow:0 12px 34px rgba(0,0,0,.42);
      padding-top:env(safe-area-inset-top)
    }
    .inner{max-width:var(--maxw);margin:0 auto;padding:14px;display:flex;gap:14px;align-items:center}
    .logo{width:46px;height:46px;border-radius:50%;display:inline-grid;place-items:center;position:relative;background:rgba(0,0,0,.25)}
    .ring{position:absolute;inset:0;border:2px solid var(--acc);border-radius:50%;animation:spin 6s linear infinite}
    .bar{position:absolute;left:50%;top:50%;width:60%;height:2px;background:var(--acc);transform:translate(-50%,-50%);border-radius:999px;animation:breathe 2.4s ease-in-out infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes breathe{0%,100%{opacity:.8}50%{opacity:1}}
    h1{font-size:1.16rem;margin:.12rem 0 0;font-weight:800}
    .kicker{font-size:.72rem;letter-spacing:.16em;color:#e0e0e0;text-transform:uppercase}

    /* Toolbar */
    .toolbar{max-width:var(--maxw);margin:10px auto 0;padding:0 14px 8px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{border:1px solid var(--stroke-soft);border-radius:999px;padding:.5rem .8rem;background:rgba(255,255,255,.04);font-weight:700}
    .input{flex:1;min-width:180px;border:1px solid var(--stroke-soft);border-radius:999px;padding:.6rem .9rem;background:rgba(255,255,255,.06);color:#fff;outline:none}
    .select{border:1px solid var(--stroke-soft);border-radius:999px;padding:.56rem .9rem;background:rgba(255,255,255,.06);color:#fff}
    .toggle{display:flex;gap:8px;align-items:center}

    /* Section */
    .section{max-width:var(--maxw);margin:14px auto 6px;padding:0 14px}
    .section h2{
      font-size:.92rem;letter-spacing:.12em;text-transform:uppercase;
      color:#e6e6e6;margin:14px 0 8px;opacity:.9
    }

    /* Grid/cards */
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px}
    @media(max-width:560px){.grid{grid-template-columns:1fr}}
    .card{
      background:rgba(0,0,0,.32); border:1px solid var(--stroke-soft);
      border-radius:18px; padding:12px; display:flex; gap:12px; align-items:center;
      box-shadow:0 6px 18px rgba(0,0,0,.45)
    }
    .icon{width:56px;height:56px;border-radius:14px;display:grid;place-items:center;overflow:hidden;background:#0f1320;border:1px solid var(--stroke-soft)}
    .icon img{width:100%;height:100%;object-fit:cover;display:block}
    .title{font-weight:800;margin-bottom:4px;display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .badges{display:flex;gap:6px;flex-wrap:wrap}
    .badge{font-size:.72rem;padding:.16rem .5rem;border-radius:999px;border:1px solid var(--stroke-soft);background:rgba(255,255,255,.06);color:#eaf6ff}
    .muted{color:var(--muted);font-size:.86rem}
    .row{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--stroke-soft);cursor:pointer;background:rgba(255,255,255,.06);color:#fff;padding:.64rem .9rem;border-radius:999px;font-weight:800}
    .btn.primary{background:linear-gradient(90deg,#9f7cff,#29d3ff);border-color:transparent}

    /* Bottom Dock */
    .dock{position:fixed;left:0;right:0;bottom:0;z-index:30;display:block}
    .dock-inner{
      max-width:var(--maxw);margin:0 auto;
      padding:8px 10px calc(8px + env(safe-area-inset-bottom));
      display:flex;gap:8px;justify-content:space-between;align-items:center;
      backdrop-filter:blur(18px) saturate(140%); background:rgba(0,0,0,.50);
      border-top:1px solid var(--stroke); box-shadow:0 -10px 30px rgba(0,0,0,.45)
    }
    .dbtn{appearance:none;border:1px solid var(--stroke);background:rgba(255,255,255,.06);color:#fff;padding:.64rem .9rem;border-radius:12px;font-weight:700}
    footer{color:#fff;font-size:.8rem;text-align:center;margin:18px 0 calc(18px + var(--dock-space));opacity:.9}
    .spacer{height:calc(var(--dock-space) + env(safe-area-inset-bottom) + 8px)}

    /* Viewer (fullscreen) */
    .viewer{position:fixed;inset:0;z-index:50;background:#000}
    .viewer iframe{position:absolute;inset:0 0 60px 0;border:0;width:100%;height:calc(100% - 60px)}
    .viewer-footer{
      position:fixed;left:0;right:0;bottom:0;height:60px;
      display:flex;gap:8px;align-items:center;justify-content:center;
      padding:8px 10px calc(8px + env(safe-area-inset-bottom));
      backdrop-filter:blur(18px) saturate(140%); background:rgba(0,0,0,.65);
      border-top:1px solid var(--stroke)
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="inner">
      <span class="logo" aria-hidden="true"><span class="ring"></span><span class="bar"></span></span>
      <div style="flex:1">
        <div class="kicker">Infodose • Hub Principal</div>
        <h1>Infodose Hub Ultra</h1>
      </div>
      <nav aria-label="Ações">
        <button class="btn primary" id="btnDownloadLoader" type="button">⤓ Baixar Loader</button>
      </nav>
    </div>
  </header>

  <div class="toolbar">
    <input id="search" class="input" type="search" placeholder="Buscar e filtrar por nome, url, tag…" autocomplete="off"/>
    <select id="sort" class="select" title="Ordenação">
      <option value="group">Ordenar por grupos</option>
      <option value="az">A → Z</option>
      <option value="za">Z → A</option>
    </select>
    <label class="toggle pill">
      <input id="sameTab" type="checkbox" style="accent-color:#29d3ff"> Abrir na mesma aba (viewer)
    </label>
    <div class="pill" id="countApps">Carregando…</div>
  </div>

  <main id="content"></main>
  <footer>Infodose Hub Ultra • PWA</footer>

  <div class="dock" role="navigation" aria-label="Dock">
    <div class="dock-inner">
      <button class="dbtn" id="dockHome" type="button">Home</button>
      <button class="dbtn" id="dockInfodose" type="button">Infodose</button>
      <button class="dbtn" id="dockInstall" type="button">⤓ Baixar Loader</button>
    </div>
  </div>

<script>
/** ===== util ===== **/
const $ = (q,root=document)=>root.querySelector(q);
const $content = $('#content');
const $count = $('#countApps');
const $search = $('#search');
const $sort = $('#sort');
const $sameTab = $('#sameTab');

/** ===== ícones ===== **/
const FALLBACK_ICONS = {
  base:   'icons/icon-192.png',
  chats:  'icons/icon-192-chats.png',
  editors:'icons/icon-192-editors.png',
  indexrs:'icons/icon-192-indexrs.png'
};

/** ===== grupos ===== **/
const GROUP_TITLES = {
  index_hubs: 'Index / Hubs',
  chats: 'Chats / Render',
  editors_tools: 'Editors & Tools',
  menus: 'Menus',
  tutorials: 'Tutoriais',
  visual_splash: 'Visual / Splash',
  docs: 'Docs',
  players: 'Players',
  others: 'Outros'
};
const GROUP_ORDER = ['index_hubs','chats','editors_tools','menus','tutorials','visual_splash','docs','players','others'];

/** ===== regras inteligentes ===== **/
const TAG_PRIORITIES = {
  index_hubs: ['hub','index','nebula','metalux','sumbus','sümbüs','barra','barrao'],
  chats: ['chat','render','response','kobllux','autoload'],
  editors_tools: ['editor','edit','labs','xml','conv','converter','kblx','sigma','metalux','apps.json'],
  menus: ['menu'],
  tutorials: ['tutorial','ativacoes','ativação','v7','guia'],
  visual_splash: ['splash','visual'],
  docs: ['book','oidual','doc','.txt'],
  players: ['player','audio','tts']
};

const REGEX_RULES = [
  { key:'index_hubs',    rx: /(index|hub|nebula|metalux|s[üu]mb[üu]s|barrao)/i },
  { key:'chats',         rx: /(chat|render[-_ ]?response|autoload|kobllux)/i },
  { key:'editors_tools', rx: /(editor|labs|xml|conv|converter|apps\.json|kblx|sigma|metalux)/i },
  { key:'menus',         rx: /(^|[-_ ])menu([-_ ]|$)/i },
  { key:'tutorials',     rx: /(tutorial|ativa[cç][oõ]es|v7\b)/i },
  { key:'visual_splash', rx: /splash/i },
  { key:'docs',          rx: /(book|oidual|\.txt\b)/i },
  { key:'players',       rx: /(player|audio|tts)/i }
];

/** ===== helpers ===== **/
function safe(v){ return (v||'').toString(); }
function lastFile(url){
  try{ const u = new URL(url, location.href); return (u.pathname.split('/').pop()||'').toLowerCase(); }
  catch{ return (url||'').split('/').pop()?.toLowerCase() || ''; }
}
function folderHint(url){
  try{
    const u = new URL(url, location.href);
    const parts = u.pathname.split('/').filter(Boolean);
    // ex.: ./apps/metalux/something.html → retorna 'metalux'
    const i = parts.indexOf('apps');
    if(i>=0 && parts[i+1]) return parts[i+1].toLowerCase();
  }catch{}
  return '';
}
function sourceString(app){
  return [app.key, app.title, app.desc, app.url].map(safe).join(' ').toLowerCase() + ' ' + lastFile(app.url);
}
function hasTag(app, tag){ return Array.isArray(app.tags) && app.tags.map(safe).some(t=>t.toLowerCase()===tag.toLowerCase()); }

function classify(app){
  // 1) se app.group vier explícito, respeita
  if(app.group && GROUP_TITLES[app.group]) return app.group;

  // 2) tags do app (prioridade)
  if(Array.isArray(app.tags)){
    const tagsLower = app.tags.map(t=>safe(t).toLowerCase());
    for(const [gk,tagList] of Object.entries(TAG_PRIORITIES)){
      if(tagList.some(t => tagsLower.includes(t))) return gk;
    }
  }

  // 3) pasta logo após ./apps/
  const folder = folderHint(app.url);
  if(folder){
    if(/(hub|index|nebula|metalux|s[üu]mb[üu]s|bar)/i.test(folder)) return 'index_hubs';
    if(/(chat|render|resp|kobllux|auto)/i.test(folder)) return 'chats';
    if(/(edit|labs|xml|conv|kblx|sigma)/i.test(folder)) return 'editors_tools';
    if(/menu/i.test(folder)) return 'menus';
    if(/(tutorial|ativ|v7)/i.test(folder)) return 'tutorials';
    if(/splash/i.test(folder)) return 'visual_splash';
    if(/(doc|book|oidual|txt)/i.test(folder)) return 'docs';
    if(/(player|audio|tts)/i.test(folder)) return 'players';
  }

  // 4) regex em key/title/url
  const s = sourceString(app);
  for (const r of REGEX_RULES) if (r.rx.test(s)) return r.key;

  return 'others';
}

function deriveBadges(app){
  const out = [];
  if(Array.isArray(app.tags)) out.push(...app.tags.slice(0,5));
  const f = (safe(app.key)+' '+safe(app.title)+' '+safe(app.url)).toLowerCase();
  if(/fix/.test(f)) out.push('fix');
  if(/final/.test(f)) out.push('final');
  if(/beta|rc/.test(f)) out.push('beta');
  if(/metalux/.test(f)) out.push('metalux');
  if(/nebula/.test(f)) out.push('nebula');
  if(/menu/.test(f)) out.push('menu');
  if(/splash/.test(f)) out.push('splash');
  return [...new Set(out)].slice(0,6);
}

function groupIconFor(key, defaults){
  // defaults pode conter: base, chats, editors, indexrs OU chaves por grupo
  return (defaults && (defaults[key] || defaults[ mapGroupKeyToType(key) ])) ||
         ({
           index_hubs: FALLBACK_ICONS.indexrs,
           chats: FALLBACK_ICONS.chats,
           editors_tools: FALLBACK_ICONS.editors,
           menus: FALLBACK_ICONS.editors,
           tutorials: FALLBACK_ICONS.base,
           visual_splash: FALLBACK_ICONS.base,
           docs: FALLBACK_ICONS.base,
           players: FALLBACK_ICONS.base,
           others: FALLBACK_ICONS.base
         }[key] || FALLBACK_ICONS.base);
}
function mapGroupKeyToType(key){
  if(key==='index_hubs') return 'indexrs';
  if(key==='chats') return 'chats';
  if(key==='editors_tools' || key==='menus') return 'editors';
  return 'base';
}
function pickIcon(app, groupKey, defaults){
  if (app.icon && app.icon.trim()) return app.icon;
  return groupIconFor(groupKey, defaults);
}

/** ===== UI builders ===== **/
function h(el, attrs={}, children=[]){
  const e = document.createElement(el);
  Object.entries(attrs).forEach(([k,v])=>{
    if(k==='class') e.className = v;
    else if(k==='html') e.innerHTML = v;
    else e.setAttribute(k, v);
  });
  (Array.isArray(children)?children:[children]).filter(Boolean).forEach(c=> e.appendChild(c));
  return e;
}
function badgeEl(text){ return h('span', {class:'badge', html: text}); }

function sectionWrap(title, key){ return h('section',{class:'section','data-group':key},[
  h('h2',{html:title}),
  h('div',{class:'grid'})
]);}

function card(app, groupKey, defaults){
  const iconSrc = pickIcon(app, groupKey, defaults);
  const badges = deriveBadges(app);
  const c = h('div',{class:'card'},[
    h('div',{class:'icon', html:`<img src="${iconSrc}" alt="">`}),
    h('div',{style:'flex:1'},[
      h('div',{class:'title', html: `${safe(app.title||app.key)}`}),
      badges.length? h('div',{class:'badges'}, badges.map(badgeEl)) : null,
      h('div',{class:'muted', html: safe(app.desc||'') }),
      h('div',{class:'row'},[
        h('button',{class:'btn', html:'Abrir'}),
        h('button',{class:'btn', html:'⎘ Injection', title:'Copiar snippet de injection'},)
      ])
    ])
  ]);

  c.querySelector('.btn').addEventListener('click', ()=> openApp(app));
  c.querySelectorAll('.btn')[1].addEventListener('click', ()=> copyInjection(app));
  return c;
}

/** ===== render ===== **/
function renderGrouped(groups, defaults){
  $content.innerHTML = '';
  let total = 0;
  GROUP_ORDER.forEach(gk=>{
    const list = groups[gk];
    if(Array.isArray(list) && list.length){
      total += list.length;
      const sec = sectionWrap(GROUP_TITLES[gk] || gk, gk);
      const grid = sec.querySelector('.grid');
      list.forEach(app => grid.appendChild(card(app, gk, defaults)));
      $content.appendChild(sec);
    }
  });
  // grupos extras
  Object.keys(groups).forEach(gk=>{
    if(!GROUP_ORDER.includes(gk)){
      const list = groups[gk];
      if(Array.isArray(list) && list.length){
        total += list.length;
        const sec = sectionWrap(GROUP_TITLES[gk] || gk, gk);
        const grid = sec.querySelector('.grid');
        list.forEach(app => grid.appendChild(card(app, gk, defaults)));
        $content.appendChild(sec);
      }
    }
  });
  const spacer = document.createElement('div'); spacer.className='spacer'; $content.appendChild(spacer);
  $count.textContent = `${total} itens organizados`;
}

function renderFlat(apps, defaults){
  const groups = {};
  for(const app of apps){
    const gk = classify(app);
    (groups[gk] ||= []).push(app);
  }
  // ordenação
  const mode = $sort.value;
  if (mode === 'az' || mode === 'za'){
    const dir = (mode==='az') ? 1 : -1;
    Object.keys(groups).forEach(k=>{
      groups[k].sort((a,b)=> safe(a.title||a.key).localeCompare(safe(b.title||b.key)) * dir);
    });
  } else {
    Object.keys(groups).forEach(k=>{
      groups[k].sort((a,b)=> safe(a.title||a.key).localeCompare(safe(b.title||b.key)));
    });
  }
  renderGrouped(groups, defaults);
}

/** ===== busca ===== **/
function applySearchFilter(original, isGrouped){
  const q = $search.value.trim().toLowerCase();
  if(!q) return original;
  const byTag = (app)=> Array.isArray(app.tags) && app.tags.some(t=>safe(t).toLowerCase().includes(q));
  const matchApp = app=>{
    const s = (safe(app.key)+' '+safe(app.title)+' '+safe(app.desc)+' '+safe(app.url)).toLowerCase();
    return s.includes(q) || byTag(app);
  };
  if(isGrouped){
    const out = {};
    Object.entries(original).forEach(([gk,list])=>{
      const f = list.filter(matchApp);
      if(f.length) out[gk] = f;
    });
    return out;
  } else {
    return original.filter(matchApp);
  }
}

/** ===== load/render pipeline ===== **/
let RAW = null;
let DEFAULTS = null;

async function load(){
  try{
    const res = await fetch('./apps/apps.json', {cache:'no-store'});
    const data = await res.json();
    RAW = data;

    // defaults vindos do json (opcional)
    DEFAULTS = data.defaultIcons || data.groups?.defaultIcons || {
      base: FALLBACK_ICONS.base,
      chats: FALLBACK_ICONS.chats,
      editors: FALLBACK_ICONS.editors,
      indexrs: FALLBACK_ICONS.indexrs,
      index_hubs: FALLBACK_ICONS.indexrs
    };

    render();
  }catch(e){
    console.error(e);
    $content.innerHTML = `
      <section class="section">
        <div class="card">
          <div class="icon">⚠️</div>
          <div>
            <div class="title">Falha ao carregar apps</div>
            <div class="muted">apps/apps.json não encontrado ou inválido.</div>
          </div>
        </div>
      </section>`;
    $count.textContent = 'Erro no apps.json';
  }
}

function render(){
  if(!RAW) return;
  const mode = $sort.value;
  if (RAW.groups && typeof RAW.groups === 'object'){
    let groups = RAW.groups;
    groups = applySearchFilter(groups, true);
    if (mode==='az' || mode==='za'){
      const dir = (mode==='az') ? 1 : -1;
      const g2 = {};
      Object.keys(groups).forEach(gk=>{
        g2[gk] = [...groups[gk]].sort((a,b)=> safe(a.title||a.key).localeCompare(safe(b.title||b.key))*dir);
      });
      groups = g2;
    }
    renderGrouped(groups, DEFAULTS);
  } else if (Array.isArray(RAW.apps)){
    let list = RAW.apps;
    list = applySearchFilter(list, false);
    renderFlat(list, DEFAULTS);
  } else {
    $content.innerHTML = `
      <section class="section">
        <div class="card">
          <div class="icon">⚠️</div>
          <div>
            <div class="title">Formato não reconhecido</div>
            <div class="muted">Use {groups:{...}} ou {apps:[...]}</div>
          </div>
        </div>
      </section>`;
  }
}

/** ===== viewer + injections ===== **/
function isSameOrigin(url){
  try{ const u=new URL(url, location.href); return u.origin===location.origin; }
  catch{ return url.startsWith('./') || url.startsWith('/'); }
}
function openApp(app){
  if(!$sameTab.checked){ window.open(app.url,'_blank','noopener'); return; }
  // viewer fullscreen com iframe
  const v = document.createElement('div');
  v.className = 'viewer';
  v.innerHTML = `
    <iframe src="${app.url}" allow="autoplay; clipboard-read; clipboard-write"></iframe>
    <div class="viewer-footer">
      <button class="btn" id="backHub">⬅ Voltar ao Hub</button>
      <button class="btn" id="dlHtml">⤓ Baixar HTML (com Injections)</button>
      <button class="btn" id="copyInj">⎘ Copiar Injection</button>
    </div>`;
  document.body.appendChild(v);
  v.querySelector('#backHub').addEventListener('click', ()=> v.remove());
  v.querySelector('#dlHtml').addEventListener('click', ()=> downloadInjected(app));
  v.querySelector('#copyInj').addEventListener('click', ()=> copyInjection(app));
}

function injectionSnippet(){
  // snippet mínimo: barra fixa “Voltar ao Hub”
  return `
<!-- INFODOSE: injection footer -->
<style>
  .infodose-footer{position:fixed;left:0;right:0;bottom:0;z-index:99999;display:flex;gap:10px;justify-content:center;align-items:center;padding:10px 12px calc(10px + env(safe-area-inset-bottom));backdrop-filter:blur(14px) saturate(140%);background:rgba(0,0,0,.65);border-top:1px solid rgba(255,255,255,.18)}
  .infodose-footer .btn{appearance:none;border:1px solid rgba(255,255,255,.18);border-radius:999px;padding:.6rem 1rem;background:rgba(255,255,255,.08);color:#fff;font-weight:800;cursor:pointer}
</style>
<div class="infodose-footer">
  <button class="btn" onclick="(function(){ try{ if(window.history.length>1) history.back(); else location.href='index.html'; }catch(e){ location.href='index.html'; } })()">⬅ Voltar ao Hub</button>
</div>
<!-- /INFODOSE -->
`.trim();
}

async function downloadInjected(app){
  try{
    const res = await fetch(app.url, {cache:'no-store'});
    const html = await res.text();
    // injeta antes do </body>
    const inj = injectionSnippet();
    const out = html.includes('</body>') ? html.replace('</body>', inj + '\n</body>') : (html + '\n' + inj);
    const blob = new Blob([out], {type:'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = (lastFile(app.url)||'page') + '.injected.html';
    document.body.appendChild(a); a.click(); a.remove();
  }catch(e){
    alert('Não foi possível baixar/injetar este HTML (CORS?).');
  }
}

function copyInjection(app){
  const inj = injectionSnippet();
  navigator.clipboard.writeText(inj).then(
    ()=> alert('Injection copiado!'),
    ()=> alert('Falha ao copiar (permissões do navegador).')
  );
}



function downloadLoader(){
  const html = buildLoaderHTML();
  const blob = new Blob([html], {type:'text/html'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'Infodose_Loader.html';
  document.body.appendChild(a); a.click(); a.remove();
}

/** ===== eventos UI ===== **/
$('#dockHome').addEventListener('click', ()=> {
  window.scrollTo({top:0, behavior:'smooth'});
  history.pushState('', document.title, window.location.pathname + window.location.search);
});
$('#dockInfodose').addEventListener('click', ()=> window.open('https://infodose.com.br','_blank','noopener'));
$('#btnDownloadLoader').addEventListener('click', downloadLoader);
$('#dockInstall').addEventListener('click', downloadLoader);

$search.addEventListener('input', ()=> render());
$sort.addEventListener('change', ()=> render());

/** ===== init ===== **/
load();
</script>
</body>
</html>