<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Dual.Infodose ‚Äî Nebula Pro (Reactive Face)</title>
  <meta name="theme-color" content="#0b0b0f"/>
  <style>
    :root{
      --bg:#0b0b0f;
      --ink:#eef2ff;
      --muted:#aeb7d6;
      --panel:rgba(0,0,0,.45);
      --border:rgba(255,255,255,.16);
      --radius:18px;
      --safe: env(safe-area-inset-bottom, 16px);
      --glow:0 0 28px rgba(255,255,255,.14), 0 0 64px rgba(255,255,255,.10);
      --nebula: linear-gradient(42deg,#f0f,#0ff);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      background:
        radial-gradient(1200px 700px at 50% -20%, rgba(255,255,255,.06), transparent 60%),
        radial-gradient(900px 900px at 50% 120%, rgba(255,255,255,.05), transparent 60%),
        var(--nebula);
      background-attachment: fixed;
      font: 400 16px/1.38 ui-rounded, system-ui, -apple-system, Inter, Segoe UI, Roboto, Arial;
      display:flex; flex-direction:column;
    }
    header{
      position:sticky; top:0; z-index:5;
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px calc(10px + var(--safe)) 16px;
      background:linear-gradient(to bottom, rgba(0,0,0,.55), rgba(0,0,0,.25) 70%, transparent);
      backdrop-filter: blur(14px);
      border-bottom:1px solid var(--border);
    }
    .brand{display:flex; gap:10px; align-items:center}
    .pill{
      width:90px; height:40px; border-radius:24px; overflow:hidden; position:relative;
      display:grid; place-items:center; background:#07070a;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.10), var(--glow);
    }
    .pill::after{
      content:""; position:absolute; inset:-1px; border-radius:24px;
      background: conic-gradient(from 0deg, rgba(255,255,255,.0), rgba(255,255,255,.14), rgba(255,255,255,.0) 30%);
      animation: sweep 3.6s linear infinite; mix-blend-mode: screen; pointer-events:none;
    }
    @keyframes sweep{to{transform:rotate(360deg)}}
    .menuBtn{width:44px;height:44px;border-radius:14px;background:rgba(255,255,255,.08);display:grid;place-items:center;border:1px solid var(--border);box-shadow:var(--glow)}
    .menuBtn:active{transform:scale(.98)}
    main{flex:1; display:flex; flex-direction:column; padding:12px 14px 0 14px; gap:12px;}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:12px; box-shadow:var(--glow); backdrop-filter: blur(8px)}
    .center{display:grid; place-items:center}
    .symbolPad{
      width:min(86vw, 440px); aspect-ratio: 2.2 / 1; position:relative; display:grid; place-items:center;
      border-radius:30px; background:#07070a; overflow:hidden; box-shadow:inset 0 0 0 2px rgba(255,255,255,.12), var(--glow);
    }
    .symbolPad .ring{position:absolute; inset:0; border-radius:30px; box-shadow:inset 0 0 0 2px rgba(255,255,255,.10)}
    .symbolPad .ring.r2{inset:8px; animation:pulse 3.4s ease-in-out infinite}
    .symbolPad .ring.r3{inset:16px; animation:pulse 3.4s ease-in-out .9s infinite}
    @keyframes pulse{0%,100%{box-shadow:inset 0 0 0 2px rgba(255,255,255,.10)}50%{box-shadow:inset 0 0 0 2px rgba(255,255,255,.26)}}
    .row{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .chip{flex:1 1 auto; min-width:120px; display:flex; align-items:center; justify-content:center; gap:8px; padding:12px 14px; border-radius:16px; border:1px solid var(--border); background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04))}
    .chip:active{transform:translateY(1px)}
    #chat{display:flex; flex-direction:column; gap:8px; height:48vh}
    .log{flex:1; overflow:auto; padding:10px 6px; display:flex; flex-direction:column; gap:8px; scroll-behavior:smooth}
    .msg{max-width:86%; padding:10px 12px; border-radius:14px; border:1px solid var(--border); box-shadow:var(--glow)}
    .you{align-self:flex-end; background:rgba(255,255,255,.10)}
    .ai{align-self:flex-start; background:rgba(0,0,0,.25)}
    .bar{display:flex; gap:8px; align-items:center}
    input, textarea{background:#0b0b12; color:var(--ink); border:1px solid var(--border); border-radius:12px; padding:12px 12px; width:100%}
    button{background:#0e0e16; color:var(--ink); border:1px solid rgba(255,255,255,.22); border-radius:12px; padding:12px 16px; font-weight:700}
    small{color:var(--muted)}
    /* toggle buttons */
    .toggles{display:flex; gap:8px; align-items:center}
    .toggleBtn{display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border-radius:14px; border:1px solid var(--border); background:rgba(255,255,255,.08); box-shadow:var(--glow); font-weight:700}
    .toggleBtn .dot{width:10px;height:10px;border-radius:50%;background:#aaa}
    .toggleBtn.on{background:rgba(255,255,255,.16)}
    .toggleBtn.on .dot{background:#5ef3ff; box-shadow:0 0 12px #5ef3ffaa}
    .toggleBtn svg{stroke:white}
    /* moods */
    .mood-glow{filter: drop-shadow(0 0 16px rgba(255,255,255,.22)); transition: filter .25s ease}
    .mood-thinking{filter: drop-shadow(0 0 16px rgba(255,255,0,.35))}
    .mood-speaking{filter: drop-shadow(0 0 16px rgba(0,255,255,.35))}
    .mood-saved{filter: drop-shadow(0 0 16px rgba(0,255,128,.45))}
    .mood-error{filter: drop-shadow(0 0 16px rgba(255,64,64,.45))}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="pill" id="homePill">
        <svg viewBox="0 0 120 40" width="76" height="26" aria-hidden="true">
          <path d="M10 24c12-12 22-12 34 0s22 12 34 0" stroke="white" stroke-width="4" fill="none"/>
          <path d="M10 28c12-12 22-12 34 0s22 12 34 0" stroke="white" stroke-width="3" opacity=".9" fill="none"/>
          <circle cx="45" cy="21" r="2.4" fill="white"/>
          <path d="M89 19l6 3-6 3z" fill="white"/>
        </svg>
      </div>
      <div>
        <div style="font-weight:900; letter-spacing:.4px">Dual.Infodose</div>
        <small>Nebula Pro ‚Ä¢ touch-first</small>
      </div>
    </div>
    <button class="menuBtn" id="menuBtn" aria-label="Abrir menu">
      <svg viewBox="0 0 24 24" width="22" height="22"><path d="M4 6h16M4 12h16M4 18h16" stroke="white"/></svg>
    </button>
  </header>

  <main>
    <section class="center">
      <div class="symbolPad mood-glow" id="symbolPad">
        <div class="ring"></div><div class="ring r2"></div><div class="ring r3"></div>
        <!-- reactive face -->
        <svg id="face" viewBox="0 0 120 120" width="90" height="90">
          <circle cx="60" cy="60" r="44" stroke="white" stroke-width="8" fill="none" opacity=".9"/>
          <!-- eyelids -->
          <g id="eyes">
            <ellipse id="eyeL" cx="46" cy="56" rx="13" ry="10" fill="white" opacity=".95"/>
            <ellipse id="eyeR" cx="74" cy="56" rx="13" ry="10" fill="white" opacity=".95"/>
            <circle id="pupilL" cx="46" cy="56" r="4" fill="#090a10"/>
            <circle id="pupilR" cx="74" cy="56" r="4" fill="#090a10"/>
          </g>
          <!-- mouth -->
          <path id="mouth" d="M45 84q15 10 30 0" stroke="white" stroke-width="6" fill="none" stroke-linecap="round"/>
        </svg>
      </div>
    </section>

    <section id="chat" class="card">
      <div class="row">
        <strong>Conversas</strong>
        <div class="toggles">
          <button id="btnTTS" class="toggleBtn" aria-pressed="false">
            <span class="dot"></span>
            <svg viewBox="0 0 24 24" width="18" height="18"><path d="M11 5l-6 4H3v6h2l6 4V5zM19 15a4 4 0 000-6"/></svg>
            TTS
          </button>
          <button id="btnSave" class="toggleBtn on" aria-pressed="true">
            <span class="dot"></span>
            <svg viewBox="0 0 24 24" width="18" height="18"><path d="M4 4h16v16H4z"/><path d="M8 4v6h8V4M7 20v-5h10v5"/></svg>
            Salvar
          </button>
        </div>
      </div>
      <div class="log" id="log" aria-live="polite"></div>
      <div class="bar">
        <input id="prompt" type="text" placeholder="Toque e fale com a AA‚Ä¶"/>
        <button id="send">Enviar</button>
      </div>
      <small>Toque na pill/painel para ver rea√ß√µes. Export/Import no menu.</small>
    </section>

    <section class="row" style="justify-content:center">
      <button class="chip" id="chipClear">üßπ Limpar</button>
      <button class="chip" id="chipAbout">‚ÑπÔ∏è Sobre</button>
    </section>
    <div style="height:max(20px,var(--safe))"></div>
  </main>

  <!-- hidden file input -->
  <input id="filePick" type="file" accept="application/json" hidden/>

  <script>
    const $ = (q)=>document.querySelector(q);
    const logEl = $('#log'), promptEl=$('#prompt'), sendBtn=$('#send');
    const faceEl=$('#face'), mouthEl=$('#mouth'), eyes=$('#eyes'), pupilL=$('#pupilL'), pupilR=$('#pupilR'), eyeL=$('#eyeL'), eyeR=$('#eyeR');
    const pad=$('#symbolPad');
    const btnTTS=$('#btnTTS'), btnSave=$('#btnSave');
    const filePick=$('#filePick');

    const store = {
      get cfg(){ try{return JSON.parse(localStorage.getItem('dual_cfg')||'{}');}catch(_){return{};} },
      set cfg(v){ localStorage.setItem('dual_cfg', JSON.stringify(v)); },
      get hist(){ try{return JSON.parse(localStorage.getItem('dual_hist')||'[]');}catch(_){return[];} },
      set hist(v){ localStorage.setItem('dual_hist', JSON.stringify(v)); }
    };

    // ---------- TOGGLES ----------
    function setToggle(el,on){ el.classList.toggle('on', !!on); el.setAttribute('aria-pressed', on?'true':'false'); }
    function loadToggles(){
      const {autoTTS=false, persist=true} = store.cfg;
      setToggle(btnTTS, autoTTS); setToggle(btnSave, persist);
    }
    loadToggles();
    btnTTS.onclick=()=>{ const cfg=store.cfg; cfg.autoTTS = !(cfg.autoTTS); store.cfg=cfg; setToggle(btnTTS, cfg.autoTTS); wink(); };
    btnSave.onclick=()=>{ const cfg=store.cfg; cfg.persist = !(cfg.persist!==false); store.cfg=cfg; setToggle(btnSave, cfg.persist!==false); cheer(); };

    // ---------- CHAT ----------
    function addMsg(role, content){ const div=document.createElement('div'); div.className='msg '+(role==='user'?'you':'ai'); div.textContent=content; logEl.appendChild(div); logEl.scrollTop=logEl.scrollHeight; }
    function pushHist(role, content){ if(store.cfg.persist!==false){ const h=store.hist; h.push({role, content}); store.hist=h.slice(-64);} }
    function speak(text){ try{ if(!store.cfg.autoTTS) return; const u=new SpeechSynthesisUtterance(text); u.lang='pt-BR'; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(_){ } }

    function buildMessages(q){
      const base=[{role:'system', content: store.cfg.system || 'Voc√™ √© a AA Dual.Infodose. Curta e √∫til.'}];
      return base.concat([{role:'user', content:q}]);
    }
    async function callOpenRouter(messages){
      const {apiKey, model='openrouter/auto'} = store.cfg;
      if(!apiKey){ setMood('error'); alert('Configure a OpenRouter API Key.'); return null; }
      try{
        const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
          method:'POST',
          headers:{'Content-Type':'application/json','Authorization': 'Bearer ' + apiKey,'HTTP-Referer': location.href,'X-Title': 'Dual Nebula Pro'},
          body: JSON.stringify({ model, messages, temperature:0.7 })
        });
        const data = await res.json();
        if(data.error){ throw new Error(data.error.message || 'Erro na API'); }
        return (data.choices?.[0]?.message?.content||'').trim();
      }catch(err){ setMood('error'); alert('Falha na API: '+err.message); return null; }
    }

    async function send(){
      const q=promptEl.value.trim(); if(!q) return;
      promptEl.value=''; addMsg('user', q); pushHist('user', q);
      setMood('thinking');
      sendBtn.disabled=true; sendBtn.textContent='‚Ä¶';
      const r=await callOpenRouter(buildMessages(q));
      sendBtn.disabled=false; sendBtn.textContent='Enviar';
      if(r!=null){ setMood('speaking'); addMsg('assistant', r); pushHist('assistant', r); speak(r); setTimeout(()=>setMood('idle'), 900); }
    }
    sendBtn.onclick=send; promptEl.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); send(); }});

    // ---------- REACTIVE FACE ----------
    let mood='idle'; let blinkTimer=null;
    const center = {x:60,y:56}; const maxOffset=5;
    function lookAt(x,y){
      // map screen click to pad-local SVG coords (approx via DOM offsets)
      const rect = pad.getBoundingClientRect();
      const px = (x - rect.left) / rect.width * 120;
      const py = (y - rect.top) / rect.height * 120;
      const dx = Math.max(-maxOffset, Math.min(maxOffset, (px - center.x)/6));
      const dy = Math.max(-maxOffset, Math.min(maxOffset, (py - center.y)/6));
      pupilL.setAttribute('cx', 46+dx); pupilL.setAttribute('cy', 56+dy);
      pupilR.setAttribute('cx', 74+dx); pupilR.setAttribute('cy', 56+dy);
    }
    function mouth(shape){
      const shapes = {
        neutral: "M45 84q15 10 30 0",
        grin:    "M42 82q18 16 36 0",
        speak:   "M52 86q8 -6 16 0",
        o:       "M58 86a6 6 0 1 0 4 0",
        flat:    "M45 86H75"
      };
      mouthEl.setAttribute('d', shapes[shape] || shapes.neutral);
    }
    function blink(){
      eyeL.setAttribute('ry', 2); eyeR.setAttribute('ry', 2);
      setTimeout(()=>{ eyeL.setAttribute('ry', 10); eyeR.setAttribute('ry', 10); }, 120);
    }
    function startBlinking(){
      if(blinkTimer) clearInterval(blinkTimer);
      blinkTimer = setInterval(()=>{ if(Math.random()<0.22) blink(); }, 1800);
    }
    function setMood(m){
      mood=m;
      pad.classList.remove('mood-thinking','mood-speaking','mood-saved','mood-error');
      if(m==='thinking'){ pad.classList.add('mood-thinking'); mouth('flat'); }
      else if(m==='speaking'){ pad.classList.add('mood-speaking'); mouth('speak'); }
      else if(m==='saved'){ pad.classList.add('mood-saved'); mouth('grin'); setTimeout(()=>setMood('idle'), 900); }
      else if(m==='error'){ pad.classList.add('mood-error'); mouth('o'); }
      else { mouth('neutral'); }
    }
    function wink(){ blink(); mouth('grin'); setTimeout(()=>mouth('neutral'), 500); }
    function cheer(){ setMood('saved'); }

    document.addEventListener('click', (e)=>{
      // curious look at the touch/click point
      if(!pad.contains(e.target)) lookAt(e.clientX, e.clientY);
    });
    pad.addEventListener('click', (e)=>{ lookAt(e.clientX, e.clientY); wink(); });

    startBlinking(); setMood('idle');

    // ABOUT & UTIL
    $('#chipClear').onclick=()=>{ logEl.innerHTML=''; if(store.cfg.persist!==false) store.hist=[]; cheer(); };
    $('#chipAbout').onclick=()=>{ wink(); alert('Nebula Pro ‚Ä¢ Face reativa (olhar, piscadas, humor em eventos). TTS e salvar agora com bot√µes bonitos.'); };

    // quick demo: fake "salvando credenciais"
    window.addEventListener('storage', ()=> cheer());
  </script>
</body>
</html>