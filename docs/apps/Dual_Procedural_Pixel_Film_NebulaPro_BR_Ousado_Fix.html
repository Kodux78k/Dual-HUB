<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>Procedural Pixel Film ‚Ä¢ Nebula Pro (BR)</title>
<meta name="theme-color" content="#0a0a10">
<style>
  /* Tema Nebula Pro ousado */
  :root{
    --grad-a:#ff00ff;
    --grad-b:#00ffff;
    --grad-angle:42deg;
    --bg:#0a0a10;
    --fg:#eaf9ff;
    --muted:#b8c3d1;
    --glass:#0e0f22cc;
    --stroke:rgba(255,255,255,.08);
    --agua-h:190;  /* azul cyan */
    --fogo-h:15;   /* vermelho laranja */
    --terra-h:45;  /* amarelo */
    --ar-h:160;    /* turquesa */
  }
  html,body{height:100%;margin:0;padding:0;color:var(--fg);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;-webkit-font-smoothing:antialiased;background:
      radial-gradient(120% 80% at 20% -10%, rgba(255,0,255,0.2), transparent 60%),
      radial-gradient(100% 100% at 110% 30%, rgba(0,255,255,0.25), transparent 60%),
      linear-gradient(var(--grad-angle), var(--grad-a), var(--grad-b));
  }
  .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:20px;box-sizing:border-box;}
  .phone{width:min(430px,96vw);border-radius:34px;background:var(--glass);border:1px solid var(--stroke);backdrop-filter:blur(18px) saturate(1.2);box-shadow:0 30px 120px rgba(0,0,0,.55),0 0 180px rgba(255,0,255,.2),0 0 200px rgba(0,255,255,.2);padding:16px 16px 20px;display:flex;flex-direction:column;gap:12px;}
  header{display:flex;align-items:center;justify-content:center;padding-bottom:4px;}
  header h1{margin:0;font-size:22px;font-weight:900;letter-spacing:.3px;}
  .screen{position:relative;height:260px;border-radius:24px;overflow:hidden;border:1.5px solid var(--stroke);background:linear-gradient(180deg,#0b0b18,#0b0b0f);box-shadow:inset 0 0 0 1px rgba(255,255,255,.04),0 0 22px var(--grad-a),0 0 40px var(--grad-b);}
  #film{display:block;width:100%;height:100%;image-rendering:pixelated;}
  #bg{position:fixed;inset:0;z-index:-1;image-rendering:pixelated;opacity:0.4;display:none;}
  /* bot√µes */
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px;}
  .row-els{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:4px;}
  .pill{appearance:none;border:none;border-radius:999px;padding:12px 16px;font-weight:700;letter-spacing:.2px;background:linear-gradient(180deg,#302a6f,#211f57);color:var(--fg);box-shadow:0 8px 26px rgba(0,0,0,.45),0 4px 14px var(--grad-a);cursor:pointer;transition:background .15s,transform .15s;}
  .pill.primary{background:linear-gradient(180deg,var(--grad-a),var(--grad-b));}
  .pill:active{transform:translateY(2px);}
  .pill[disabled]{opacity:.4;pointer-events:none;}
  /* gotas */
  .dotbtn{display:flex;flex-direction:column;align-items:center;justify-content:center;border:none;background:transparent;cursor:pointer;color:var(--fg);font-size:12px;gap:6px;transition:transform .15s;}
  .dotbtn:active{transform:scale(0.96);}
  .dot{width:28px;height:28px;border-radius:50%;box-shadow:0 4px 10px rgba(0,0,0,.4),0 0 8px currentColor;}
  .dot.agua{background:hsl(var(--agua-h),80%,55%);}
  .dot.fogo{background:hsl(var(--fogo-h),80%,55%);}
  .dot.terra{background:hsl(var(--terra-h),80%,55%);}
  .dot.ar{background:hsl(var(--ar-h),80%,55%);}
  .dotbtn.active .dot{box-shadow:0 0 0 3px rgba(255,255,255,.4),0 4px 10px rgba(0,0,0,.5);} 
  .small{font-size:13px;color:var(--muted);}  
  /* livro vivo */
  .panel{background:rgba(10,11,25,0.6);border:1px solid var(--stroke);border-radius:18px;padding:14px;box-shadow:inset 0 0 0 1px rgba(255,255,255,.05);display:flex;flex-direction:column;gap:8px;}
  textarea{width:100%;height:100px;border:1px solid var(--stroke);border-radius:8px;background:rgba(0,0,0,.2);color:var(--fg);padding:8px;font-family:inherit;font-size:14px;resize:none;}
  select,input[type=range]{width:100%;}
  .progress{height:4px;background:rgba(255,255,255,.1);border-radius:4px;overflow:hidden;}
  .progress i{display:block;width:0;height:100%;background:linear-gradient(90deg,var(--grad-a),var(--grad-b));transition:width .15s;}
  .footer{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-top:8px;}
</style>
</head>
<body>
<div class="wrap">
  <div class="phone">
    <header><h1>Procedural Pixel Film ‚ö°</h1></header>
    <div class="screen"><canvas id="film" aria-label="Filme Procedural"></canvas></div>
    <div class="row">
      <button class="pill primary" id="btnPlay">Respirar Pulso</button>
      <button class="pill" id="btnPause">Silenciar Pulso</button>
    </div>
    <div class="row-els">
      <button class="dotbtn active" data-el="agua"><span class="dot agua"></span><span>√Ågua</span></button>
      <button class="dotbtn" data-el="fogo"><span class="dot fogo"></span><span>Fogo</span></button>
      <button class="dotbtn" data-el="terra"><span class="dot terra"></span><span>Terra</span></button>
      <button class="dotbtn" data-el="ar"><span class="dot ar"></span><span>Ar</span></button>
    </div>
    <div class="row">
      <button class="pill" id="btnMic">Escutar o Mundo</button>
      <button class="pill" id="btnBreeze">Soprar o Vento</button>
    </div>
    <div class="row">
      <button class="pill" id="btnExport">Guardar Rastro</button>
      <button class="pill" id="btnImport">Reinvocar Filme</button>
    </div>
    <div class="row">
      <button class="pill" id="btnFreeze">Espiral Congelada</button>
      <button class="pill" id="btnRecord">Gravar Pulso</button>
    </div>
    <div class="small"><label><input id="toggleBg" type="checkbox"> Plano de Fundo</label></div>
    <div class="panel">
      <strong>üìñ Livro Vivo</strong>
      <small>Narre o texto abaixo e acompanhe o progresso. (Som precisa de intera√ß√£o no iOS)</small>
      <textarea id="story">No princ√≠pio do Pulso, a √°gua lembrava caminhos que ainda n√£o tinham nome. Cada pixel era uma gota, cada gota, um planeta. Respire, e o filme te respira de volta.</textarea>
      <div class="row"><div><small>Voz</small><select id="voiceSel"></select></div><div><small>Volume</small><input id="ttsVol" type="range" min="0" max="1" step="0.01" value="1"></div></div>
      <div class="row"><button class="pill" id="ttsSpeak">Narrar</button><button class="pill" id="ttsStop">Parar</button></div>
      <div class="progress" aria-label="Progresso"><i id="ttsProg"></i></div>
    </div>
    <div class="footer">
      <span>Nebula Pro ‚Ä¢ BR ousado</span>
      <span id="status">‚è∏Ô∏è Pausado</span>
    </div>
  </div>
</div>
<canvas id="bg" aria-hidden="true"></canvas>
<script>
(function(){
  const els = {
    film: document.getElementById('film'),
    bg: document.getElementById('bg'),
    status: document.getElementById('status'),
    btnPlay: document.getElementById('btnPlay'),
    btnPause: document.getElementById('btnPause'),
    btnFreeze: document.getElementById('btnFreeze'),
    btnMic: document.getElementById('btnMic'),
    btnBreeze: document.getElementById('btnBreeze'),
    btnExport: document.getElementById('btnExport'),
    btnImport: document.getElementById('btnImport'),
    btnRecord: document.getElementById('btnRecord'),
    toggleBg: document.getElementById('toggleBg'),
    story: document.getElementById('story'),
    voiceSel: document.getElementById('voiceSel'),
    ttsVol: document.getElementById('ttsVol'),
    ttsSpeak: document.getElementById('ttsSpeak'),
    ttsStop: document.getElementById('ttsStop'),
    ttsProg: document.getElementById('ttsProg'),
  };

  // estados
  let running = false;
  let frozen = false;
  let baseHue = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--agua-h')) || 190;

  // ajusta tamanhos
  function fit(){
    const rect = els.film.parentElement.getBoundingClientRect();
    els.film.width = rect.width;
    els.film.height = rect.height;
    els.bg.width = window.innerWidth;
    els.bg.height = window.innerHeight;
  }
  window.addEventListener('resize', fit, {passive:true});
  fit();

  const ctx = els.film.getContext('2d');
  const ctxBG = els.bg.getContext('2d');

  function drawFrame(ctx, w, h){
    // fundo fade
    ctx.fillStyle = 'rgba(0,0,0,0.08)';
    ctx.fillRect(0,0,w,h);
    const t = performance.now()*0.05;
    // desenha blocos coloridos
    const p = 8;
    for(let x=0; x<w; x+=p){
      for(let y=0; y<h; y+=p){
        const hue = (baseHue + (x+y)*0.3 + t) % 360;
        ctx.fillStyle = `hsl(${hue},80%,55%)`;
        ctx.fillRect(x,y,p,p);
      }
    }
  }

  function loop(){
    if(running && !frozen){
      drawFrame(ctx, els.film.width, els.film.height);
      if(!els.bg.hidden){
        drawFrame(ctxBG, els.bg.width, els.bg.height);
      }
    }
    requestAnimationFrame(loop);
  }
  loop();

  // Elementos (gotas)
  document.querySelectorAll('.dotbtn[data-el]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.dotbtn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const el = btn.getAttribute('data-el');
      switch(el){
        case 'agua': baseHue = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--agua-h')); break;
        case 'fogo': baseHue = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--fogo-h')); break;
        case 'terra': baseHue = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--terra-h')); break;
        case 'ar': baseHue = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--ar-h')); break;
      }
    });
  });

  els.btnPlay.onclick = ()=>{ running=true; els.status.textContent='‚ñ∂Ô∏è Rodando'; };
  els.btnPause.onclick = ()=>{ running=false; els.status.textContent='‚è∏Ô∏è Pausado'; };
  els.btnFreeze.onclick = ()=>{ frozen=!frozen; els.btnFreeze.textContent = frozen? 'Descongelar' : 'Espiral Congelada'; };
  els.btnBreeze.onclick = ()=>{ baseHue = Math.floor(Math.random()*360); };
  els.toggleBg.onchange = ()=>{ els.bg.hidden = !els.toggleBg.checked; };

  els.btnExport.onclick = ()=>{
    const state = {baseHue};
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([JSON.stringify(state)], {type:'application/json'}));
    a.download = 'pulso-state.json';
    a.click();
  };
  els.btnImport.onclick = ()=>{
    const inp=document.createElement('input');
    inp.type='file';
    inp.accept='.json,application/json';
    inp.onchange = async () => {
      const s = JSON.parse(await inp.files[0].text());
      baseHue = s.baseHue || baseHue;
    };
    inp.click();
  };

  els.btnRecord.onclick = ()=>{
    const stream = els.film.captureStream(30);
    const rec = new MediaRecorder(stream,{mimeType:'video/webm;codecs=vp9'});
    const chunks=[];
    rec.ondataavailable=e=>{ if(e.data.size) chunks.push(e.data); };
    rec.onstop=()=>{
      const url=URL.createObjectURL(new Blob(chunks,{type:'video/webm'}));
      const a=document.createElement('a');
      a.href=url;a.download='pulso.webm';a.click();
      els.btnRecord.textContent='Gravar Pulso';
    };
    rec.start();
    els.btnRecord.textContent='‚è∫ Gravando 15s...';
    setTimeout(()=>rec.stop(),15000);
  };

  // ===== TTS =====
  function loadVoices(){
    const voices = speechSynthesis.getVoices();
    els.voiceSel.innerHTML='';
    voices.filter(v=>/pt|en/i.test(v.lang)).forEach(v=>{
      const o=document.createElement('option');
      o.value=v.name;
      o.textContent = `${v.name} (${v.lang})`;
      els.voiceSel.appendChild(o);
    });
  }
  loadVoices();
  speechSynthesis.onvoiceschanged = loadVoices;
  let utter = null;
  els.ttsSpeak.onclick = ()=>{
    speechSynthesis.cancel();
    utter = new SpeechSynthesisUtterance(els.story.value);
    const v = speechSynthesis.getVoices().find(x=>x.name===els.voiceSel.value);
    if(v) utter.voice = v;
    utter.lang = 'pt-BR';
    utter.rate = 1.0;
    utter.pitch = 1.0;
    utter.volume = parseFloat(els.ttsVol.value||'1');
    utter.onboundary = e=>{
      const x = Math.min(1,(e.charIndex/(els.story.value.length||1)));
      els.ttsProg.style.width = (x*100).toFixed(1)+'%';
    };
    utter.onend = ()=>{
      els.ttsProg.style.width='100%';
      setTimeout(()=>els.ttsProg.style.width='0%',600);
    };
    speechSynthesis.speak(utter);
  };
  els.ttsStop.onclick = ()=>{ speechSynthesis.cancel(); els.ttsProg.style.width='0%'; };
})();
</script>
</body>
</html>
