<!doctype html>
<html lang="pt-br"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
<title>DUAL ‚Ä¢ UNO¬∑DUAL¬∑TRINITY ‚Äî Hub M0</title>
<meta name="theme-color" content="#0b0b14">
<style>
  :root{
    --bg:#0a0b13; --bg2:#0b0d1a; --fg:#e9ecff; --mut:#9aa4c7;
    --acc:#a77cff; --acc2:#29d3ff; --mag:#ff5bd4; --ok:#5bffcf;
    --ring:rgba(167,124,255,.35); --shadow:0 12px 36px rgba(0,0,0,.45);
    --r:20px; --tabsH:72px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--fg);
    background:radial-gradient(1200px 900px at 50% -120px,#2a1e60 0%,#1c1540 45%,#0b0d1a 80%,#070812 100%), #05060c;
    font:14px/1.45 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    overflow:hidden;
  }
  .app{position:relative; height:100%; display:flex; flex-direction:column;
       padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)}
  header.top{
    height:56px; display:flex; gap:10px; align-items:center; padding:10px 14px;
    position:sticky; top:0; z-index:50;
    backdrop-filter:saturate(120%) blur(8px);
    background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));
    border-bottom:1px solid #ffffff12;
  }
  .brand{font-weight:900; letter-spacing:.18em; display:flex; gap:.5ch; align-items:center}
  .dot{width:8px; height:8px; border-radius:50%; background:var(--acc); box-shadow:0 0 18px var(--acc)}
  .hbtn{height:34px; min-width:34px; display:grid; place-items:center; border-radius:12px;
        border:1px solid #ffffff18; background:linear-gradient(180deg,#161a2e,#0e1124); color:var(--fg); cursor:pointer}
  main{flex:1; position:relative}
  .view{position:absolute; inset:0; padding:12px; padding-bottom:calc(var(--tabsH) + 14px);
        overflow:auto; display:none}
  .view.active{display:block; animation:fade .22s ease-out}
  @keyframes fade{from{opacity:0; transform:translateY(6px)}}
  .grid{display:grid; gap:12px}
  .cards{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px}
  @media (max-width:520px){ .cards{grid-template-columns:1fr} }
  .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));
        border:1px solid #ffffff12; border-radius:var(--r); box-shadow:var(--shadow);
        padding:14px; min-height:96px; display:flex; gap:10px}
  .ico{width:48px; height:48px; border-radius:14px; display:grid; place-items:center;
       background:linear-gradient(180deg,#1b1f37,#0e1228); border:1px solid #ffffff10}
  .muted{color:var(--mut); font-size:12px}
  /* Brain drawer */
  .brain{position:fixed; right:0; top:0; bottom:0; width:380px; max-width:92vw; z-index:80;
         transform:translateX(105%); transition:transform .28s ease;
         background:linear-gradient(180deg,rgba(15,16,32,.97),rgba(15,16,32,.92));
         border-left:1px solid #ffffff14; box-shadow:-12px 0 40px rgba(0,0,0,.55); padding:12px}
  .brain.open{transform:translateX(0)}
  .sec{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));
       border:1px solid #ffffff12; border-radius:16px; padding:10px}
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .input, textarea, select{width:100%; background:#0f1426; color:var(--fg); border:1px solid #ffffff1a;
                           border-radius:10px; padding:10px}
  .pill{font-size:11px; color:#a6b8ff; letter-spacing:.05em}
  .btn{appearance:none; border:1px solid #ffffff1a; background:linear-gradient(180deg,#11162a,#0b1122);
       color:var(--fg); font-weight:800; border-radius:10px; padding:.55rem .85rem; cursor:pointer}
  .btn.prime{background:linear-gradient(90deg,var(--acc),var(--acc2)); color:#0b0b14; border-color:transparent}
  .mini{font:12px/1.2 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space:pre-wrap}
  /* Stack (apps em sess√µes) */
  .session{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.005));
           border:1px solid #ffffff12; border-radius:16px; box-shadow:var(--shadow); overflow:hidden}
  .session .hdr{display:flex; align-items:center; gap:8px; padding:10px; background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02)); border-bottom:1px solid #ffffff10}
  .session .title{font-weight:800}
  .session .tools{margin-left:auto; display:flex; gap:6px}
  .session iframe{display:block; width:100%; height:60vh; border:0; background:#000}
  .session.min iframe{display:none}
  /* Footer nav */
  nav.tabs{
    position:fixed; left:0; right:0; bottom:0; height:var(--tabsH); z-index:70;
    display:flex; justify-content:space-around; align-items:center; gap:10px;
    padding:10px 14px env(safe-area-inset-bottom);
    backdrop-filter: blur(8px); background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.06));
    border-top:1px solid #ffffff12;
  }
  .tab{--sz:44px; width:var(--sz); height:var(--sz); border-radius:14px; display:grid; place-items:center;
       border:1px solid #ffffff14; background:linear-gradient(180deg,#12152a,#0d1124); box-shadow:var(--shadow); opacity:.85}
  .tab.active{opacity:1; outline:1px solid var(--ring)}
  /* Quick dock (badges dos apps abertos) */
  .dock{position:fixed; left:10px; right:10px; bottom:calc(var(--tabsH) + 8px); display:flex; gap:8px; flex-wrap:wrap; z-index:60}
  .badge{display:inline-flex; gap:6px; align-items:center; padding:.35rem .6rem; border:1px solid #ffffff18;
         background:#0f1428; border-radius:999px; font-weight:800; cursor:pointer}
  /* Portrait safeguards */
  html, body { overflow-x:hidden }
</style>
</head>
<body class="theme-nebula">
<div class="app">
  <header class="top">
    <div class="brand">DUAL <span class="dot"></span> HUB</div>
    <div style="margin-left:auto" class="row">
      <button id="btnDownload" class="hbtn" title="Baixar esta p√°gina">‚§ì</button>
      <button id="btnBrain" class="hbtn" title="Dual Brain">üë§</button>
    </div>
  </header>

  <main>
    <!-- HOME -->
    <section id="view-home" class="view active">
      <div class="grid">
        <div class="card" style="display:block">
          <div class="row" style="justify-content:space-between">
            <div>
              <div style="font-weight:800; letter-spacing:.06em">UNO ‚Ä¢ DUAL ‚Ä¢ TRINITY</div>
              <div class="muted">Header fixo + Stack vertical de apps + Trinity</div>
            </div>
            <div class="ico">‚ö°</div>
          </div>
        </div>

        <div class="cards">
          <button class="card" data-open="apps">
            <div class="ico">üóÇ</div>
            <div>
              <div style="font-weight:800">Apps</div>
              <div class="muted">Cat√°logo (apps.json) + Locais</div>
            </div>
          </button>
          <button class="card" data-open="stack">
            <div class="ico">‚¨õ</div>
            <div>
              <div style="font-weight:800">Stack</div>
              <div class="muted">Sess√µes abertas (min/fechar)</div>
            </div>
          </button>
          <button class="card" data-open="trinity">
            <div class="ico">‚óê</div>
            <div>
              <div style="font-weight:800">Trinity</div>
              <div class="muted">Fus√£o com Dual-App/Hubs</div>
            </div>
          </button>
          <button class="card" data-open="brain">
            <div class="ico">üß†</div>
            <div>
              <div style="font-weight:800">Dual Brain</div>
              <div class="muted">Nome, SK, Treinamento, TTS</div>
            </div>
          </button>
        </div>

        <div class="sec">
          <div class="pill">Dica</div>
          Use o bot√£o **‚§ì** no header para baixar esta vers√£o com o seu estado salvo (localStorage n√£o vai junto).
        </div>
      </div>
    </section>

    <!-- APPS -->
    <section id="view-apps" class="view">
      <div class="grid">
        <div class="sec">
          <div class="row">
            <input id="appSearch" class="input" placeholder="Buscar‚Ä¶">
            <select id="appSort" class="input" style="max-width:160px">
              <option value="az">A‚ÄìZ</option>
              <option value="za">Z‚ÄìA</option>
            </select>
            <label class="row" style="font-size:12px; color:#a6b8ff">
              <input id="openInside" type="checkbox" checked="">&nbsp;abrir dentro do hub
            </label>
          </div>
          <div class="row" style="margin-top:8px">
            <input id="fileLocal" type="file" accept=".html,.htm" multiple="" class="input">
            <button id="btnImportLocals" class="btn">Adicionar Locais</button>
            <button id="btnExportLocals" class="btn">Exportar Locais</button>
            <button id="btnClearLocals" class="btn">Limpar Locais</button>
          </div>
          <div id="appsCount" class="pill" style="margin-top:6px">9 apps</div>
        </div>

        <div id="appsWrap" class="grid"><div class="card"><div class="ico">üß©</div><div style="flex: 1 1 0%;"><div style="font-weight: 800;">Archetype_Audio_Player</div><div class="muted">HTML local</div><div class="row" style="margin-top: 8px;"><button class="btn">Abrir</button><button class="btn">‚éò Injection</button></div></div></div><div class="card"><div class="ico">üß©</div><div style="flex: 1 1 0%;"><div style="font-weight: 800;">Dual_Hub_ZIndex_Online1</div><div class="muted">HTML local</div><div class="row" style="margin-top: 8px;"><button class="btn">Abrir</button><button class="btn">‚éò Injection</button></div></div></div><div class="card"><div class="ico">üß©</div><div style="flex: 1 1 0%;"><div style="font-weight: 800;">Dual_Masterclass_NebulaPro-2</div><div class="muted">HTML local</div><div class="row" style="margin-top: 8px;"><button class="btn">Abrir</button><button class="btn">‚éò Injection</button></div></div></div><div class="card"><div class="ico">üß©</div><div style="flex: 1 1 0%;"><div style="font-weight: 800;">HUB_Dual_2</div><div class="muted">HTML local</div><div class="row" style="margin-top: 8px;"><button class="btn">Abrir</button><button class="btn">‚éò Injection</button></div></div></div><div class="card"><div class="ico">üß©</div><div style="flex: 1 1 0%;"><div style="font-weight: 800;">hub_dual_trinity_0</div><div class="muted">HTML local</div><div class="row" style="margin-top: 8px;"><button class="btn">Abrir</button><button class="btn">‚éò Injection</button></div></div></div><div class="card"><div class="ico">üß©</div><div style="flex: 1 1 0%;"><div style="font-weight: 800;">HUB_DUAL_Uno_PixelPerfect</div><div class="muted">HTML local</div><div class="row" style="margin-top: 8px;"><button class="btn">Abrir</button><button class="btn">‚éò Injection</button></div></div></div><div class="card"><div class="ico">üß©</div><div style="flex: 1 1 0%;"><div style="font-weight: 800;">HUB_DUAL_Uno_PixelPerfect_v2 2</div><div class="muted">HTML local</div><div class="row" style="margin-top: 8px;"><button class="btn">Abrir</button><button class="btn">‚éò Injection</button></div></div></div><div class="card"><div class="ico">üß©</div><div style="flex: 1 1 0%;"><div style="font-weight: 800;">hub_dual_variant_A</div><div class="muted">HTML local</div><div class="row" style="margin-top: 8px;"><button class="btn">Abrir</button><button class="btn">‚éò Injection</button></div></div></div><div class="card"><div class="ico">üß©</div><div style="flex: 1 1 0%;"><div style="font-weight: 800;">hub_dual_variant_B</div><div class="muted">HTML local</div><div class="row" style="margin-top: 8px;"><button class="btn">Abrir</button><button class="btn">‚éò Injection</button></div></div></div></div>
      </div>
    </section>

    <!-- STACK (sess√µes) -->
    <section id="view-stack" class="view">
      <div id="stackWrap" class="grid"></div>
    </section>

    <!-- TRINITY (ponte simples) -->
    <section id="view-trinity" class="view">
      <div class="grid">
        <div class="card">
          <div class="ico">‚óé</div>
          <div style="flex:1">
            <div style="font-weight:800">Dual-App acoplado</div>
            <div class="muted">Abre em viewer interno (iframe)</div>
            <div class="row" style="margin-top:8px">
              <input id="trinityUrl" class="input" placeholder="./index.html ou app do Dual">
              <button id="btnOpenTrinity" class="btn prime">Abrir</button>
            </div>
          </div>
        </div>
        <div class="sec mini" id="trinityLog">‚Äî</div>
      </div>
    </section>
  </main>

  <!-- Dock de sess√µes (reabrir r√°pido) -->
  <div id="dock" class="dock"></div>

  <!-- Footer -->
  <nav class="tabs">
    <button class="tab active" data-nav="home" title="Home">‚åÇ</button>
    <button class="tab" data-nav="apps" title="Apps">üóÇ</button>
    <button class="tab" data-nav="stack" title="Stack">‚¨õ</button>
    <button class="tab" data-nav="trinity" title="Trinity">‚óê</button>
  </nav>

  <!-- Brain Drawer -->
  <aside id="brain" class="brain" aria-label="Dual Brain">
    <div class="row" style="justify-content:space-between; margin-bottom:8px">
      <div style="font-weight:800; letter-spacing:.06em">AETHER ‚Ä¢ BRAIN</div>
      <button id="brainClose" class="hbtn">‚úï</button>
    </div>

    <div class="grid">
      <div class="sec">
        <div class="pill">Usu√°rio</div>
        <div class="row" style="margin-top:6px">
          <input id="userName" class="input" placeholder="Seu nome">
          <button id="saveName" class="btn prime">Salvar</button>
        </div>
      </div>

      <div class="sec">
        <div class="pill">OpenRouter SK</div>
        <div class="row" style="margin-top:6px">
          <input id="userSK" class="input" placeholder="sk-or-v1-‚Ä¶">
          <button id="btnPasteSK" class="btn">üìã Colar</button>
          <button id="saveSK" class="btn prime">Salvar</button>
        </div>
      </div>

      <div class="sec">
        <div class="pill">Treinamento</div>
        <textarea id="training" rows="5" class="input" placeholder="Cole seu treinamento‚Ä¶"></textarea>
        <div class="row" style="justify-content:flex-end; margin-top:6px">
          <button id="saveTraining" class="btn">Salvar</button>
        </div>
      </div>

      <div class="sec">
        <div class="pill">Vozes por Arqu√©tipo (TTS)</div>
        <div id="voiceMap" class="grid"></div>
        <div class="row" style="margin-top:8px">
          <select id="ttsPreset" class="input" style="max-width:200px">
            <option value="natural">Voz Natural</option>
            <option value="neutra">Voz Neutra</option>
            <option value="dinamica">Voz Din√¢mica</option>
          </select>
          <button id="ttsTest" class="btn">Testar</button>
        </div>
        <div class="pill" style="margin-top:6px">Chaves: dual.brain.voice.* ‚Ä¢ infodose:ttsPreset</div>
      </div>

      <div class="sec">
        <div class="pill">Desempenho &amp; Tema</div>
        <div class="row" style="margin-top:6px">
          <select id="perf" class="input" style="max-width:180px">
            <option>Low</option><option selected="">Medium</option><option>High</option>
          </select>
          <select id="theme" class="input" style="max-width:180px">
            <option value="nebula" selected="">NebulaPro</option>
            <option value="luxara">Luxara</option>
            <option value="ignyra">Ignyra</option>
            <option value="elysha">Elysha</option>
          </select>
        </div>
      </div>

      <div class="sec">
        <div class="pill">Logs</div>
        <pre id="log" class="mini" style="min-height:120px">01:37:44 ‚Ä¢ Sem apps.json ‚Äî use ./apps/apps.json
</pre>
        <div class="row">
          <button id="btnExportBrain" class="btn">Exportar Brain</button>
          <button id="btnClearLS" class="btn">Limpar LS</button>
        </div>
      </div>
    </div>
  </aside>
</div>

<script>
/* ========= Core Helpers ========= */
const $ = (q, root=document)=>root.querySelector(q);
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
function speakOnce(text){
  try{
    if(!('speechSynthesis' in window)) return;
    const u = new SpeechSynthesisUtterance(String(text||'').replace(/\s+/g,' ').trim());
    const vs = speechSynthesis.getVoices();
    const v = vs.find(v=>/pt[-_]?br/i.test(v.lang||'')) || vs[0];
    if(v){ u.voice=v; u.lang=v.lang; } else { u.lang='pt-BR'; }
    u.rate = 0.95; u.pitch = 1.05; speechSynthesis.cancel(); speechSynthesis.speak(u);
  }catch{}
}
function lsGet(k,d=null){ try{ const v=localStorage.getItem(k); return v===null?d:v }catch{ return d } }
function lsSet(k,v){ try{ localStorage.setItem(k,v) }catch{} }
function log(msg){ const box = $('#log'); if(!box) return; box.textContent = (new Date().toLocaleTimeString()+' ‚Ä¢ '+msg+'\n') + box.textContent }

/* ========= Router ========= */
const views = {home:$('#view-home'), apps:$('#view-apps'), stack:$('#view-stack'), trinity:$('#view-trinity')};
function navTo(key){
  Object.values(views).forEach(v=>v.classList.remove('active'));
  (views[key]||views.home).classList.add('active');
  document.querySelectorAll('nav.tabs .tab').forEach(b=>b.classList.toggle('active', b.dataset.nav===key));
}
document.querySelectorAll('[data-nav]').forEach(b=> b.addEventListener('click', ()=> navTo(b.dataset.nav)));
document.querySelectorAll('[data-open]').forEach(c=> c.addEventListener('click', ()=>{
  const t = c.dataset.open;
  if(t==='brain') openBrain(true);
  else navTo(t);
}));

/* ========= Brain ========= */
const ARCHS = ["Atlas","Nova","Elysha","Kaion","Artemis","Serena","Vitalis","Pulse","Aion","Rhea","Genus","Lumine"];
const brain = $('#brain');
$('#btnBrain').onclick = ()=> openBrain(true);
$('#brainClose').onclick = ()=> openBrain(false);
function openBrain(on){ brain.classList.toggle('open', !!on); if(on) syncBrainUI(); }

function readBrain(){
  let b={}; try{ b = JSON.parse(lsGet('infodose:brain','{}')) || {}; }catch{}
  b.userName = b.userName || lsGet('infodose:userName','');
  b.userSK   = b.userSK   || lsGet('infodose:userSK','');
  b.training = b.training || '';
  b.ttsPreset= b.ttsPreset|| lsGet('infodose:ttsPreset','natural');
  return b;
}
function writeBrain(obj){
  lsSet('infodose:brain', JSON.stringify(obj||{}));
}
async function syncBrainUI(){
  const b = readBrain();
  $('#userName').value = b.userName||'';
  $('#userSK').value   = b.userSK||'';
  $('#training').value = b.training||'';
  $('#ttsPreset').value= b.ttsPreset||'natural';
  // Map de vozes
  buildVoiceMapper();
}

$('#saveName').onclick = ()=>{
  const b=readBrain(); b.userName = $('#userName').value.trim(); writeBrain(b);
  lsSet('infodose:userName', b.userName||'');
  log('Nome salvo: '+(b.userName||''));
};
$('#btnPasteSK').onclick = async ()=>{
  try{ $('#userSK').value = (await navigator.clipboard.readText()).trim(); }catch{}
};
$('#saveSK').onclick = ()=>{
  const b=readBrain(); b.userSK = $('#userSK').value.trim(); writeBrain(b);
  lsSet('infodose:userSK', b.userSK||'');
  log('SK salvo (local)');
};
$('#saveTraining').onclick = ()=>{
  const b=readBrain(); b.training = $('#training').value||''; writeBrain(b);
  log('Treinamento salvo');
};
$('#ttsPreset').onchange = ()=>{
  const v = $('#ttsPreset').value||'natural';
  const b = readBrain(); b.ttsPreset = v; writeBrain(b);
  lsSet('infodose:ttsPreset', v);
  log('Preset TTS: '+v);
};
$('#ttsTest').onclick = ()=> speakOnce('Teste de voz do seu Hub UNO¬∑DUAL¬∑TRINITY');

$('#btnExportBrain').onclick = ()=>{
  const blob = new Blob([lsGet('infodose:brain','{}')], {type:'application/json'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='infodose_brain.json'; a.click();
};
$('#btnClearLS').onclick = ()=>{
  if(confirm('Limpar localStorage deste dom√≠nio?')){ localStorage.clear(); location.reload(); }
};

function buildVoiceMapper(){
  const wrap = $('#voiceMap'); wrap.innerHTML='';
  const vs = speechSynthesis.getVoices()||[];
  ARCHS.forEach(a=>{
    const row = document.createElement('div'); row.className='row';
    const lab = document.createElement('div'); lab.textContent = a; lab.style.minWidth='84px';
    const sel = document.createElement('select'); sel.className='input'; sel.dataset.arch=a;
    vs.forEach(v=>{ const o=document.createElement('option'); o.value=v.name; o.textContent=`${v.name} ‚Äî ${v.lang}`; sel.appendChild(o); });
    const saved = lsGet('dual.brain.voice.'+a, '');
    if(saved) sel.value = saved;
    sel.onchange = ()=> lsSet('dual.brain.voice.'+a, sel.value);
    row.appendChild(lab); row.appendChild(sel);
    wrap.appendChild(row);
  });
}
if('speechSynthesis' in window){ speechSynthesis.onvoiceschanged = ()=>{ if(brain.classList.contains('open')) buildVoiceMapper(); }; }

/* ========= Download p√°gina ========= */
$('#btnDownload').onclick = ()=>{
  const html = '<!doctype html>\n'+document.documentElement.outerHTML;
  const blob = new Blob([html], {type:'text/html'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='DUAL_Hub_UNO-DUAL-TRINITY_M0.html'; a.click();
};

/* ========= APPS: cat√°logo + locais ========= */
const RAW = { groups:null, apps:null };
const FALLBACK_GROUPS = { base:[] };
const appsWrap = $('#appsWrap'), appsCount = $('#appsCount');
const openInside = $('#openInside');

function normalizeApps(list){
  return (list||[]).map(x=>({
    key: x.key || x.url,
    title: x.title || x.key || 'App',
    desc: x.desc || '',
    url: x.url,
    icon: x.icon || '',
    tags: Array.isArray(x.tags)? x.tags : []
  }));
}
function localsAsApps(){
  let arr=[]; try{ arr = JSON.parse(lsGet('infodose:locals:v1','[]'))||[] }catch{}
  return arr.map(l=>({ key:'local:'+l.id, title:l.name||'Local', desc:'HTML local', url:'local:'+l.id, icon:'', tags:['local']}));
}
function getLocalById(id){
  let arr=[]; try{ arr = JSON.parse(lsGet('infodose:locals:v1','[]'))||[] }catch{}
  return arr.find(x=>x.id===id)||null;
}
function blobUrlFromLocal(local){
  const blob = new Blob([local.html||''], {type:'text/html;charset=utf-8'});
  return URL.createObjectURL(blob);
}

function appCard(a){
  const el=document.createElement('div'); el.className='card';
  const ico=document.createElement('div'); ico.className='ico'; ico.textContent='üß©';
  if(a.icon){ try{ ico.innerHTML = '<img src="'+a.icon+'" alt="" style="width:100%;height:100%;object-fit:cover;border-radius:12px">'; }catch{} }
  const meta=document.createElement('div'); meta.style.flex='1';
  const t=document.createElement('div'); t.style.fontWeight='800'; t.textContent=a.title;
  const d=document.createElement('div'); d.className='muted'; d.textContent=a.desc||'';
  const row=document.createElement('div'); row.className='row'; row.style.marginTop='8px';
  const btn=document.createElement('button'); btn.className='btn'; btn.textContent='Abrir';
  const inj=document.createElement('button'); inj.className='btn'; inj.textContent='‚éò Injection';
  btn.onclick = ()=> openApp(a);
  inj.onclick = ()=> copyInjection();
  meta.appendChild(t); meta.appendChild(d); meta.appendChild(row);
  row.appendChild(btn); row.appendChild(inj);
  el.appendChild(ico); el.appendChild(meta);
  return el;
}
function renderApps(list){
  appsWrap.innerHTML='';
  const q = ($('#appSearch').value||'').toLowerCase();
  const mode = $('#appSort').value;
  let L = normalizeApps(list).concat(localsAsApps());
  if(q){
    L = L.filter(a=> (a.title+' '+a.desc+' '+a.key+' '+a.url+' '+(a.tags||[]).join(' ')).toLowerCase().includes(q));
  }
  L.sort((a,b)=> (mode==='za'? -1:1) * String(a.title||'').localeCompare(b.title||''));
  L.forEach(a=> appsWrap.appendChild(appCard(a)));
  appsCount.textContent = `${L.length} apps`;
}
$('#appSearch').oninput = ()=> renderApps((RAW.apps||[]));
$('#appSort').onchange = ()=> renderApps((RAW.apps||[]));

async function tryFetchJson(u){
  const r = await fetch(u, {cache:'no-store'}); if(!r.ok) throw 0; return r.json();
}
async function loadApps(){
  let data=null;
  const cands=['./apps/apps.json','./apps.json','./docs/apps/apps.json','/apps/apps.json'];
  for(const u of cands){ try{ data = await tryFetchJson(u); break; }catch(e){} }
  if(!data){ log('Sem apps.json ‚Äî use ./apps/apps.json'); data={apps:[]}; }
  RAW.apps = Array.isArray(data.apps) ? data.apps : [];
  renderApps(RAW.apps);
}
loadApps();

/* Locais */
$('#btnImportLocals').onclick = async()=>{
  const files = Array.from($('#fileLocal').files||[]);
  if(!files.length) return;
  const tasks = files.map(f=> new Promise(res=>{
    const r=new FileReader(); r.onload=()=> res({ id:'l_'+Math.random().toString(36).slice(2), name:f.name.replace(/\.(html?|txt)$/i,''), html:String(r.result||''), ts:Date.now() }); r.readAsText(f);
  }));
  const list = await Promise.all(tasks);
  const cur = JSON.parse(lsGet('infodose:locals:v1','[]')||'[]'); list.forEach(x=> cur.unshift(x));
  lsSet('infodose:locals:v1', JSON.stringify(cur)); renderApps(RAW.apps);
};
$('#btnExportLocals').onclick = ()=>{
  const data = { v:1, when:Date.now(), items: JSON.parse(lsGet('infodose:locals:v1','[]')||'[]') };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='locals_pack.json'; a.click();
};
$('#btnClearLocals').onclick = ()=>{
  if(confirm('Limpar HTMLs locais salvos?')){ localStorage.removeItem('infodose:locals:v1'); renderApps(RAW.apps); }
};

/* ========= Stack (sess√µes) ========= */
const stackWrap = $('#stackWrap');
const dock = $('#dock');
function sessionBadge(item){
  const b=document.createElement('button'); b.className='badge'; b.textContent = item.title||'App';
  b.title = 'Reabrir '+(item.title||'App');
  b.onclick = ()=>{ const s = document.querySelector('[data-sid="'+item.sid+'"]'); if(s){ s.scrollIntoView({behavior:'smooth'}); s.classList.remove('min'); } };
  return b;
}
function updateDock(){
  dock.innerHTML=''; document.querySelectorAll('.session').forEach(s=>{
    const meta=JSON.parse(s.dataset.meta||'{}'); dock.appendChild(sessionBadge({title:meta.title, sid:s.dataset.sid}));
  });
}
function openApp(a){
  const sid = 's_'+Math.random().toString(36).slice(2);
  const localRef = String(a.url||'').startsWith('local:') ? getLocalById(String(a.url).slice(6)) : null;
  const url = localRef ? blobUrlFromLocal(localRef) : a.url;
  const card=document.createElement('div'); card.className='session'; card.dataset.sid=sid; card.dataset.meta=JSON.stringify({title:a.title||'App', url:a.url||''});
  card.innerHTML = `
    <div class="hdr">
      <div class="title">${(a.title||'App')}</div>
      <div class="muted" style="font-size:12px">${(a.desc||'')}</div>
      <div class="tools">
        <button class="hbtn" data-act="min" title="Minimizar">‚Äî</button>
        <button class="hbtn" data-act="ref" title="Recarregar">‚Üª</button>
        <button class="hbtn" data-act="close" title="Fechar">‚úï</button>
      </div>
    </div>
    <iframe src="${url||'about:blank'}" allow="autoplay; clipboard-read; clipboard-write; picture-in-picture; fullscreen"></iframe>
  `;
  stackWrap.prepend(card);
  card.querySelector('[data-act=min]').onclick = ()=>{ card.classList.toggle('min'); updateDock(); };
  card.querySelector('[data-act=ref]').onclick = ()=>{ const fr=card.querySelector('iframe'); try{ fr.contentWindow.location.reload(); }catch{ fr.src=fr.src; } };
  card.querySelector('[data-act=close]').onclick = ()=>{ card.remove(); updateDock(); };
  if(openInside.checked) navTo('stack');
  updateDock();
}

/* ========= Trinity: ponte simples ========= */
$('#btnOpenTrinity').onclick = ()=>{
  const u = ($('#trinityUrl').value||'').trim(); if(!u) return;
  openApp({title:'Trinity', url:u, desc:'Viewer integrado'});
  $('#trinityLog').textContent = new Date().toLocaleTimeString()+' ‚Ä¢ aberto: '+u;
};

/* ========= Injection snippet (√∫til) ========= */
function copyInjection(){
  const inj = `
<!-- INFODOSE: footer -->
<style>
.infodose-footer{position:fixed;left:0;right:0;bottom:0;z-index:99999;display:flex;gap:10px;justify-content:center;align-items:center;padding:10px 12px calc(10px + env(safe-area-inset-bottom));backdrop-filter:blur(14px) saturate(140%);background:rgba(0,0,0,.65);border-top:1px solid rgba(255,255,255,.18)}
.infodose-footer .btn{appearance:none;border:1px solid rgba(255,255,255,.18);border-radius:999px;padding:.6rem 1rem;background:rgba(255,255,255,.08);color:#fff;font-weight:800;cursor:pointer}
</style>
<div class="infodose-footer">
  <button class="btn" onclick="(function(){ try{ if(history.length>1) history.back(); else location.href='index.html'; }catch(e){ location.href='index.html'; } })()">‚¨Ö Voltar ao Hub</button>
</div>
<!-- /INFODOSE -->
`.trim();
  navigator.clipboard.writeText(inj).then(()=>alert('Injection copiado!'),()=>alert('Falha ao copiar'));
}

/* ========= Boot ========= */
(function boot(){
  // restaura tema salvo (compat√≠vel com seus hubs)
  const saved = (lsGet('dual.theme')||'theme-nebula');
  document.body.classList.remove('theme-nebula','theme-luxara','theme-ignyra','theme-elysha');
  if(saved) document.body.classList.add(saved);
  // a√ß√µes header/home
})();
</script>

</body></html>